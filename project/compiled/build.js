"use strict";var _setup,_config$setup_name,_setup$_config$setup_,_State$variables,_config$State_name,_State$variables$_con,_navtiles,_State$variables$conf,_State$variables$conf2,_State$variables$conf5,_State$variables$conf6,_State$variables$conf7,_State$variables$conf8,_State$variables$conf11,_State$variables$conf12;function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach((function(e){_defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _createForOfIteratorHelper(t,e){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,l=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return o=t.done,t},e:function(t){l=!0,n=t},f:function(){try{o||null==a.return||a.return()}finally{if(l)throw n}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,i=new Array(e);a<e;a++)i[a]=t[a];return i}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _classPrivateMethodInitSpec(t,e){_checkPrivateRedeclaration(t,e),e.add(t)}function _checkPrivateRedeclaration(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(t,e,a){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return a}var debug={on:{proxy:!1,argObj:!1,macro:!1,collision:!0},log:function(t,e){(t=Array.isArray(t)?t:[t]).filter((function(t){return debug.on[t]})).length&&console.log(e)}},_add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function t(){_classCallCheck(this,t),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];for(var r=0,n=a;r<n.length;r++){var o=n[r];this.add(o)}}catch(t){console.error("failed to create TypeSet object")}}return _createClass(t,[{key:"print",get:function(){if(this.label)return this.label;var e,a=[],i=_createForOfIteratorHelper(this.any);try{for(i.s();!(e=i.n()).done;){var r=e.value;"undefined"===r||"null"===r?a.push("".concat(r)):a.push("any '".concat(r,"'"))}}catch(t){i.e(t)}finally{i.f()}var n,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(n=o.n()).done;){var l=n.value;a.push("exactly the ".concat(t.id(l)," '").concat(l,"'"))}}catch(t){o.e(t)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(e){try{if("array"===t.id(e))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e);else if("object"===t.id(e))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,e);else if("string"==typeof e)_classPrivateMethodGet(this,_push,_push2).call(this,e,"any");else{var a='TypeSet - invalid input "'.concat(e,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(e," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(e){var a=!1;if("object"!==t.id(e)||1!==Object.keys(e).length||"any"!==Object.keys(e)[0]&&"exact"!==Object.keys(e)[0]&&"other"!==Object.keys(e)[0])for(var i=0,r=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));i<r.length;i++){if(e===r[i]){a=!0;break}}else for(var n=0,o=["any","exact","other"];n<o.length;n++){var l,c=o[n],s=Object.values(e)[0],d=_createForOfIteratorHelper(this[c]);try{for(d.s();!(l=d.n()).done;){if(s===l.value){a=!0;break}}}catch(t){d.e(t)}finally{d.f()}if(a=!0)break}return a}},{key:"accepts",value:function(e){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var i,r=_createForOfIteratorHelper(this.any);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(t.id(e)===n){a=!0;break}}}catch(t){r.e(t)}finally{r.f()}}if(!a){var o,l=_createForOfIteratorHelper(this.exact);try{for(l.s();!(o=l.n()).done;){if(e===o.value){a=!0;break}}}catch(t){l.e(t)}finally{l.f()}}return a}}],[{key:"validate",value:function(e){if(!t.valid.includes(e)){var a='TypeSet - "'.concat(e,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(t){return"object"===_typeof(t)&&!!t["this is a TypeSet"]}}]),t}();function _add_arr2(t,e){if(0===t.length){console.error("TypeSet - array input cannot be empty")}var a,i=_createForOfIteratorHelper(t);try{for(i.s();!(a=i.n()).done;){var r=a.value;e?_classPrivateMethodGet(this,_push,_push2).call(this,r,e):this.add(r)}}catch(t){i.e(t)}finally{i.f()}}function _add_obj2(t){for(var e in t)if("any"!==e&&"exact"!==e&&"other"!==e||"array"!==TypeSet.id(t[e]))if("any"===e||"exact"===e||"other"===e)_classPrivateMethodGet(this,_push,_push2).call(this,t[e],e);else if("label"===e){if("string"!==TypeSet.id(t[e])){var a='TypeSet - input for label "'.concat(t[e],"\" ('").concat(TypeSet.id(t[e]),"') should be a string instead");console.error(a)}this.label=t[e]}else{var i="TypeSet - unexpected object key ".concat(e);console.error(i)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t[e],e)}function _push2(t,e){try{if(this[e].includes(t))return;if("any"===e)TypeSet.validate(t),this.any.push(t);else if("exact"===e)this.exact.push(t);else if("any"===t)this.other.push(t);else{var a="TypeSet - unexpected input for ".concat(e,'-type "').concat(t,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(e,"-type to TypeSet at arg ").concat(t)),console.error(a)}}function create_argObj(t){if(void 0===t)throw new Error("".concat(this.name," - failed, missing input (create_argObj)"));var e=t.id,a=t.template,i=t.options,r=clone(t.args_in);if(void 0===e)throw new Error("".concat(this.name," - failed, missing required id (create_argObj)"));if(void 0===a)throw new Error("".concat(e," - failed, missing required template (create_argObj)"));if(void 0===r)throw new Error("".concat(e," - failed, missing required args_in (create_argObj)"));var n=Object.keys(a);if(!n.length)throw new Error("".concat(e," - failed, template can't be empty (create_argObj)"));var o={};try{for(var l=0,c=n;l<c.length;l++){var s=c[l];if(o[s]=s,void 0!==a[s].alias)if("array"===TypeSet.id(a[s].alias)){var d,p=_createForOfIteratorHelper(a[s].alias);try{for(p.s();!(d=p.n()).done;){var h=d.value;if(void 0!==o[h])throw new Error("".concat(e," - failed, clobbering alias ").concat(h," (create_argObj)"));o[h]=s}}catch(t){p.e(t)}finally{p.f()}}else{if(void 0!==o[a[s].alias])throw new Error("".concat(e," - failed, clobbering alias ").concat(a[s].alias," (create_argObj)"));o[a[s].alias]=s}}}catch(t){console.error("".concat(e," - failed to create aliases while parsing macro arguments (create_argObj)")),console.error(t)}var v={},u={id:e,args_in:r,template:a,keys:n,output:v,alias:o,options:i,splice:0};try{for(;u.args_in.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",u),u.splice=0;var y=u.args_in[0];try{0===u.splice&&n.includes(o[y])&&argObj_kvp.call(this,u),0===u.splice&&y.isLink&&argObj_markup.call(this,u),0===u.splice&&"object"===TypeSet.id(y)&&argObj_obj.call(this,u);var m=_objectSpread({strict:!1},i).strict;if(0!==u.splice||m||argObj_lazy.call(this,u),!(u.splice>0))return console.error(v),this.error("".concat(e,' - unexpected input "').concat(y,'", is not a key name and did not match any valid types'));u.args_in.splice(0,u.splice)}catch(t){console.error("".concat(e,' - failed to create argObj at "').concat(y,'" for "').concat(e,'" (create_argObj)')),console.error(t)}}return v}catch(t){console.error("".concat(e," - failed to create argObj from macro arguments (create_argObj)")),console.error(t)}}function argObj_markup(t){debug.log("argObj","entered markup"),debug.log("argObj",t);var e=t.id,a=t.args_in,i=t.keys,r=t.output,n=a[0];try{return i.includes("passage")?(r.linktext=n.text,r.passage=n.link,t.splice=1,t):this.error("".concat(e," - macro does not accept [[markup]]"))}catch(t){console.error("".concat(e," - failed to parse macro arguments inside [[markup]] parser (argObj_markup)")),console.error(t)}}function argObj_kvp(t){debug.log("argObj","entered kvp"),debug.log("argObj",t);var e=t.id,a=t.args_in,i=t.template,r=t.output,n=t.alias,o=a[0],l=a[1];try{if("undefined"===TypeSet.id(l))return this.error("".concat(e,' - no input was found for argument "').concat(o,'"'));var c=new TypeSet(i[n[o]].type);return c.accepts(l)?(r[n[o]]=l,t.splice=2,t):this.error("".concat(e,' - "').concat(l,"\" is an invalid type ('").concat(TypeSet.id(l),"') for \"").concat(o,'", expected ').concat(c.print))}catch(t){console.error("".concat(e," - failed to parse macro arguments inside KVP parser (argObj_kvp)")),console.error(t)}}function argObj_obj(t){debug.log("argObj","entered object parser"),debug.log("argObj",t);var e=t.id,a=t.args_in,i=t.template,r=t.keys,n=t.output,o=t.alias,l=a[0];try{for(var c in l)if(r.includes(o[c])){var s=new TypeSet(i[o[c]].type);if(!s.accepts(l[c]))return this.error("".concat(e,' - "').concat(l[c],'" is an invalid type for "').concat(c,"\" ('").concat(TypeSet.id(l[c]),"'), expected ").concat(s.print));n[o[c]]=l[c],t.splice=1}return t}catch(t){console.error("".concat(e," - failed to parse macro arguments inside object parser (argObj_obj)")),console.error(t)}}function argObj_lazy(t){debug.log("argObj","entered lazy matcher"),debug.log("argObj",t);var e=t.id,a=t.args_in,i=t.template,r=t.keys,n=t.output,o=a[0];try{var l=r.filter((function(t){return!Object.keys(n).includes(t)}));if(!l.length)return t;var c,s=_createForOfIteratorHelper(l);try{for(s.s();!(c=s.n()).done;){var d=c.value;if(new TypeSet(i[d].type).accepts(o)){n[d]=o,t.splice=1;break}}}catch(t){s.e(t)}finally{s.f()}return t}catch(t){console.error("".concat(e," - failed to parse macro arguments inside lazy parser (argObj_lazy)")),console.error(t)}}var config={nav:{},hole:{},floor:{},display:{},entity:{},skipcheck:{}};config.nav.diagonal=!1,config.nav.print_names=!1,config.nav.keyboard_codes={N:"Numpad8",E:"Numpad6",S:"Numpad2",W:"Numpad4",NW:"Numpad7",NE:"Numpad9",SE:"Numpad3",SW:"Numpad1"},config.entity.solid=!0,config.display.print_tiles=!1,config.hole.tileid=".",config.floor.tileid="x",config.skipcheck.clobbering=!1,config.skipcheck.common=!1,config.skipcheck.unused=!1,config.disable_global=!1,config.setup_name="@navmap",config.global_name="Navmap",config.State_name="@navmap",null!==(_setup$_config$setup_=(_setup=setup)[_config$setup_name=config.setup_name])&&void 0!==_setup$_config$setup_||(_setup[_config$setup_name]={}),null!==(_State$variables$_con=(_State$variables=State.variables)[_config$State_name=config.State_name])&&void 0!==_State$variables$_con||(_State$variables[_config$State_name]={});var def=new Proxy(config,get_controller(setup[config.setup_name]));function get_controller(t){return{get:function(e,a){return debug.log("proxy","---- start proxy ----"),debug.log({t:e,p:a}),void 0===t||void 0===t[a]?(debug.log("proxy","entered undefined"),debug.log("proxy","---- end proxy ----"),e[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(t[a])||t[a].isproxy||(debug.log("proxy","created proxy"),t[a]=new Proxy(config[a],get_controller(t[a])),t[a].isproxy=!0),debug.log("proxy","---- end proxy ----"),t[a])}}}var navmaps={},naventities={},navtiles=(_defineProperty(_navtiles={},String(def.hole.tileid),{tileid:String(def.hole.tileid),tilename:def.hole.tileid,tilehtml:{default:def.hole.tileid},vacant:!0}),_defineProperty(_navtiles,String(def.floor.tileid),{tileid:String(def.floor.tileid),tilename:def.floor.tileid,tilehtml:{default:def.floor.tileid},vacant:!1}),_navtiles),navdisplays={},navwalls={};function get_navmap(t){return navmaps[t]}function get_navtile(t){return navtiles[t]}function get_naventity(t){return naventities[t]}function get_navdisplay(t){return navdisplays[t]}function get_navwall(t){return navwalls[t]}setup.navmaps=navmaps,setup.navtiles=navtiles,setup.naventities=naventities,setup.navdisplays=navdisplays,setup.navwalls=navwalls,null!==(_State$variables$conf2=(_State$variables$conf=State.variables[config.State_name]).navmaps)&&void 0!==_State$variables$conf2||(_State$variables$conf.navmaps={});var Navmap=function(){function t(e,a,i,r,n,o,l){var c,s,d;if(_classCallCheck(this,t),this.error=function(t){throw new Error(t)},!def.skipcheck.clobbering&&navmaps[e])return this.error('Navmap - clobbering, map with id "'.concat(e,'" already exists'));navmaps[String(e)]=this,this.mapid=String(e),null!==(d=(c=State.variables[config.State_name].navmaps)[s=this.mapid])&&void 0!==d||(c[s]={}),this.mapname=null!=a?a:this.mapid,this.diagonal=null!=o?o:def.nav.diagonal,this.maphtml=null!=l?l:{},this.cells=[],this.vertices=[];try{if(void 0===this.arr||void 0===this.cols||void 0===this.rows){if("array"===i){if(this.arr=r,this.cols=n,void 0===n)return this.error('Navmap - missing required input "cols" or "columns" for map "'.concat(this.mapid,'"'));if("array"===i&&this.arr%this.cols)return console.error(r),this.error("Navmap - inputmap is not rectangular")}else{if("2D array"!==i)return this.error('Navmap - invalid inputtype for map "'.concat(this.mapid,"\", only macro payload or 'array' or '2D array' is supported"));this.cols=r[0].length;var p,h=_createForOfIteratorHelper(r);try{for(h.s();!(p=h.n()).done;){var v=p.value;if(!Array.isarray(v))return console.error(v),this.error('Navmap - invalid inputmap, non-array detected for map "'.concat(this.mapid,'"'));if(0===(null==v?void 0:v.length)||(null==v?void 0:v.length)!==this.cols)return console.error(v),this.error('Navmap - invalid inputmap, non-rectangular input detected for map "'.concat(this.mapid,'"'))}}catch(t){h.e(t)}finally{h.f()}this.arr=r.flat()}this.rows=this.arr.length/this.cols}}catch(t){return console.error('Navmap - failed to parse input for inputtype "'.concat(i,'" and inputmap (Navmap)')),console.error(r),this.error(t)}try{var u,y=_createForOfIteratorHelper(new Set(this.arr));try{for(y.s();!(u=y.n()).done;){var m=u.value;void 0===get_navtile(m)&&new Navtile(m)}}catch(t){y.e(t)}finally{y.f()}}catch(t){console.error('Navmap - failed to create default Navtiles for map "'.concat(this.mapid,'"')),console.error(t)}}return _createClass(t,[{key:"arr",get:function(){return State.variables[config.State_name].navmaps[this.mapid].arr},set:function(t){State.variables[config.State_name].navmaps[this.mapid].arr=t}}]),t}();null!==(_State$variables$conf6=(_State$variables$conf5=State.variables[config.State_name]).navtiles)&&void 0!==_State$variables$conf6||(_State$variables$conf5.navtiles={});var Navtile=_createClass((function t(e,a,i,r,n){var o,l;if(_classCallCheck(this,t),this.error=function(t){throw new Error(t)},!def.skipcheck.clobbering&&navtiles[e])return this.error('Navtile - clobbering, tile with id "'.concat(e,'" already exists'));if(navtiles[String(e)]=this,this.tileid=String(e),this.tilename=null!=a?a:e,this.vacant=null!=r&&r,void 0!==n)for(var c in this.walls={},dirs_8){var s;this.walls[c]=null!==(s=n[c])&&void 0!==s&&s}else this.walls=this.vacant?{N:!0,E:!0,S:!0,W:!0,NW:!0,NE:!0,SE:!0,SW:!0}:{N:!1,E:!1,S:!1,W:!1,NW:!1,NE:!1,SE:!1,SW:!1};for(var d in this.tilehtml={},i){if(!def.skipcheck.unused&&void 0===i[d])return this.error("".concat(this.name,' - empty display html for tileid "').concat(e,'" on displayid "').concat(d,'"'));this.tilehtml[d]=i[d]}null!==(l=(o=this.tilehtml).default)&&void 0!==l||(o.default=e)}));null!==(_State$variables$conf8=(_State$variables$conf7=State.variables[config.State_name]).naventities)&&void 0!==_State$variables$conf8||(_State$variables$conf7.naventities={});var Naventity=function(){function t(e,a,i,r){var n,o,l,c,s,d;if(_classCallCheck(this,t),this.error=function(t){throw new Error(t)},!def.skipcheck.clobbering&&naventities[e])return this.error('Naventity - clobbering, entity with id "'.concat(e,'" already exists'));for(var p in naventities[String(e)]=this,this.entityid=String(e),null!==(l=(n=State.variables[config.State_name].naventities)[o=this.entityid])&&void 0!==l||(n[o]={}),this.entityname=null!=a?a:e,this.solid=null!=r?r:def.entity.solid,null!==(c=this.points)&&void 0!==c||(this.points={}),this.entityhtml={},i){if(!def.skipcheck.unused&&void 0===i[p])return this.error("".concat(this.name,' - empty display html for entityid "').concat(e,'" on displayid "').concat(p,'"'));this.entityhtml[p]=i[p]}null!==(d=(s=this.entityhtml).default)&&void 0!==d||(s.default=e)}return _createClass(t,[{key:"points",get:function(){return State.variables[config.State_name].naventities[this.entityid].points},set:function(t){State.variables[config.State_name].naventities[this.entityid].points=t}}]),t}();null!==(_State$variables$conf12=(_State$variables$conf11=State.variables[config.State_name]).navwalls)&&void 0!==_State$variables$conf12||(_State$variables$conf11.navwalls={});var Navwall=function(){function t(e,a,i){var r,n,o,l;if(_classCallCheck(this,t),this.error=function(t){throw new Error(t)},!def.skipcheck.clobbering&&navwalls[e])return this.error('Naventity - clobbering, entity with id "'.concat(entityid,'" already exists'));navwalls[String(e)]=this,this.wallid=String(e),null!==(o=(r=State.variables[config.State_name].navwalls)[n=this.wallid])&&void 0!==o||(r[n]={}),this.wallhtml=i,null!==(l=this.points)&&void 0!==l||(this.points={})}return _createClass(t,[{key:"points",get:function(){return State.variables[config.State_name].navwalls[this.wallid].points},set:function(t){State.variables[config.State_name].navwalls[this.wallid].points=t}}]),t}();function check_required(t,e){if(void 0===t)return this.error("".concat(this.name," - failed, missing argObj_in (check_required)"));if(Object.keys(t).length>1)return this.error("".concat(this.name," - failed extra properties in argObj_in (check_required)"));try{var a,i=Object.keys(t)[0];if(void 0===t[i])return this.error("".concat(this.name,' - missing required argument "').concat(null!==(a=null==e?void 0:e.label)&&void 0!==a?a:i,'"'))}catch(t){console.error("".concat(this.name," - failed to check for required args")),console.error(t)}}function check_oneword(t,e){if(void 0===t)return this.error("".concat(this.name," - failed, missing argObj_in (check_oneword)"));if(Object.keys(t).length>1)return this.error("".concat(this.name," - failed extra properties in argObj_in (check_oneword)"));try{var a,i=Object.keys(t)[0];if(t[i].includes(" "))return this.error("".concat(this.name,' - argument "').concat(null!==(a=null==e?void 0:e.label)&&void 0!==a?a:i,'" must be one word, no spaces'))}catch(t){console.error("".concat(this.name," - failed to check args for oneword requirement")),console.error(t)}}function check_extant(t,e){if(void 0===t)return this.error("".concat(this.name," - failed, missing argObj_in (check_extant)"));if(Object.keys(t).length>1)return this.error("".concat(this.name," - failed extra properties in argObj_in (check_extant)"));try{var a=Object.keys(t)[0],i=t[a];if("mapid"===a&&void 0===get_navmap(i))return this.error("".concat(this.name,' - no map with id "').concat(i,'" found'));if("tileid"===a&&void 0===get_navtile(i))return this.error("".concat(this.name,' - no tile with id "').concat(i,'" found'));if("entityid"===a&&void 0===get_naventity(i))return this.error("".concat(this.name,' - no entity with id "').concat(i,'" found'));if("displayid"===a&&void 0===get_navdisplay(i)){if(void 0===get_navmap(i))return this.error("".concat(this.name,' - no display with id "').concat(i,'" found'));new_navdisplay.call(this,{mapid:displayid})}}catch(t){console.error("".concat(this.name," - failed to check args for extant requirement")),console.error(t)}}function print_navtile(t){var e=t.displayid,a=t.tile,i=t.row,r=t.col,n=a.tileid,o=a.tilename,l=a.vacant,c=a.tilehtml;try{var s=$(document.createElement("div")),d=void 0===c?n:void 0!==c[e]?c[e]:void 0!==c.default?c.default:n;return s.addClass("Navtile").attr("title",o).attr("data-tileid",n).data("tileid",n).attr("data-vacant",l).data("vacant",l).css({"grid-column":"".concat(r," / span 1"),"grid-row":"".concat(i," / span 1")}).wiki(d),s}catch(t){console.error("".concat(this.name,' - failed to print navtile element on navdisplay "').concat(e,'"')),console.error(t)}}function print_naventity(t){var e=t.displayid,a=t.entity,i=t.col,r=t.row,n=a.entityid,o=a.entityname,l=a.entityhtml;try{var c=$(document.createElement("div")),s=void 0===l?n:void 0!==l[e]?l[e]:void 0!==l.default?l.default:n;return c.addClass("Naventity").attr("title",o).attr("data-entityid",n).data("entityid",n).css({"grid-column":"".concat(i," / span 1"),"grid-row":"".concat(r," / span 1")}).wiki(s),c}catch(t){console.error("".concat(this.name,' - failed to create entity element for "').concat(n,'" on "').concat(mapid,'"')),console.error(t)}}function print_navdir(t){var e=t.displayid,a=t.mapid,i=t.dir,r=t.entity,n=t.print_names,o=get_navmap(a),l=o.arr,c=o.rows,s=o.cols,d=o.cells,p=i.dirid,h=i.dirname,v=i.delta,u=i.dirhtml,y=$(document.createElement("div"));try{if(y.addClass("Navdir").attr("data-dirid",p).data("dirid",p).attr("data-mapid",a).data("mapid",a).attr("data-displayid",e).data("dsplayid",e),void 0===r.points[a])return y;var m=r.points[a].x+v.x,f=r.points[a].y+v.y,g=convert_xy2i({x:m,y:f},a);if(g>=0&&f>=1&&f<=c&&m>=1&&m<=s){var _=get_navtile(l[g]),b=_.tileid,w=_.tilename,k=d[m][f].blocked,x="C"===p?null!=w?w:b:k?"":n?null!=w?w:b:u;y.attr("data-disabled",k).data("disabled",k).attr("data-tileid",b).data("tileid",b).wiki(x)}else y.attr("data-disabled",!0).data("disabled",!0).attr("data-tileid",null).data("tileid",null);return y}catch(t){console.error("".concat(this.name,' - failed to create nav direction "').concat(h,'" for map "').concat(a,'"')),console.error(t)}}function convert_i2xy(t,e){var a=get_navmap(e),i=a.arr,r=a.cols;if(t<0||t>i.length)return{};var n=t%r+1;return{x:n,y:(t-n+1)/r+1}}function convert_xy2i(t,e){var a=get_navmap(e),i=a.rows,r=a.cols,n=t.x,o=t.y;return n<1||n>r||o<1||o>i?-1:(o-1)*r+n-1}config.disable_global||Object.defineProperty(window,config.global_name,{value:Navmap});var dirs_0={C:{dirid:"C",dirname:"center",dirhtml:"",delta:{x:0,y:0}}},dirs_4={N:{dirid:"N",dirname:"north",dirhtml:"🢁",delta:{x:0,y:-1}},E:{dirid:"E",dirname:"east",dirhtml:"🢂",delta:{x:1,y:0}},S:{dirid:"S",dirname:"south",dirhtml:"🢃",delta:{x:0,y:1}},W:{dirid:"W",dirname:"west",dirhtml:"🢀",delta:{x:-1,y:0}}},dirs_8=_objectSpread(_objectSpread({},dirs_4),{},{NW:{dirid:"NW",dirname:"northwest",dirhtml:"🢄",delta:{x:-1,y:-1}},NE:{dirid:"NE",dirname:"northeast",dirhtml:"🢅",delta:{x:1,y:-1}},SE:{dirid:"SE",dirname:"southeast",dirhtml:"🢆",delta:{x:1,y:1}},SW:{dirid:"SW",dirname:"southwest",dirhtml:"🢇",delta:{x:-1,y:1}}});function compare_segments(t,e,a,i){debug.log("collision",{A:t,B:e,C:a,D:i});var r={};if(t.x===a.x&&t.y===a.y||t.x===i.x&&t.y===i.y||e.x===a.x&&e.y===a.y||e.x===i.x&&e.y===i.y)return debug.log("collision","end point shared"),r.touch=!0,r.intersect=!1,r;var n=[t.x,e.x].sort((function(t,e){return t-e})),o=[a.x,i.x].sort((function(t,e){return t-e}));if(o[1]<n[0]||n[1]<o[0]||n[1]<o[0]||o[1]<n[0])return debug.log("collision","ranged out - x"),r.touch=!1,r.intersect=!1,r;var l=[t.y,e.y].sort((function(t,e){return t-e})),c=[a.y,i.y].sort((function(t,e){return t-e}));if(c[1]<l[0]||l[1]<c[0]||l[1]<c[0]||c[1]<l[0])return debug.log("collision","ranged out - y"),r.touch=!1,r.intersect=!1,r;var s=(e.y-t.y)/(e.x-t.x),d=(i.y-a.y)/(i.x-a.x);if(Math.abs(s)!==1/0&&Math.abs(d)!==1/0){debug.log("collision","no vertical lines");var p=t.y-s*t.x,h=a.y-d*a.x;if(s===d&&p===h)return debug.log("collision","collinear"),r.touch=!1,r.intersect=!0,r;if(s===d)return debug.log("collision","parallel"),r.touch=!1,r.intersect=!1,r;debug.log("collision","everything else");var v={};return v.x=(h-p)/(s-d),r.touch=v.x===t.x||v.x===e.x?o[0]<=v.x&&v.x<=o[1]:(v.x===a.x||v.x===i.x)&&(n[0]<=v.x&&v.x<=n[1]),r.intersect=n[0]<=v.x&&v.x<=n[1]&&o[0]<=v.x&&v.x<=o[1],debug.log("collision",{I:v}),r}if(debug.log("collision","vertical lines"),Math.abs(s)===Math.abs(d)&&t.x===a.x)return debug.log("collision","collinear"),r.touch=!1,r.intersect=!0,r;if(Math.abs(s)===Math.abs(d))return debug.log("collision","parallel"),r.touch=!1,r.intersect=!1,r;var u={};return Math.abs(s)===1/0?(debug.log("collision","AB is vertical"),u.x=t.x,u.y=d*(u.x-a.x)+a.y,r.touch=u.y===t.y||u.y===e.y?o[0]<=u.x&&u.x<=o[1]:(u.x===a.x||u.x===i.x)&&(l[0]<=u.y&&u.y<=l[1])):(debug.log("collision","CD is vertical"),u.x=a.x,u.y=s*(u.x-t.x)+t.y,r.touch=u.y===a.y||u.y===i.y?n[0]<=u.x&&u.x<=n[1]:(u.x===t.x||u.x===e.x)&&(c[0]<=u.y&&u.y<=c[1])),r.intersect=l[0]<=u.y&&u.y<=l[1]&&c[0]<=u.y&&u.y<=c[1],debug.log("collision",{I:u}),r}function calculate_cells(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"calculate_cells"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.mapid;check_required.call(this,{mapid:r});var n=get_navmap(r),o=n.arr,l=(n.rows,n.cols,n.cells);n.vertices;try{for(var c=0;c<o.length;c++){var s,d,p,h=get_navtile(o[c]),v=convert_i2xy(c,r),u=v.x,y=v.y;null!==(s=l[u])&&void 0!==s||(l[u]=[]),null!==(p=(d=l[u])[y])&&void 0!==p||(d[y]={}),l[u][y].blocked=h.vacant}}catch(t){console.error("".concat(this.name,' - failed to calculate tiles -> cells for map "').concat(r,'" (calculate_cells)')),console.error(t)}try{for(var m in naventities){var f=naventities[m];if(f.solid&&void 0!==f.points[r]){var g=f.points[r],_=g.x,b=g.y;l[_][b].blocked||(l[_][b].blocked=!0)}}}catch(t){console.error("".concat(this.name,' - failed to calculate entities -> cells for map "').concat(r,'" (calculate_cells)')),console.error(t)}}function new_navmap(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"new_navmap"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=_objectSpread({diagonal:def.nav.diagonal},t),n=r.source,o=r.mapid,l=r.mapname,c=r.diagonal,s=r.inputtype,d=r.inputmap,p=r.maphtml;if(check_required.call(this,{mapid:o}),!d)return this.error("".concat(this.name,"macro"===n?" - missing required macro payload":' - missing required input "inputmap"'));var h=t.cols;if(!Number.isInteger(h)||h<1)return this.error("".concat(this.name," - # of columns must be an integer greater than zero"));def.skipcheck.common||check_oneword.call(this,{mapid:o});try{new Navmap(o,l,s,d,h,c,p)}catch(t){return console.error("".concat(this.name,' - failed to create Navmap object for map "').concat(o,'" (new_navmap)')),this.error(t)}}function new_navtile(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"new_navtile"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.tileid,n=t.tilename,o=t.tilehtml,l=t.vacant;check_required.call(this,{tileid:r}),check_required.call(this,{vacant:l});try{var c=get_navtile(r);if(void 0!==c)for(var s in c.vacant=l,n&&(c.tilename=n),o){var d,p;c.tilehtml[s]=o[s],null!==(p=(d=c.tilehtml).default)&&void 0!==p||(d.default=r)}else new Navtile(r,n,o,l)}catch(t){return console.error("".concat(this.name,' - failed to create new tile definition for "').concat(r,'" (new_navtile)')),this.error(t)}}function new_navdisplay(t){var e,a,i,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"new_navdisplay"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var n=t.mapid,o=t.rows_view,l=t.cols_view,c=t.x0,s=t.y0,d=t.entityid_view,p=null!==(r=t.displayid)&&void 0!==r?r:n;if(check_required.call(this,{mapid:n}),!def.skipcheck.clobbering&&get_navdisplay(n,p))return this.error("".concat(this.name,' - display with id "').concat(p,'" already exists for map "').concat(n,'"'));if(check_extant.call(this,{mapid:n}),l&&(!Number.isInteger(l)||l<1))return this.error("".concat(this.name," - # of columns must be an integer greater than zero"));if(o&&(!Number.isInteger(o)||o<1))return this.error("".concat(this.name," - # of rows must be an integer greater than zero"));if(d&&(check_extant.call(this,{entityid:d},{label:"id of entity to track"}),check_oneword.call(this,{entityid:d},{label:"id of entity to track"}),"undefind"==typeof get_naventity(d).points[n]))return this.error("".concat(this.name,' - no coordinates set for entity "').concat(d,'" on map "').concat(n,'"'));def.skipcheck.common||check_oneword.call(this,{displayid:p});var h=get_navmap(n),v=h.cols,u=h.rows;try{var y,m,f,g,_,b,w=Math.clamp(1,v,null!==(y=null!=l?l:o)&&void 0!==y?y:v),k=Math.clamp(1,u,null!==(m=null!=o?o:l)&&void 0!==m?m:u);if(void 0!==d){var x=get_naventity(d).points[n],S=x.x,j=x.y;_=Math.clamp(1,v-l+1,S-Math.floor(l/2)),b=Math.clamp(1,u-o+1,j-Math.floor(o/2))}void 0!==c&&(_=Math.clamp(1,v-l+1,c)),void 0!==s&&(b=Math.clamp(1,u-o+1,s)),navdisplays[p]={displayid:p,mapid:n,entityid_view:d,cols_view:w,rows_view:k,x0:null!==(f=_)&&void 0!==f?f:1,y0:null!==(g=b)&&void 0!==g?g:1}}catch(t){console.error("".concat(this.name," - failed to initialize navdisplay with validated values (new_navdisplay)")),console.error(t)}}function print_navdisplay(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"print_navdisplay"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=_objectSpread({print_tiles:def.display.print_tiles},t),n=r.displayid,o=r.print_tiles;check_required.call(this,{displayid:n}),check_extant.call(this,{displayid:n});var l=get_navdisplay(n);if(0!==$('.Navdisplay[data-display="'.concat(n,'"]')).length)return this.error("".concat(this.name,' - display with id "').concat(n,'" already printed, cannot print the same display twice'));var c=$(document.createElement("div"));try{var s=l.mapid,d=l.entityid_view;l.x0,l.y0,l.cols_view,l.rows_view;c.addClass("Navdisplay").attr("data-mapid",s).data("mapid",s).attr("data-displayid",n).data("displayid",n).attr("data-entityid_view",d).data("entityid_view",d)}catch(t){console.error("".concat(this.name," - failed to intialize $display jQuery object (print_navdisplay)")),console.error(t)}update_navdisplay.call(this,{$display:c,print_tiles:o});try{setTimeout((function(){c.on(":update_navdisplay",(function(t,e){$(this).children().remove(),update_navdisplay.call(this,{$display:c,print_tiles:o,delta:e})}))}),40)}catch(t){console.error("".concat(this.name," - failed to assign navdisplay listeners (print_navdisplay)")),console.error(t)}return c}function update_navdisplay(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"update_navdisplay"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.$display,n=t.print_tiles,o=t.delta;if(check_required.call(this,{$display:r},{label:"jQuery object holding display to update"}),!def.skipcheck.common&&0===r.length)return this.error("".concat(this.name," - empty jQuery object, no navdisplay supplied"));var l=r.data("displayid"),c=get_navdisplay(l),s=c.mapid,d=get_navmap(s),p=d.arr,h=d.rows,v=d.cols,u=d.maphtml;calculate_cells.call(this,{mapid:s}),calculate_navdisplay.call(this,{displayid:l,delta:o});var y=c.x0,m=c.y0,f=c.cols_view,g=c.rows_view;r.css({"grid-template-columns":"repeat(".concat(f,", 1fr)"),"grid-template-rows":"repeat(".concat(g,", 1fr)")});var _=[];try{for(var b=convert_xy2i({x:y,y:m},s),w=1;w<=g;w++)for(var k=1;k<=f;k++){var x=b+(k-1)+v*(w-1),S=p[x];if(n){var j=print_navtile.call(this,{displayid:l,tile:get_navtile(S),col:k,row:w});j.appendTo(r);var O=convert_i2xy(x,s),N=O.x,E=O.y;j.attr("data-x",N).data("x",N).attr("data-y",E).data("y",E)}_.push(x)}}catch(t){console.error("".concat(this.name,' - failed to print tiles for map display "').concat(l,'" (refresh_navdisplay)')),console.error(t)}try{for(var T in naventities){var M=naventities[T];if(void 0!==M.points[s]){var q=M.points[s],C=q.x,I=q.y,P=convert_xy2i({x:C,y:I},s);if(_.includes(P))print_naventity.call(this,{displayid:l,entity:M,col:C-y+1,row:I-m+1}).appendTo(r)}}}catch(t){console.error("".concat(this.name,' - failed to print entities for map display "').concat(l,'" (refresh_navdisplay)')),console.error(t)}try{for(var A in navwalls){var W,z=navwalls[A],H=z.wallname;if(void 0!==z.points[s]){var F=null!==(W=z.wallhtml[l])&&void 0!==W?W:z.wallhtml.default;if(void 0!==F){var D=z.points[s],G=D.sort((function(t,e){return t.x-e.x}))[0].x,L=D.sort((function(t,e){return e.x-t.x}))[0].x,Q=D.sort((function(t,e){return t.y-e.y}))[0].y,K=D.sort((function(t,e){return e.y-t.y}))[0].y,U=$(document.createElement("div"));U.wiki(F).addClass("Navwall").attr("title",H).attr("data-wallid",A).data("wallid",A).css({width:"max(".concat((L-G)/f*100,"%, ").concat(100/f*.2,"%)"),height:"max(".concat((K-Q)/g*100,"%, ").concat(100/g*.2,"%)"),left:(G-(y-1))/f*100+"%",top:(Q-(m-1))/g*100+"%"}),U.appendTo(r)}}}}catch(t){console.error("".concat(this.name,' - failed to print walls for map display "').concat(l,'"')),console.error(t)}try{var B,R=null!==(B=u[l])&&void 0!==B?B:u.default;if(void 0!==R){var V=$(document.createElement("div")).wiki(R);V.addClass("Navbg"),V.css({width:v/f*100+"%",height:h/g*100+"%",left:(1-y)/f*100+"%",top:(1-m)/g*100+"%"}),V.appendTo(r)}}catch(t){console.error("".concat(this.name,' - failed to attach background image for map display "').concat(l,'"')),console.error(t)}}function calculate_navdisplay(t){var e=t.displayid,a=t.delta,i=get_navdisplay(e),r=i.mapid,n=(i.entityid_view,get_navmap(r)),o=n.rows,l=n.cols,c=i.x0,s=i.y0,d=i.cols_view,p=i.rows_view;try{var h,v,u,y,m=Math.clamp(1,l,d+(null!==(h=null==a?void 0:a.cols)&&void 0!==h?h:0)),f=Math.clamp(1,o,p+(null!==(v=null==a?void 0:a.rows)&&void 0!==v?v:0)),g=Math.clamp(1,l-m+1,c+Math.floor((d-m)/2)+(null!==(u=null==a?void 0:a.x)&&void 0!==u?u:0)),_=Math.clamp(1,o-f+1,s+Math.floor((p-f)/2)+(null!==(y=null==a?void 0:a.y)&&void 0!==y?y:0));Object.assign(i,{x0:g,y0:_,cols_view:m,rows_view:f})}catch(t){console.error("".concat(this.name,' - failed to calculate new values for display "').concat(e,'" (calculate_navdisplay)')),console.error(t)}}function new_naventity(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"new_naventity"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.entityid,n=t.entityname,o=t.entityhtml,l=t.solid;check_required.call(this,{entityid:r}),check_required.call(this,{solid:l});try{var c=get_naventity(r);if(void 0!==c){if(c.solid=l,void 0!==n&&(c.entityname=n),void 0!==o)for(var s in o)c.entityhtml[s]=o[s]}else new Naventity(r,n,o,l)}catch(t){return console.error("".concat(this.name,' - failed to create new entity definition for "').concat(r,'" (new_naventity)')),this.error(t)}}function set_naventity(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"set_naventity"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.entityid,n=t.mapid,o=t.cell;if(check_required.call(this,{entityid:r}),check_required.call(this,{mapid:n}),check_extant.call(this,{entityid:r}),check_extant.call(this,{mapid:n}),void 0!==o&&2!==o.length)return this.error("".concat(this.name,' - cell input for entity "').concat(r,'" on map "').concat(n,'" must be an array formatted [x,y]'));var l=get_navmap(n),c=l.rows,s=l.cols,d=void 0!==t.x?t.x:void 0!==o?o[0]:void 0,p=void 0!==t.y?t.y:void 0!==o?o[1]:void 0;if(!(void 0===d&&void 0===p||void 0!==d&&void 0!==p))return this.error("".concat(this.name,' - both x and y are required to define a point for entity "').concat(r,'" on map "').concat(n,'"'));if(!Number.isInteger(d)||!Number.isInteger(p))return this.error("".concat(this.name,' - both x and y must be integers for entity "').concat(r,'" on map "').concat(n,'"'));if(!def.skipcheck.common){if(d<1||s<d)return this.error("".concat(this.name,' - x for entity "').concat(r,'" is outside horizontal map cell boundaries [1 to ').concat(s,'] inclusive, for map "').concat(n,'"'));if(p<1||c<p)return this.error("".concat(this.name,' - y for entity "').concat(r,'" is outside vertical map cell boundaries [1 to ').concat(c,'] inclusive, for map "').concat(n,'"'))}try{get_naventity(r).points[n]={x:d,y:p}}catch(t){return console.error("".concat(this.name,' - failed to set entity "').concat(r,'" on map "').concat(n,'" (set_naventity)')),this.error(t)}try{$('.Navdisplay[data-mapid="'.concat(n,'"]')).trigger(":update_navdisplay"),$('.Navrose[data-mapid="'.concat(n,'"]')).trigger(":update_navrose")}catch(t){console.error("".concat(this.name,' - failed to update navdisplays while setting entity "').concat(r,'" on map "').concat(n,'" (set_naventity)')),console.error(t)}}function rem_naventity(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"rem_naventity"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.entityid,n=t.mapid;check_required.call(this,{entityid:r}),check_required.call(this,{mapid:n}),def.skipcheck.common||(check_extant.call(this,{entityid:r}),check_extant.call(this,{mapid:n}));try{delete get_naventity(r).points[n]}catch(t){console.error("".concat(this.name,' - failed to remove naventity "').concat(r,'" from map "').concat(n,'" (rem_naventity)')),console.error(t)}try{$('.Navdisplay[data-mapid="'.concat(n,'"]')).trigger(":update_navdisplay"),$('.Navrose[data-mapid="'.concat(n,'"]')).trigger(":update_navrose")}catch(t){console.error("".concat(this.name,' - failed to update navdisplays while removing entity "').concat(r,'" on map "').concat(n,'" (rem_naventity)')),console.error(t)}}function mov_naventity(t){var e,a,i,r,n;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"mov_naventity"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var o=_objectSpread({trigger_update:!0,ignore_walls:!1,delta:{}},t),l=o.entityid,c=o.mapid,s=o.delta,d=o.deltax,p=o.deltay,h=o.ignore_walls,v=o.trigger_update;check_required.call(this,{entityid:l}),check_required.call(this,{mapid:c}),void 0!==d&&(s.x=d),void 0!==p&&(s.y=p),check_extant.call(this,{entityid:l}),check_extant.call(this,{mapid:c});var u=get_navmap(c),y=u.rows,m=u.cols,f=u.cells,g=get_naventity(l),_=g.points[c].x,b=g.points[c].y,w=_+(null!==(r=null==s?void 0:s.x)&&void 0!==r?r:0),k=b+(null!==(n=null==s?void 0:s.y)&&void 0!==n?n:0);debug.log("collision",'---- start check for entity "'.concat(l,'" ----')),debug.log("collision",{x_old:_,y_old:b,x_new:w,y_new:k});var x=!1,S=!0;try{debug.log("collision","checking map boundaries"),(w<1||k<1||w>m||k>y)&&(S=!1,h||(x=!0)),debug.log("collision",{collided:x})}catch(t){console.error("".concat(this.name," - failed to calculate collisions against map boundaries")),console.error(t)}try{debug.log("collision","checking blocked"),S&&!h&&f[w][k].blocked&&(x=!0),debug.log("collision",{collided:x})}catch(t){console.error("".concat(this.name," - failed to calculate collisions against map tiles and entities")),console.error(t)}var j={x:_-.5,y:b-.5},O={x:w-.5,y:k-.5};for(var N in navwalls){debug.log("collision",'checking wall "'.concat(N,'"'));var E=navwalls[N];if(void 0!==E.points[c]){var T=E.points[c];try{for(var M=0;M<T.length-1;M++){debug.log("collision",'checking wall "'.concat(N,'", points ').concat(M," to ").concat(M+1));var q=compare_segments(j,O,{x:T[M].x,y:T[M].y},{x:T[M+1].x,y:T[M+1].y});if(debug.log("collision",q),q.intersect&&(x=!0),debug.log("collision",{collided:x}),x)break}if(debug.log("collision",{collided:x}),x)break}catch(t){console.error("".concat(this.name,' - failed to calculate collisions for entity "').concat(l,'" against wall "').concat(N,'" on map "').concat(c,'" (mov_naventity)')),console.error(t)}}}try{debug.log("collision","finished checking"),debug.log("collision",{collided:x}),x?(debug.log("collision",'blocked entity "'.concat(l,'" on map "').concat(c,'"!')),debug.log("collision",'---- end check for entity "'.concat(l,'" ----'))):(debug.log("collision",'moved entity "'.concat(l,'" on map "').concat(c,'"!')),g.points[c].x=w,g.points[c].y=k,debug.log("collision",'---- end check for entity "'.concat(l,'" ----')))}catch(t){return console.error("".concat(this.name,' - failed to move entity "').concat(l,'" on map "').concat(c,'" (mov_naventity)')),this.error(t)}try{v&&($('.Navdisplay[data-mapid="'.concat(c,'"]')).trigger(":update_navdisplay"),$('.Navrose[data-mapid="'.concat(c,'"]')).trigger(":update_navrose"))}catch(t){console.error("".concat(this.name,' - failed to trigger updates while moving entity "').concat(l,'" on map "').concat(c,'" (mov_naventity)')),console.error(t)}}function new_navwall(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"new_navwall"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.wallid,n=t.wallname,o=t.wallhtml;check_required.call(this,{wallid:r});try{var l=get_navwall(r);if(void 0!==l){if(void 0!==n&&(l.wallname=n),void 0!==o)for(var c in o)l.wallhtml[c]=o[c]}else new Navwall(r,n,o)}catch(t){console.error("".concat(this.name,' - failed to create new navwall "').concat(r,'" (new_navwall)')),console.error(t)}}function set_navwall(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"set_navwall"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=_objectSpread({vertices:[]},t),n=r.wallid,o=r.mapid,l=r.vertices,c=r.x1,s=r.y1,d=r.x2,p=r.y2;check_required.call(this,{wallid:n}),check_required.call(this,{mapid:o});try{if(!(void 0===c&&void 0===s||void 0!==c&&void 0!==s))return this.error("".concat(this.name," - both x1 and y1 are required to define a point"));if(!(void 0===d&&void 0===p||void 0!==d&&void 0!==p))return this.error("".concat(this.name," - both x2 and y2 are required to define a point"));if(void 0!==d&&l.unshift({x:d,y:p}),void 0!==c&&l.unshift({x:c,y:s}),l.length<2)return this.error("".concat(this.name," - at least two points are required to set a navwall"));var h,v=get_navwall(n),u=get_navmap(o),y=u.rows,m=u.cols,f=_createForOfIteratorHelper(l);try{for(f.s();!(h=f.n()).done;){var g=h.value,_=g.x,b=g.y;if(!Number.isInteger(_))return this.error("".concat(this.name,' - encountered non-integer x "').concat(_,'" for point "{x: ').concat(_,", y: ").concat(b,'}" on wallid "').concat(n,'" for map "').concat(o,'"'));if(!Number.isInteger(b))return this.error("".concat(this.name,' - encountered non-integer y "').concat(b,'" for point "{x: ').concat(_,", y: ").concat(b,'}" on wallid "').concat(n,'" for map "').concat(o,'"'));if(!def.skipcheck.common){if(_<0||m<_)return this.error("".concat(this.name,' - x for point "[').concat(_,",").concat(b,']" on wallid "').concat(n,'" is outside horizontal map vertex boundaries [0 to ').concat(m,'] inclusive, for map "').concat(o,'"'));if(b<0||y<b)return this.error("".concat(this.name,' - y for point "[').concat(_,",").concat(b,']" on wallid "').concat(n,'" is outside vertical map vertex boundaries [0 to ').concat(y,'] inclusive, for map "').concat(o,'"'))}}}catch(t){f.e(t)}finally{f.f()}v.points[o]=l}catch(t){console.error("".concat(this.name,' - failed to add navwall "').concat(n,'" to map "').concat(o,'" (new_navwall)')),console.error(t)}}function print_navrose(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"print_navrose"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=_objectSpread({print_names:def.nav.print_names,keyboard_codes:def.nav.keyboard_codes},t),n=r.displayid,o=r.entityid,l=r.print_names,c=r.keyboard_codes;check_required.call(this,{displayid:n}),check_required.call(this,{entityid:o}),check_extant.call(this,{entityid:o}),check_extant.call(this,{displayid:n});var s=get_navdisplay(n),d=s.mapid;s.cols_view,s.rows_view,s.x0,s.y0,get_naventity(o);def.skipcheck.common;var p=get_navmap(d).diagonal,h=$(document.createElement("div")),v=crypto.randomUUID();try{h.addClass("Navrose").attr("data-mapid",d).data("mapid",d).attr("data-displayid",n).data("displayid",n).attr("data-print_names",l).data("print_names",l).attr("data-entityid",o).data("entityid",o).attr("data-navsn",v).data("navsn",v)}catch(t){console.error("".concat(this.name,' - failed to initialize nav rose for display "').concat(n,'" (print_navrose)')),console.error(t)}update_navrose.call(this,{$rose:h});try{setTimeout((function(){h.on(":update_navrose",(function(t){$(this).children().remove(),update_navrose.call(this,{$rose:h})})),h.on("click",(function(t){click_navrose.call(this,{displayid:n,mapid:d,entityid:o,ev:t})}))}),40)}catch(t){console.error("".concat(this.name,' - failed to assign navrose listeners for navrose with displayid "').concat(n,'" (print_navrose)')),console.error(t)}try{var u=p?dirs_8:dirs_4;setTimeout((function(){$(document).on("keydown.".concat(v),(function(t){if(0===$('[data-navsn="'.concat(v,'"]')).length)$(document).off("keydown.".concat(v));else for(var e in u)t.code===c[e]&&$('[data-navsn="'.concat(v,'"] .Navdir[data-dirid="').concat(e,'"]')).trigger("click")}))}),40)}catch(t){console.error("".concat(this.name,' - failed to create key press listeners for navrose with displayid "').concat(n,'"')),console.error(t)}return h}function update_navrose(t){var e,a,i;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"update_navrose"),null!==(i=this.error)&&void 0!==i||(this.error=function(t){throw new Error(t)});var r=t.$rose;if(check_required.call(this,{$rose:r},{label:"jQuery object holding navrose"}),!def.skipcheck.common&&0===r.length)return this.error("".concat(this.name," - empty jQuery object, no navrose provided"));var n=r.data("mapid"),o=r.data("displayid"),l=r.data("entityid"),c=r.data("print_names"),s=get_navmap(n).diagonal,d=get_naventity(l);try{var p=_objectSpread(_objectSpread({},dirs_0),s?dirs_8:dirs_4);for(var h in p){print_navdir.call(this,{displayid:o,mapid:n,dir:p[h],entity:d,print_names:c}).appendTo(r)}}catch(t){console.error("".concat(this.name," - failed to update navrose (update_navrose)")),console.error(t)}}function click_navrose(t){var e=t.displayid,a=t.mapid,i=t.entityid,r=t.ev,n=$(r.target);if(n.hasClass("Navdir")){var o=n.data("dirid"),l=_objectSpread(_objectSpread({},dirs_0),dirs_8)[o].delta;mov_naventity.call(this,{entityid:i,mapid:a,delta:l,trigger_update:!1});var c=get_navmap(a),s=get_navdisplay(e),d=get_naventity(i),p=c.cols,h=c.rows,v=s.cols_view,u=s.rows_view;try{var y=d.points[a],m=y.x,f=y.y,g=s.x0,_=s.y0,b=Math.clamp(1,p-v+1,m-Math.floor(v/2)),w=Math.clamp(1,h-u+1,f-Math.floor(u/2));$('.Navdisplay[data-displayid="'.concat(e,'"]')).trigger(":update_navdisplay",{x:b-g,y:w-_}),$('.Navdisplay[data-mapid="'.concat(a,'"]:not([data-displayid="').concat(e,'"])')).trigger(":update_navdisplay"),$('.Navrose[data-mapid="'.concat(a,'"]')).trigger(":update_navrose")}catch(t){console.error("".concat(this.name," - failed to update displays after navrose navigation (click_navrose)")),console.error(t)}}}window.compare_segments=compare_segments,Macro.add(["newnavmap","new_navmap"],{tags:["displayhtml"],handler:function(){debug.log("macro",'---- start "'.concat(this.name,'" handler ----'));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{mapid:{type:"string",alias:"map"},mapname:{type:"string",alias:"name"},cols:{type:"number",alias:"columns"},diagonal:{type:"boolean"}}});if(t.inputtype="array",t.inputmap=this.payload[0].contents.trim().split(/[\s\n]+/g),t.maphtml={},this.payload.length>1)for(var e=1;e<this.payload.length;e++){var a,i,r=_objectSpread({displayid:"default"},create_argObj.call(this,{id:this.name,args_in:this.payload[e].args,template:{displayid:{type:"string",alias:"display"}}})).displayid;def.skipcheck.clobbering||void 0===t.maphtml[r]||console.error("".concat(this.name,' - clobbering, child tag with displayid "').concat(r,'" already used in this macro call')),t.maphtml[r]=null===(a=this.payload[e])||void 0===a||null===(i=a.contents)||void 0===i?void 0:i.trim()}t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),new_navmap.call(this,t)}}),Macro.add(["newnavtile","new_navtile"],{tags:["displayhtml"],handler:function(){var t,e,a,i;debug.log("macro",'---- start "'.concat(this.name,'" handler ----'));var r=create_argObj.call(this,{id:this.name,args_in:this.args,template:{tileid:{type:"string",alias:"tile"},tilename:{type:"string",alias:"name"},vacant:{type:"boolean"}}});if(r.tilehtml={},void 0!==(null===(t=this.payload[0])||void 0===t||null===(e=t.contents)||void 0===e?void 0:e.trim())&&""!==(null===(a=this.payload[0])||void 0===a||null===(i=a.contents)||void 0===i?void 0:i.trim())&&(r.tilehtml.default=this.payload[0].contents.trim()),this.payload.length>1)for(var n=1;n<this.payload.length;n++){var o,l,c=_objectSpread({displayid:"default"},create_argObj.call(this,{id:this.name,args_in:this.payload[n].args,template:{displayid:{type:"string",alias:"display"}}})).displayid;def.skipcheck.clobbering||void 0===r.tilehtml[c]||console.error("".concat(this.name,' - clobbering, child tag with displayid "').concat(c,'" already used in this macro call')),r.tilehtml[c]=null===(o=this.payload[n])||void 0===o||null===(l=o.contents)||void 0===l?void 0:l.trim()}r.source="macro",debug.log("macro",r),debug.log("macro","---- end ".concat(this.name," handler ----")),new_navtile.call(this,r)}}),Macro.add(["new_navdisplay","newnavdisplay"],{handler:function(){debug.log("macro",'---- start "'.concat(this.name,'" handler ----'));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{mapid:{type:"string",alias:"map"},displayid:{type:"string",alias:"display"},cols_view:{type:"number",alias:["viewcolumns","cols","columns"]},rows_view:{type:"number",alias:["viewrows","rows"]},x0:{type:"number"},y0:{type:"number"},entityid_view:{type:"string",alias:["viewentity","entityid"]}}});t.source="macro",debug.log("macro","---- end ".concat(this.name," handler ----")),debug.log("macro",t),new_navdisplay.call(this,t)}}),Macro.add(["print_navdisplay","printnavdisplay"],{handler:function(){debug.log("macro",'---- start "'.concat(this.name,'" handler ----'));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{displayid:{type:"string",alias:"display"},print_tiles:{type:"boolean"}}});t.source="macro",debug.log("macro","---- end ".concat(this.name," handler ----")),debug.log("macro",t),print_navdisplay.call(this,t).appendTo(this.output)}}),Macro.add(["newnaventity","new_naventity"],{tags:["displayhtml"],handler:function(){var t,e,a,i;debug.log("macro","---- start ".concat(this.name," handler ----"));var r=create_argObj.call(this,{id:this.name,args_in:this.args,template:{entityid:{type:"string",alias:"entity"},entityname:{type:"string",alias:"name"},solid:{type:"boolean"}}});if(r.entityhtml={},void 0!==(null===(t=this.payload[0])||void 0===t||null===(e=t.contents)||void 0===e?void 0:e.trim())&&""!==(null===(a=this.payload[0])||void 0===a||null===(i=a.contents)||void 0===i?void 0:i.trim())&&(r.entityhtml.default=this.payload[0].contents.trim()),this.payload.length>1)for(var n=1;n<this.payload.length;n++){var o,l,c=_objectSpread({displayid:"default"},create_argObj.call(this,{id:this.name,args_in:this.payload[n].args,template:{displayid:{type:"string",alias:"display"}}})).displayid;def.skipcheck.clobbering||void 0===r.entityhtml[c]||console.error("".concat(this.name,' - clobbering, child tag with displayid "').concat(c,'" already used in this macro call')),r.entityhtml[c]=null===(o=this.payload[n])||void 0===o||null===(l=o.contents)||void 0===l?void 0:l.trim()}r.source="macro",debug.log("macro",r),debug.log("macro","---- end ".concat(this.name," handler ----")),new_naventity.call(this,r)}}),Macro.add(["setnaventity","set_naventity"],{handler:function(){debug.log("macro","---- start ".concat(this.name," handler ----"));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{entityid:{type:"string",alias:"entity"},mapid:{type:"string",alias:"map"},cell:{type:"array",alias:"point"},x:{type:"number"},y:{type:"number"}}});t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),set_naventity.call(this,t)}}),Macro.add(["remnaventity","rem_naventity"],{handler:function(){debug.log("macro","---- start ".concat(this.name," handler ----"));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{entityid:{type:"string",alias:"entity"},mapid:{type:"string",alias:"map"}}});t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),rem_naventity.call(this,t)}}),Macro.add(["movnaventity","mov_naventity"],{handler:function(){debug.log("macro","---- start ".concat(this.name," handler ----"));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{entityid:{type:"string",alias:"entity"},mapid:{type:"string",alias:"map"},delta:{type:"object"},deltax:{type:"number"},deltay:{type:"number"},ignore_walls:{type:"boolean"},trigger_update:{type:"boolean"}}});t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),mov_naventity.call(this,t)}}),Macro.add(["new_navwall","newnavwall"],{tags:["displayhtml"],handler:function(){var t,e,a,i;debug.log("macro","---- start ".concat(this.name," handler ----"));var r=create_argObj.call(this,{id:this.name,args_in:this.args,template:{wallid:{type:"string",alias:"id"},wallname:{type:"string",alias:"name"}}});if(r.wallhtml={},void 0!==(null===(t=this.payload[0])||void 0===t||null===(e=t.contents)||void 0===e?void 0:e.trim())&&""!==(null===(a=this.payload[0])||void 0===a||null===(i=a.contents)||void 0===i?void 0:i.trim())&&(r.wallhtml.default=this.payload[0].contents.trim()),this.payload.length>1)for(var n=1;n<this.payload.length;n++){var o,l,c=_objectSpread({displayid:"default"},create_argObj.call(this,{id:this.name,args_in:this.payload[n].args,template:{displayid:{type:"string",alias:"display"}}})).displayid;def.skipcheck.clobbering||void 0===r.wallhtml[c]||console.error("".concat(this.name,' - clobbering, child tag with displayid "').concat(c,'" already used in this macro call')),r.wallhtml[c]=null===(o=this.payload[n])||void 0===o||null===(l=o.contents)||void 0===l?void 0:l.trim()}r.source="macro",debug.log("macro",r),debug.log("macro","---- end ".concat(this.name," handler ----")),new_navwall.call(this,r)}}),Macro.add(["set_navwall","setnavwall"],{handler:function(){debug.log("macro","---- start ".concat(this.name," handler ----"));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{wallid:{type:"string",alias:"wall"},mapid:{type:"string",alias:"map"},vertices:{type:"array",alias:"points"},x1:{type:"number"},y1:{type:"number"},x2:{type:"number"},y2:{type:"number"}}});t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),set_navwall.call(this,t)}}),Macro.add(["print_navrose","printnavrose"],{handler:function(){debug.log("macro","---- start ".concat(this.name," handler ----"));var t=create_argObj.call(this,{id:this.name,args_in:this.args,template:{displayid:{type:"string",alias:"display"},entityid:{type:"string",alias:"entity"},print_names:{type:"boolean",alias:"names"},keyboard_codes:{type:"object",alias:"codes"},keyboard_N:{type:"string",alias:"code_N"},keyboard_E:{type:"string",alias:"code_E"},keyboard_S:{type:"string",alias:"code_S"},keyboard_W:{type:"string",alias:"code_W"},keyboard_NW:{type:"string",alias:"code_NW"},keyboard_NE:{type:"string",alias:"code_NE"},keyboard_SE:{type:"string",alias:"code_SE"},keyboard_SW:{type:"string",alias:"code_SW"}}});try{var e;for(var a in null!==(e=t.keyboard_codes)&&void 0!==e||(t.keyboard_codes={}),dirs_8)void 0!==t["keyboard_".concat(a)]&&(t.keyboard_codes[a]=t["keyboard_".concat(a)])}catch(t){console.error("".concat(this.name," - failed to parse keyboard code shorthands into keyboard_codes object (<<print_navrose>>)")),console.error(t)}t.source="macro",debug.log("macro",t),debug.log("macro","---- end ".concat(this.name," handler ----")),print_navrose.call(this,t).appendTo(this.output)}}),UIBar.destroy();