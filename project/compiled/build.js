"use strict";function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,n=function(){};return{s:n,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{ArgObj:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}},_add_array=new WeakSet,_add_object=new WeakSet,_add_string=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_add_string),_classPrivateMethodInitSpec(this,_add_object),_classPrivateMethodInitSpec(this,_add_array),this.set=[];for(var t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];for(var n=0,o=r;n<o.length;n++){var i=o[n];this.add(i)}this.this_is_a_TypeSet=!0}return _createClass(e,[{key:"print",get:function(){var e,t=[],r=_createForOfIteratorHelper(this.set);try{for(r.s();!(e=r.n()).done;){var a=e.value,n=a.any?'any "'.concat(a.any,'"'):'exactly "'.concat(a.exact,'"');t.push(n)}}catch(e){r.e(e)}finally{r.f()}return t.join(" or ")}},{key:"size",get:function(){return this.set.length}},{key:"add",value:function(e){if(!this.has(e))if(Array.isArray(e))_classPrivateMethodGet(this,_add_array,_add_array2).call(this,e);else if("string"==typeof e)_classPrivateMethodGet(this,_add_string,_add_string2).call(this,e);else{if("object"!==_typeof(e))throw new Error('invalid TypeSet input, input must be "string" or "object" or "array"');_classPrivateMethodGet(this,_add_object,_add_object2).call(this,e)}}},{key:"has",value:function(e){var t,r=!1,a=_createForOfIteratorHelper(this.set);try{for(a.s();!(t=a.n()).done;){var n=t.value,o=Object.keys(n)[0],i=Object.values(n)[0];if(i===e||"exact"===o&&i===e.exact||"any"===o&&i===e.any){r=!0;break}}}catch(e){a.e(e)}finally{a.f()}return r}},{key:"accepts",value:function(t){var r,a=!1,n=_createForOfIteratorHelper(this.set);try{for(n.s();!(r=n.n()).done;){var o=r.value,i=Object.keys(o)[0],s=Object.values(o)[0];if("any"===s||"exact"===i&&t===s||"exact"===i&&t.exact===s||"any"===i&&e.id(t)===s||"any"===i&&e.id(t.any)===s){a=!0;break}}}catch(e){n.e(e)}finally{n.f()}return a}},{key:"values",value:function(){return this.set}}],[{key:"validate",value:function(t){if(!e.valid().includes(t))throw new Error('invalid TypeSet input, "'.concat(t,'" is not a valid type'))}},{key:"valid",value:function(){return["any","string","number","object","boolean","undefined","array","null","story variable","temp variable"]}},{key:"id",value:function(e){var t;return t="string"===(t=Object.prototype.toString.call(e).slice(8,-1).toLowerCase())&&"$"===Array.from(e)[0]?"story variable":"string"===t&&"_"===Array.from(e)[0]?"temp variable":t}},{key:"isTypeSet",value:function(e){return!!e.this_is_a_TypeSet}}]),e}();function _add_array2(e){if(0===e.length)throw new Error("invalid TypeSet input, array cannot be empty");var t,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;this.add(a)}}catch(e){r.e(e)}finally{r.f()}}function _add_object2(e){if(1!==Object.keys(e).length)throw new Error('invalid TypeSet input, object must have one key only"');var t=Object.keys(e).filter((function(e){return"any"!==e&&"exact"!==e}));if(t.length>0)throw new Error('invalid TypeSet input, object contains invalid key "'.concat(t[0],'"'));e.any&&TypeSet.validate(e.any),this.set.push(e)}function _add_string2(e){TypeSet.validate(e),this.set.push({any:e})}function validate_tags(e){var t=this;try{var r=function(r){if(!t.self.tags.includes(r))throw new Error("missing tag ".concat(r," in macro definition for ").concat(t.name));return e[r].unique&&t.payload.filter((function(e){return e.name===r})).length>1?{v:t.error("".concat(r," - macro only accepts one ").concat(r," tag"))}:e[r].required&&0===t.payload.filter((function(e){return e.name===r})).length?{v:t.error("".concat(t.name," - ").concat(r," tag is required for macro"))}:void 0};for(var a in e){var n=r(a);if("object"===_typeof(n))return n.v}}catch(e){console.error("failed to validate macro child tags for ".concat(this.name)),console.error(e)}}function ArgObj(e,t,r){try{if(!e)throw new Error("ArgObj input missing, arguments");var a=clone(e);if(!t)throw new Error("ArgObj input missing, template");var n=clone(t),o=n.id;if(!o)throw new Error("ArgObj template id missing");delete n.id;var i=Object.keys(n);if(!i.length)throw new Error("ArgObj template cannot be empty");var s=i.filter((function(e){return n[e].infinite}));if(s.length>1)throw new Error("ArgObj template cannot have more than one infinite key");if(s[0]&&s[0]!==i[i.length-1])throw new Error("ArgObj template infinite key must be last");for(var c={},l={id:o,args:a,template:n,keys:i,argObj:c,splice:0,options:r};l.args.length>0;){debug.log("ArgObj","entered loop"),l.splice=0;var d=l.args[0];try{s[0]&&c[s[0]]&&ArgObj_infinite.call(this,l),!l.splice&&d.isLink&&ArgObj_markup.call(this,l),!l.splice&&i.includes(d)&&ArgObj_kvp.call(this,l),l.splice||"object"!==TypeSet.id(d)||ArgObj_obj.call(this,l);var p=_objectSpread({strict:!1},l.options).strict;if(l.splice||p||ArgObj_lazy.call(this,l),!l.splice)return this.error("".concat(o,' - unexpected input "').concat(d,'" did not match any valid types'));l.args.splice(0,l.splice)}catch(e){console.error('ArgObj failed at "'.concat(d,'"')),console.error(e)}}var u,f=i.filter((function(e){return n[e].required})),h=Object.keys(c),m=_createForOfIteratorHelper(f);try{for(m.s();!(u=m.n()).done;){var g=u.value;if(!h.includes(g))return this.error("".concat(o,' - missing required key "').concat(g,'"'))}}catch(e){m.e(e)}finally{m.f()}return s[0]&&"array"!==TypeSet.id(c[s[0]])&&(c[s[0]]=[c[s[0]]]),c}catch(e){console.error('failed to parse macro arguments for "'.concat(this.name,'"')),console.error(e)}}function ArgObj_infinite(e){debug.log("ArgObj","entered markup"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=e.template,n=e.keys,o=e.argObj,i=(e.options,r[0]),s=n.filter((function(e){return a[e].infinite}))[0],c=new TypeSet(a[s].type);return c.accepts(i)?("array"!==TypeSet.id(o[s])&&(o[s]=[o[s]]),o[s].includes(i)?(e.splice=1,e):(o[s]="array"===TypeSet.id(i)?o[s].concat(i):o[s].concat([i]),e.splice=1,e)):this.error("".concat(t,' - "').concat(i,'" is an invalid type for "').concat(s,'", expected ').concat(c.print))}function ArgObj_markup(e){debug.log("ArgObj","entered markup"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=(e.template,e.keys),n=e.argObj,o=(e.options,r[0]);return a.includes("passage")?(n.linktext=o.text,n.passage=o.link,e.splice=1,e):this.error("".concat(t," - macro does not accept [[markup]]"))}function ArgObj_kvp(e){debug.log("ArgObj","entered kvp"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=e.template,n=(e.keys,e.argObj),o=(e.options,r[0]),i=r[1],s=new TypeSet(a[o].type);return s.accepts(i)?(n[o]=i,e.splice=2,e):this.error("".concat(t,' - "').concat(i,'" is an invalid type for "').concat(o,'", expected ').concat(s.print))}function ArgObj_lazy(e){debug.log("ArgObj","entered lazy matcher"),debug.log("ArgObj",e);e.id;var t=e.args,r=e.template,a=e.keys,n=e.argObj,o=(e.options,t[0]),i=a.filter((function(e){return!Object.keys(n).includes(e)}));if(!i.length)return e;var s,c=_createForOfIteratorHelper(i);try{for(c.s();!(s=c.n()).done;){var l=s.value;if(new TypeSet(r[l].type).accepts(o)){n[l]=o,e.splice=1;break}}}catch(e){c.e(e)}finally{c.f()}return e}function ArgObj_obj(e){debug.log("ArgObj","entered object parser"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=e.template,n=e.keys,o=e.argObj,i=(e.options,r[0]);for(var s in i)if(n.includes(s)){var c=new TypeSet(a[s].type);if(!c.accepts(i[s]))return this.error("".concat(t,' - "').concat(arg_next,'" is an invalid type for "').concat(i[s],'", expected ').concat(c.print));o[s]=i[s],e.splice=1}return e}Macro.add("newmap",{config:{diagonal:!1,reach:"tile",wall:{id:".",name:"wall",type:"wall",element:"_id"},floor:{id:"#",name:"floor",type:"floor",element:"_id"},start:{x:1,y:1},tilesize:"2rem",residents:{width:1,height:1,wall:!0},disabled:!1,hidden:!1,prevented:!1,safemode:!0},tags:null,maps:{},handler:function(){var e=ArgObj.call(this,this.args,{id:"newmap",mapname:{type:"string",required:!0},columns:{type:"number",required:!0},diagonal:{type:"boolean"},reach:{type:[{exact:"tile"},{exact:"all"}]},x:{type:"number"},y:{type:"number"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){try{var t,r,a=_objectSpread({diagonal:this.self.config.diagonal,reach:this.self.config.reach},e),n=a.mapname,o=a.columns,i=a.diagonal,s=a.reach;if(this.self.maps[n])return this.error?this.error("".concat(this.name,' - map "').concat(n,'" already exists')):new Error('newmap - map "'.concat(n,'" already exists'));var c=this.payload[0].contents.trim().split(/\s+/g);if(c.length%o)return this.error?this.error("".concat(this.name," - input map is not rectangular")):new Error("newmap - input map is not rectangular");var l,d={},p=_createForOfIteratorHelper(new Set(c));try{for(p.s();!(l=p.n()).done;){var u=l.value;d[u]={id:u,name:u,type:this.self.config.floor.type,element:u}}}catch(e){p.e(e)}finally{p.f()}var f=this.self.config.wall,h=this.self.config.floor;d[f.id]=clone(f),d[h.id]=clone(h),this.self.maps[n]={mapname:n,columns:o,diagonal:i,reach:s,arr:c,tiles:d,residents:[]};var m={mapname:n,x:null!==(t=e.x)&&void 0!==t?t:this.self.config.start.x,y:null!==(r=e.y)&&void 0!==r?r:this.self.config.start.y};Macro.get("mapteleport").handlerJS.call(this,m)}catch(e){console.error('failed to create "'.concat(mapname,'" newmap map object for "').concat(this.name,'"')),console.error(e)}}}),Macro.add(["mapteleport","mapstart","mapsetposition"],{handler:function(){var e={id:this.name,mapname:{type:"string",required:!0},x:{type:"number",required:!0},y:{type:"number",required:!0}},t=ArgObj.call(this,this.args,e);this.self.handlerJS.call(this,t)},handlerJS:function(e){try{var t=e.mapname,r=e.x,a=e.y,n=Macro.get("newmap").maps[t];if(!n)return this.error?this.error("".concat(this.name,' - no map with mapname "').concat(t,'" found')):new Error('mapteleport - no map with mapname "'.concat(t,'" found'));var o=n.columns,i=n.arr;if(!Number.isInteger(r))return this.error?this.error("".concat(this.name," - x must be a positive integer")):new Error("mapteleport - x must be a positive integer");if(!Number.isInteger(a))return this.error?this.error("".concat(this.name," - y must be a positive integer")):new Error("mapteleport - y must be a positive integer");if(r>o)return this.error?this.error("".concat(this.name," - x position is out of bounds")):new Error("mapteleport - x position is out of bounds");if(a>i.length/o)return this.error?this.error("".concat(this.name," - y position is out of bounds")):new Error("mapteleprot - y position is out of bounds");n.position={x:r,y:a}}catch(e){console.error('failed to set "'.concat(mapname,'" map position for "').concat(this.name,'"')),console.error(e)}}}),Macro.add("maptile",{tags:["tilename","tiletype","tileelement"],handler:function(){var e=this;validate_tags.call(this,{tilename:{unique:!0},tiletype:{unique:!0},tileelement:{unique:!0}});var t={id:this.name,mapname:{type:"string",required:!0},tileid:{type:["string","array"],required:!0,infinite:!0}},r=ArgObj.call(this,this.args,t),a=r.mapname,n=r.tileid,o=Macro.get("newmap").maps[a];try{if(!o)return this.error("".concat(this.name,' - no map with mapname "').concat(a,'" found'));var i,s=_createForOfIteratorHelper(n);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(!o.tiles[c])return this.error("".concat(this.name,' - no tile with id "').concat(c,'" found in map "').concat(a,'"'))}}catch(e){s.e(e)}finally{s.f()}for(var l=function(){var t=p[d],r=e.payload.filter((function(e){return e.name===t}));if(0===r.length)return"continue";var a,i=t.replace("tile",""),s=_defineProperty({id:t},i,{type:"string",required:!0}),c=ArgObj.call(e,r[0].args,s),l=_createForOfIteratorHelper(n);try{for(l.s();!(a=l.n()).done;){var u=a.value;o.tiles[u][i]=c[i]}}catch(e){l.e(e)}finally{l.f()}},d=0,p=["tilename","tiletype"];d<p.length;d++)l();var u=this.payload.filter((function(e){return"tileelement"===e.name}));if(u.length>0){if(u[0].args.length>0)return this.error("tileelement - tag does not take arguments");var f,h=_createForOfIteratorHelper(n);try{for(h.s();!(f=h.n()).done;){var m=f.value;o.tiles[m].element=u[0].contents.trim()}}catch(e){h.e(e)}finally{h.f()}}}catch(e){console.error('failed to process "'.concat(a,'" maptile definition for "').concat(this.name,'"')),console.error(e)}},handlerJS:function(e){var t=e.mapname,r=e.tiles,a=Macro.get("newmap").maps[t];if(!a)return new Error("".concat(this.name,' - no map with mapname "').concat(t,'" found'));for(var n in r){if(!a.tiles[n])return new Error('maptile - no tile with id "'.concat(n,'" found in map "').concat(t,'"'));Object.assign(a.tiles[n],r[n])}}}),Macro.add("showmap",{handler:function(){var e=ArgObj.call(this,this.args,{id:"showmap",mapname:{type:"string",required:!0},tilesize:{type:"string"},css_class:{type:"string"}}),t=_objectSpread({tilesize:Macro.get("newmap").config.tilesize},e),r=t.mapname,a=t.tilesize,n=t.css_class,o=Macro.get("newmap").maps[r],i=o.columns,s=o.arr,c=o.position,l=o.tiles,d=o.residents;function p(e,t){var r=e%t+1;return{x:r,y:(e-r+1)/t+1}}try{var u=window.crypto.randomUUID();c.i=function(e,t){var r=e.x;return(e.y-1)*t+r-1}(c,i);for(var f=$(document.createElement("div")).addClass("macro-".concat(this.name,"-map")).addClass(n).attr("data-mapid",u).attr("data-mapname",r).attr("data-columns",i).attr("data-position-i",c.i).attr("data-position-x",c.x).attr("data-position-y",c.y).css({"--tilesize":a,"grid-template-columns":"repeat(".concat(i,",").concat(a,")")}),h=0;h<s.length;h++){var m=s[h],g=p(h,i),v=g.x,y=g.y;$(document.createElement("div")).addClass("macro-".concat(this.name,"-tile")).addClass(l[m].type).addClass(h===c.i?"macro-".concat(this.name,"-here"):"").attr("data-tileid",l[m].id).attr("data-i",h).attr("data-x",v).attr("data-y",y).wiki(l[m].element?l[m].element.replace(/_id/g,l[m].id).replace(/_type/g,l[m].type).replace(/_name/g,l[m].name):l[m].id).appendTo(f)}var b,w=_createForOfIteratorHelper(d);try{for(w.s();!(b=w.n()).done;){var j=b.value,_=j.id,O=j.name,S=j.x,k=j.y,A=j.width,x=j.height,E=(j.wall,j.payload);$(document.createElement("div")).addClass("macro-".concat(this.name,"-resident")).addClass(O).attr("data-name",O).attr("data-id",_).wiki(E).css({"grid-column":"".concat(S," / span ").concat(A),"grid-row":"".concat(k," / span ").concat(x)}).appendTo(f)}}catch(e){w.e(e)}finally{w.f()}f.appendTo(this.output)}catch(e){console.error("failed to create showmap map"),console.error(e)}}}),Macro.add("addresident",{tags:null,handler:function(){var e={id:this.name,mapname:{type:"string",required:!0},residentname:{type:"string"},x:{type:"number",required:!0},y:{type:"number",required:!0},width:{type:"number"},height:{type:"number"},wall:{type:"boolean"}},t=ArgObj.call(this,this.args,e);t.payload=this.payload[0].contents.trim(),this.self.handlerJS.call(this,t)},handlerJS:function(e){try{var t=_objectSpread({width:Macro.get("newmap").config.residents.width,height:Macro.get("newmap").config.residents.height,wall:Macro.get("newmap").config.residents.wall},e),r=t.mapname,a=t.residentname,n=t.x,o=t.y,i=t.width,s=t.height,c=t.wall,l=t.payload,d=Macro.get("newmap").maps[r];if(!d)return this.error?this.error("".concat(this.name,' - no map with mapname "').concat(r,'" found')):new Error('addtomap - no map with mapname "'.concat(r,'" found'));var p=d.arr,u=d.columns,f=d.residents;if(d.residents.filter((function(e){return e.name===a})).length)return this.error?this.error("".concat(this.name,' - resident with name "').concat(a,'" already exists in map "').concat(r,'"')):new Error('addresident - resident with name "'.concat(a,'" already exists in map "').concat(r,'"'));var h={x:n,y:o,width:i,height:s};for(var m in h)if(!Number.isInteger(h[m]))return this.error?this.error("".concat(this.name," - ").concat(m," must be a positive integer")):new Error("addresident - ".concat(m," must be a positive integer"));if(n+i-1>u)return this.error?this.error("".concat(this.name," - x position plus width is out of bounds")):new Error("addresident - x position plus width is out of bounds");if(o+s-1>p.length/u)return this.error?this.error("".concat(this.name," - y position plus height is out of bounds")):new Error("addresident - y position plus height is out of bounds");f.push({id:window.crypto.randomUUID(),name:a,x:n,y:o,width:i,height:s,wall:c,payload:l})}catch(e){console.error("failed to add resident to ".concat(mapname)),console.error(e)}}}),Macro.add("removeresident",{handler:function(){var e={id:this.name,mapname:{type:"string",required:!0},resident:{type:"string",required:!0,infinite:!0}},t=ArgObj.call(this,this.args,e);this.self.handlerJS(t)},handlerJS:function(e){var t=this,r=e.mapname,a=e.resident,n=Macro.get("newmap").maps[r];if(!n)return this.error?this.error("".concat(this.name,' - no map with mapname "').concat(r,'" found')):new Error('removeresident - no map with mapname "'.concat(r,'" found'));var o,i=_createForOfIteratorHelper(a);try{var s=function(){var e=o.value,a=n.residents.findIndex((function(t){return t.name===e}));if(a<0)return{v:t.error?t.error("".concat(t.name,' - no resident with name "').concat(e,' found in map "').concat(r,'"')):new Error('removeresident - no resident with name "'.concat(e,' found in map "').concat(r,'"'))};n.residents.splice(a,1)};for(i.s();!(o=i.n()).done;){var c=s();if("object"===_typeof(c))return c.v}}catch(e){i.e(e)}finally{i.f()}}}),Macro.add("mapupdate",{handler:function(){var e={id:this.name,mapname:{type:"string",required:!0}},t=ArgObj.call(this,this.args,e);this.self.handlerJS(t)},handlerJS:function(e){var t=e.mapname;if(!Macro.get("newmap").maps[t])return this.error?this.error("".concat(this.name,' - no map with mapname "').concat(t,'" found')):new Error('removeresident - no map with mapname "'.concat(t,'" found'))}}),Macro.add("newnav",{config:{reach:"tile",safemode:!0},tags:["onattempt","onabort","onleave","onenter"],navs:{},handler:function(){var e,t,r=this;try{var a,n=ArgObj.call(this,this.args,{id:"newnav",mapname:{type:"string",required:!0},reach:{type:[{exact:"--tile"},{exact:"tile"},{exact:"--all"},{exact:"all"}]},navname:{type:"string"}}),o=n.mapname;if(!Macro.get("newmap").maps[o])return this.error('newnav - map with "'.concat(o,'" does not exist'));if(null!==(a=n.navname)&&void 0!==a||(n.navname=o),e=n.navname,this.self.navs[e])return this.error('newnav - nav "'.concat(e,'" already exists'));var i=this.self.config.reach;this.self.navs[e]=_objectSpread({reach:i},n),this.self.navs[e].reach=this.self.navs[e].reach.replace("--",""),t=this.self.navs[e].reach}catch(e){console.error("failed to create newnav nav object"),console.error(e)}var s=this.self.navs[e],c=Macro.get("newmap").maps[s.mapname],l=c.columns,d=c.diagonal,p=c.arr,u=Macro.get("newmap").config.wall,f=function(e){return c.tiles[e].type.split(/\s+/g).includesAny(u.type.split(/\s+/g))};if("tile"===t)try{s.roads={}}catch(e){console.error("failed to create newnav reach-tile roads object"),console.error(e)}if("all"===t)try{for(var h in s.roads={},c.tiles)f(h)||(s.roads[h]={},s.roads[h].N=[],s.roads[h].E=[],s.roads[h].W=[],s.roads[h].S=[],d&&(s.roads[h].NW=[],s.roads[h].NE=[],s.roads[h].SE=[],s.roads[h].SW=[]));for(var m=0;m<p.length;m++){var g=p[m];if(!f(g)){if(m>=l){var v=p[m-l];g===v||f(v)||s.roads[g].N.pushUnique(v)}if((m+1)%l){var y=p[m+1];g===y||f(y)||s.roads[g].E.pushUnique(y)}if(m<p.length-l){var b=p[m+l];g===b||f(b)||s.roads[g].S.pushUnique(b)}if(m%l){var w=p[m-1];g===w||f(w)||s.roads[g].W.pushUnique(w)}if(d){if(m>=l&&m%l){var j=p[m-l-1];g===j||f(j)||s.roads[g].NW.pushUnique(j)}if(m>=l&&(m+1)%l){var _=p[m-l+1];g===_||f(_)||s.roads[g].NE.pushUnique(_)}if(m<p.length-l&&(m+1)%l){var O=p[m+l+1];g===O||f(O)||s.roads[g].SE.pushUnique(O)}if(m<p.length-l&&m%l){var S=p[m+l-1];g===S||f(S)||s.roads[g].SW.pushUnique(S)}}}}}catch(e){console.error("failed to create newnav reach-all roads object"),console.error(e)}try{for(var k=function(){var e=x[A],a=r.payload.filter((function(t){return t.name===e}));s[e]=[];var n,o=_createForOfIteratorHelper(a);try{for(o.s();!(n=o.n()).done;){var i=n.value;if(0!==i.args.length){var d=void 0;if("tile"===t){if(0===i.args.filter((function(e){return"number"==typeof e})).length)return{v:r.error("".concat(e," - position must be an x y coordinate"))};var u={id:e,x:{type:"number",required:!0},y:{type:"number",required:!0}};if(d=ArgObj.call(r,i.args,u),!Number.isInteger(d.x))return{v:r.error("".concat(e," - x must be a positive integer"))};if(!Number.isInteger(d.y))return{v:r.error("".concat(e," - y must be a positive integer"))};if(d.x>l)return{v:r.error("".concat(e," - x position is out of bounds"))};if(d.y>p.length/l)return{v:r.error("".concat(e," - y position is out of bounds"))}}else{if(0===i.args.filter((function(e){return Object.keys(c.tiles).includes(e)})).length)return{v:r.error("".concat(e," - input tile doesn't exist"))};var f={id:e,tile:{type:"string",required:!0}};d=ArgObj.call(r,i.args,f)}s[e].push({position:d,payload:i.contents})}else s[e].push({position:null,payload:i.contents})}}catch(e){o.e(e)}finally{o.f()}},A=0,x=["onattempt","onleave","onenter","onabort"];A<x.length;A++){var E=k();if("object"===_typeof(E))return E.v}}catch(e){console.error("failed to store on newnav onattempt, onleave, onenter, onabort payloads"),console.error(e)}}}),Macro.add("shownav",{config:{autoupdate:!0},hander:function(){try{ArgObj.call(this,this.args,{id:"shownav",navname:{type:"string",required:!0},autoupdate:{type:"boolean"}})}catch(e){console.error("failed to create shownav nav"),console.error(e)}}}),Macro.add("showrose",{config:{autoupdate:!0},handler:function(){var e=args_to_argsObj.call(this,this.args,{rosename:{type:"string",required:!0,key_omittable:!0},autoupdate:{type:"boolean"}}),t=e.rosename,r=e.autoupdate,a=Macro.get("newrose").roses[t],n=Macro.get("newmap").maps[a.mapname],o=(State.getVar(n.vars.abort),$(document.createElement("div")));o.addClass("macro-showrose").on("click",(function(e){var a=$(e.target).attr("data-dir"),i=$(e.target).attr("data-tile");i&&"C"!==a&&(State.setVar(n.vars.position,i),(null!=r?r:Macro.get("showrose").config.autoupdate)&&(o.html(""),o.append(Macro.get("showrose").createRose(t))))})).append(Macro.get("showrose").createRose(t)).appendTo(this.output)},createRose:function(e){var t=Macro.get("newrose").roses[e],r=Macro.get("newmap").maps[t.mapname],a=State.getVar(r.vars.position),n=State.getVar(r.vars.hide),o=State.getVar(r.vars.disable),i=$(document.createElement("div"));i.addClass("macro-showrose-rose").attr("data-map",t.mapname).attr("data-rose",t.rosename);var s=$(document.createElement("div")),c=r.tilenames?r.tilenames[a]:a;s.addClass("macro-showrose-dir").attr("data-dir","C").html(c).appendTo(i);for(var l=0,d=["N","E","S","W"];l<d.length;l++){var p=d[l],u=$(document.createElement("div"));u.addClass("macro-showrose-dir").attr("data-dir",p);var f,h=_createForOfIteratorHelper(r.tilesObj[a][p]);try{for(h.s();!(f=h.n()).done;){var m,g,v=f.value,y=r.tilenames?r.tilenames[v]:v;$(document.createElement("button")).addClass("macro-showrose-link").prop("disabled",null!==(m=o[v])&&void 0!==m?m:Macro.get("newmap").config.disable).attr("data-dir",p).attr("data-tile",v).css({visibility:(null!==(g=n[v])&&void 0!==g?g:Macro.get("newmap").config.hide)?"visible":"hidden"}).html(y).appendTo(u)}}catch(e){h.e(e)}finally{h.f()}u.appendTo(i)}return i}}),Macro.add("regionrose",{tags:["center","north","northeast","east","southeast","south","southwest","west","northwest","onmove","onenter","onleave","onabort","onattempt","disable","hide","abort"],allRoses:{},createPlaceLinks:function(e,t,r,a){var n;null!==(n=a)&&void 0!==n||(a=!1);var o=this.allRoses[e.name],i=State.getVar(o.position),s="object"===_typeof(e.altNames)?e.altNames:"string"==typeof e.altNames?State.getVar(e.altNames):void 0;if(void 0!==s&&"object"!==_typeof(s))throw new Error("invalid regionmmap regionnames variable");var c="object"===_typeof(o.hide)?o.hide:"string"==typeof o.hide?State.getVar(o.hide):void 0;if(void 0!==c&&"object"!==_typeof(c))throw new Error("invalid regionrose hide variable");var l="object"===_typeof(o.disable)?o.disable:"string"==typeof o.disable?State.getVar(o.disable):void 0;if(void 0!==l&&"object"!==_typeof(l))throw new Error("invalid regionrose disable variable");if("center"!==t){var d=r.children(".macro-regionrose-output");d.html("");for(var p=function(n){var o,p=e.regions[i][t][n],u=void 0===s?p:null!==(o=s[p])&&void 0!==o?o:p,f=void 0!==c&&(void 0!==c[p]&&("boolean"==typeof c[p]?c[p]:"string"==typeof c[p]?State.getVar(c[p]):void 0));if(void 0===f)throw new Error("invalid regionrose hide variable");var h=void 0!==l&&(void 0!==l[p]&&("boolean"==typeof l[p]?l[p]:"string"==typeof l[p]?State.getVar(l[p]):void 0));if(void 0===h)throw new Error("invalid regionrose disable variable");$(document.createElement("a")).wiki(u).addClass("macro-link macro-link-internal macro-regionrose-link").attr("data-posCode",p).attr("data-posName",u).attr("data-regionrose-dir",t).ariaClick({namespace:".macros"},(function(){return Macro.get("regionrose").updateRose(e,p)})).ariaDisabled(h||a).toggle(!f).appendTo(d),r.attr("data-posCode",p).attr("data-posName",u)},u=0;u<e.regions[i][t].length;u++)p(u)}else{var f,h=void 0===s?i:null!==(f=s[i])&&void 0!==f?f:i;r.attr("data-posCode",i).attr("data-posName",h).children(".macro-regionrose-output").html(h)}},updateRose:function(e,t,r){var a=this.allRoses[e.name],n=8===e.wind?["center","north","northeast","east","southeast","south","southwest","west","northwest"]:["center","north","east","south","west"],o=void 0===r||(void 0===r.runPayloads||r.runPayloads),i=void 0!==r&&(void 0!==r.disableLinks&&r.disableLinks),s=void 0!==r&&(void 0!==r.forceUpdate&&r.forceUpdate),c=("object"===_typeof(e.altNames)?e.altNames:"string"==typeof e.altNames&&State.getVar(e.altNames),State.getVar(a.position));void 0!==a.leaveCode&&c!==t&&State.setVar(a.leaveCode,c);var l=t;void 0!==a.enterCode&&State.setVar(a.enterCode,l);var d=a.payload,p=d.onattempt,u=d.onmove,f=d.onenter,h=d.onleave,m=d.onabort;void 0!==p[0]&&$.wiki(p[0].contents);var g="object"===_typeof(a.abort)?a.abort:"string"==typeof a.abort?State.getVar(a.abort):void 0;if(void 0!==g&&"object"!==_typeof(g))throw new Error("invalid regionrose abort variable");var v=void 0!==g&&(void 0!==g[l]&&("boolean"==typeof g[l]?g[l]:"string"==typeof g[l]?State.getVar(g[l]):void 0));if(void 0===v)throw new Error("invalid regionrose abort variable");if(v){if(o)for(var y=0;y<m.length;y++)(Array.isArray(m[y].args[0])&&m[y].args[0].includes(l)||m[y].args.includes(l)||void 0===m[y].args[0])&&$.wiki(m[y].contents)}else{if(o)for(var b=0;b<h.length;b++)(Array.isArray(h[b].args[0])&&h[b].args[0].includes(c)||h[b].args.includes(c)||void 0===h[b].args[0])&&$.wiki(h[b].contents);if(State.setVar(a.position,t),o&&void 0!==u[0]&&$.wiki(u[0].contents),a.autoupdate||s){$(".macro-regionrose-dir").attr("data-posCode","").attr("data-posName","");for(var w=0;w<n.length;w++){var j=n[w],_=$(".macro-regionrose-dir[data-rosedir=".concat(j,"]"));this.createPlaceLinks(e,j,_,i)}}if(o)for(var O=0;O<f.length;O++)(Array.isArray(f[O].args[0])&&f[O].args[0].includes(l)||f[O].args.includes(l)||void 0===f[O].args[0])&&$.wiki(f[O].contents)}},handler:function(){var e,t=this;if(0===this.args.length)return this.error("no region map name specified");var r=Macro.get("regionmap").allMaps[this.args[0]];if(void 0===r)return this.error("region map was not found");if(this.argObj=Macro.get("regionmap").argsToObj(this.args,1),void 0===this.argObj.position)return this.error("no position story variable was input");for(var a=0,n=["position","enterCode","leaveCode"];a<n.length;a++){var o=n[a];if(void 0!==this.argObj[o]&&"$"!==this.argObj[o].toString().first())return this.error("property value, ".concat(o,", input was not a story variable"))}this.self.allRoses[r.name]={name:r.name,position:void 0,enterCode:void 0,leaveCode:void 0,autoupdate:void 0,abort:void 0,hide:void 0,disable:void 0};var i=this.self.allRoses[r.name];Object.assign(i,this.argObj),null!==(e=i.autoupdate)&&void 0!==e||(i.autoupdate=!0);var s=State.getVar(i.position);if(void 0===r.regions[s])return this.error("position was not found in region map");for(var c=function(){var e,r=d[l],a=t.payload.filter((function(e){return e.name===r}));return null!==(e=i[r])&&void 0!==e||(i[r]=void 0===a[0]?void 0:1===a[0].args.length?a[0].args[0]:Macro.get("regionmap").argsToObj(a[0].args,0,r)),"object"===_typeof(i[r])&&0===Object.keys(i[r]).length?{v:t.error("".concat(r," tag input cannot be empty"))}:void 0!==i[r]&&"string"!=typeof i[r]&&"object"!==_typeof(i[r])||"string"==typeof i[r]&&"$"!==i[r].first()?{v:t.error("".concat(r," tag invalid input: must be a story variable, a space separated string list, or an object"))}:void 0},l=0,d=["hide","disable","abort"];l<d.length;l++){var p=c();if("object"===_typeof(p))return p.v}i.payload={};for(var u=function(){var e=h[f];i.payload[e]=t.payload.filter((function(t){return t.name===e}))},f=0,h=["onmove","onenter","onleave","onabort","onattempt"];f<h.length;f++)u();var m=$(document.createElement("div"));m.addClass("macro-regionrose").attr("data-regionmap",r.name);for(var g=8===r.wind?["center","north","northeast","east","southeast","south","southwest","west","northwest"]:["center","north","east","south","west"],v=function(e){var a=g[e],n=$(document.createElement("div"));n.addClass("macro-regionrose-dir").attr("data-rosedir",a);var o=t.payload.filter((function(e){return e.name===a}))[0];if(void 0!==o)if(o.contents.includes("_contents")){var i=o.contents.split("_contents");n.wiki(String(i[0])+"<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>")+String(i[1]))}else n.wiki("<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>")),n.wiki(o.contents);else n.wiki("<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>"));t.self.createPlaceLinks(r,a,n),n.appendTo(m)},y=0;y<g.length;y++)v(y);""!==this.payload[0].contents&&m.wiki(this.payload[0].contents),m.appendTo(this.output)}}),Macro.add("roseupdate",{handler:function(){var e,t,r=this.args.includes(":forcecode");this.args.delete(":forcecode");var a=this.args.includes(":disableall");this.args.delete(":disableall");var n=!this.args.includes(":suppress");this.args.delete(":suppress");var o={runPayloads:r,disableLinks:a,forceUpdate:n},i=null!==(t=(e=this.args)[0])&&void 0!==t?t:e[0]=$(".macro-regionrose").attr("data-regionmap");if(void 0===i)return this.error("no rose found on page");var s=Macro.get("regionmap").allMaps[i],c=Macro.get("regionrose").allRoses[i];if(void 0===s)return this.error("map definition was not found");if(void 0===c)return this.error("rose definition was not found");var l=State.getVar(c.position);Macro.get("regionrose").updateRose(s,l,o)}}),Macro.add(["rosedisable","roseenable"],{handler:function(){0===this.args.length?$(".macro-regionrose-output a").ariaDisabled("rosedisable"===this.name):$(".macro-regionrose-output a[data-posCode=".concat(this.args[0],"]")).ariaDisabled("rosedisable"===this.name)}}),Macro.add(["roseshow","rosehide"],{handler:function(){0===this.args.length?$(".macro-regionrose-output a").toggle("roseshow"===this.name):$(".macro-regionrose-output a[data-posCode=".concat(this.args[0],"]")).toggle("roseshow"===this.name)}});