"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,n=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Macro.add("newmap",{config:{diagonal:!1,wall:{id:".",name:"wall",type:"wall"},floor:{id:"#",name:"floor",type:"floor"},disabled:!1,hidden:!1,prevented:!1,safemode:!0},tags:["mapstart","mapvars","maptiles"],maps:{},handler:function(){var e;try{var t=ArgObj.call(this,this.args,{id:"newmap",mapname:{type:"string",required:!0},columns:{type:"number",required:!0},diagonal:{type:"boolean"}});if(e=t.mapname,this.self.maps[e])return this.error('newmap - map "'.concat(e,'" already exists'));var r=this.payload[0].contents.trim().split(/\s+/g),a=t.columns;if(r.length%a)return this.error("newmap - input map is not rectangular");this.self.maps[e]=_objectSpread(_objectSpread({diagonal:this.self.config.diagonal},t),{},{arr:r})}catch(e){console.error("failed to create newmap map object"),console.error(e)}try{var o=this.self.maps[e],n=o.arr,i=o.columns,s=this.payload.filter((function(e){return"mapstart"===e.name}))[0];if(void 0===s)return this.error("mapstart - required to define start position");var l=s.args,c=ArgObj.call(this,l,{id:"mapstart",x:{type:"number",required:!0},y:{type:"number",required:!0}});if(!Number.isInteger(c.x))return this.error("mapstart - x must be a positive integer");if(!Number.isInteger(c.y))return this.error("mapstart - y must be a positive integer");if(c.x>i)return this.error("mapstart - x position is out of bounds");if(c.y>n.length/i)return this.error("mapstart - y position is out of bounds");o.position=c}catch(e){console.error("failed to initialize newmap start position"),console.error(e)}try{var d=this.self.maps[e];d.tiles={};var p,u=_createForOfIteratorHelper(new Set(d.arr));try{for(u.s();!(p=u.n()).done;){var f=p.value;d.tiles[f]={id:f,name:f,type:this.self.config.floor.type}}}catch(e){u.e(e)}finally{u.f()}var v=this.self.config.wall,g=this.self.config.floor;if(d.tiles[v.id]=clone(v),d.tiles[g.id]=clone(g),this.payload.filter((function(e){return"maptiles"===e.name})).length){var h=this.payload.filter((function(e){return"maptiles"===e.name}))[0].args,y=ArgObj.call(this,h,{id:"maptiles",tiles:{type:["object","story variable"],required:!0}}),m="object"===TypeSet.id(y.tiles)?y.tiles:State.getVar(y.tiles);if("object"!==TypeSet.id(m))return this.error('maptiles - invalid input, must be any "object" or any "story variable" containing an "object"');var b=["id","name","type","element"];for(var w in m)for(var j in Object.assign(d.tiles[w],m[w]),d.tiles[w]){if(!b.includes(j))return this.error('maptiles - invalid input, "'.concat(j,'" is not a valid tile property'));if("type"===j&&d.tiles[w][j].split(/\s+/g).includesAny(v.type.split(/\s+/g))&&d.tiles[w][j].split(/\s+/g).includesAny(g.type.split(/\s+/g)))return this.error("tiles cannot be both a wall and a floor")}}}catch(e){console.error("failed to create map tile object"),console.error(e)}try{var _=this.self.maps[e],O=this.payload.filter((function(e){return"mapvars"===e.name}))[0].args,S=ArgObj.call(this,O,{id:"mapvars",position:{type:"story variable"},disabled:{type:"story variable"},hidden:{type:"story variable"},prevented:{type:"story variable"},entering:{type:"story variable"},leaving:{type:"story variable"}});_.vars=S;for(var k=0,A=["disabled","hidden","prevented"];k<A.length;k++){var C=A[k],M={};for(var E in _.tiles){var P;null!==(P=M[E])&&void 0!==P||(M[E]=this.self.config[C])}State.setVar(_.vars[C],M)}}catch(e){console.error("failed to create mapvars"),console.error(e)}}}),Macro.add("newnav",{config:{reach:"tile",safemode:!0},tags:["onattempt","onabort","onleave","onenter"],navs:{},handler:function(){var e,t,r=this;try{var a,o=ArgObj.call(this,this.args,{id:"newnav",mapname:{type:"string",required:!0},reach:{type:[{exact:"--tile"},{exact:"tile"},{exact:"--all"},{exact:"all"}]},navname:{type:"string"}}),n=o.mapname;if(!Macro.get("newmap").maps[n])return this.error('newnav - map with "'.concat(n,'" does not exist'));if(null!==(a=o.navname)&&void 0!==a||(o.navname=n),e=o.navname,this.self.navs[e])return this.error('newnav - nav "'.concat(e,'" already exists'));var i=this.self.config.reach;this.self.navs[e]=_objectSpread({reach:i},o),this.self.navs[e].reach=this.self.navs[e].reach.replace("--",""),t=this.self.navs[e].reach}catch(e){console.error("failed to create newnav nav object"),console.error(e)}var s=this.self.navs[e],l=Macro.get("newmap").maps[s.mapname],c=l.columns,d=l.diagonal,p=l.arr,u=Macro.get("newmap").config.wall,f=function(e){return l.tiles[e].type.split(/\s+/g).includesAny(u.type.split(/\s+/g))};if("tile"===t)try{s.roads={}}catch(e){console.error("failed to create newnav reach-tile roads object"),console.error(e)}if("all"===t)try{for(var v in s.roads={},l.tiles)f(v)||(s.roads[v]={},s.roads[v].N=[],s.roads[v].E=[],s.roads[v].W=[],s.roads[v].S=[],d&&(s.roads[v].NW=[],s.roads[v].NE=[],s.roads[v].SE=[],s.roads[v].SW=[]));for(var g=0;g<p.length;g++){var h=p[g];if(!f(h)){if(g>=c){var y=p[g-c];h===y||f(y)||s.roads[h].N.pushUnique(y)}if((g+1)%c){var m=p[g+1];h===m||f(m)||s.roads[h].E.pushUnique(m)}if(g<p.length-c){var b=p[g+c];h===b||f(b)||s.roads[h].S.pushUnique(b)}if(g%c){var w=p[g-1];h===w||f(w)||s.roads[h].W.pushUnique(w)}if(d){if(g>=c&&g%c){var j=p[g-c-1];h===j||f(j)||s.roads[h].NW.pushUnique(j)}if(g>=c&&(g+1)%c){var _=p[g-c+1];h===_||f(_)||s.roads[h].NE.pushUnique(_)}if(g<p.length-c&&(g+1)%c){var O=p[g+c+1];h===O||f(O)||s.roads[h].SE.pushUnique(O)}if(g<p.length-c&&g%c){var S=p[g+c-1];h===S||f(S)||s.roads[h].SW.pushUnique(S)}}}}}catch(e){console.error("failed to create newnav reach-all roads object"),console.error(e)}try{for(var k=function(){var e=C[A],a=r.payload.filter((function(t){return t.name===e}));s[e]=[];var o,n=_createForOfIteratorHelper(a);try{for(n.s();!(o=n.n()).done;){var i=o.value;if(0!==i.args.length){var d=void 0;if("tile"===t){if(0===i.args.filter((function(e){return"number"==typeof e})).length)return{v:r.error("".concat(e," - position must be an x y coordinate"))};var u={id:e,x:{type:"number",required:!0},y:{type:"number",required:!0}};if(d=ArgObj.call(r,i.args,u),!Number.isInteger(d.x))return{v:r.error("".concat(e," - x must be a positive integer"))};if(!Number.isInteger(d.y))return{v:r.error("".concat(e," - y must be a positive integer"))};if(d.x>c)return{v:r.error("".concat(e," - x position is out of bounds"))};if(d.y>p.length/c)return{v:r.error("".concat(e," - y position is out of bounds"))}}else{if(0===i.args.filter((function(e){return Object.keys(l.tiles).includes(e)})).length)return{v:r.error("".concat(e," - input tile doesn't exist"))};var f={id:e,tile:{type:"string",required:!0}};d=ArgObj.call(r,i.args,f)}s[e].push({position:d,payload:i.contents})}else s[e].push({position:null,payload:i.contents})}}catch(e){n.e(e)}finally{n.f()}},A=0,C=["onattempt","onleave","onenter","onabort"];A<C.length;A++){var M=k();if("object"===_typeof(M))return M.v}}catch(e){console.error("failed to store on newnav onattempt, onleave, onenter, onabort payloads"),console.error(e)}}}),Macro.add("showmap",{config:{tilesize:"2rem"},id:0,handler:function(){try{var e=ArgObj.call(this,this.args,{id:"showmap",mapname:{type:"string",required:!0},tilesize:{type:"string"},class:{type:"string"}}),t=_objectSpread({tilesize:this.self.config.tilesize},e),r=t.mapname,a=t.tilesize,o=Macro.get("newmap").maps[r],n=o.columns,i=o.arr,s=this.self.config.id;this.self.config.id++;var l,c=$(document.createElement("div")).addClass("macroset-mapnav-map").addClass(e.class).attr("data-mapname",r).attr("data-columns",n).attr("id","showmap-macro-".concat(s)),d=_createForOfIteratorHelper(i);try{for(d.s();!(l=d.n()).done;){var p=l.value;$(document.createElement("div")).addClass("macroset-mapnav-tile").addClass(o.tiles[p].type).html(o.tiles[p].element?o.tiles[p].element:o.tiles[p].id).appendTo(c)}}catch(e){d.e(e)}finally{d.f()}c.css({"--tilesize":a,"grid-template-columns":"repeat(".concat(n,",").concat(a,")")}).appendTo(this.output)}catch(e){console.error("failed to create showmap map"),console.error(e)}}}),Macro.add("showrose",{config:{autoupdate:!0},handler:function(){var e=args_to_argsObj.call(this,this.args,{rosename:{type:"string",required:!0,key_omittable:!0},autoupdate:{type:"boolean"}}),t=e.rosename,r=e.autoupdate,a=Macro.get("newrose").roses[t],o=Macro.get("newmap").maps[a.mapname],n=(State.getVar(o.vars.abort),$(document.createElement("div")));n.addClass("macro-showrose").on("click",(function(e){var a=$(e.target).attr("data-dir"),i=$(e.target).attr("data-tile");i&&"C"!==a&&(State.setVar(o.vars.position,i),(null!=r?r:Macro.get("showrose").config.autoupdate)&&(n.html(""),n.append(Macro.get("showrose").createRose(t))))})).append(Macro.get("showrose").createRose(t)).appendTo(this.output)},createRose:function(e){var t=Macro.get("newrose").roses[e],r=Macro.get("newmap").maps[t.mapname],a=State.getVar(r.vars.position),o=State.getVar(r.vars.hide),n=State.getVar(r.vars.disable),i=$(document.createElement("div"));i.addClass("macro-showrose-rose").attr("data-map",t.mapname).attr("data-rose",t.rosename);var s=$(document.createElement("div")),l=r.tilenames?r.tilenames[a]:a;s.addClass("macro-showrose-dir").attr("data-dir","C").html(l).appendTo(i);for(var c=0,d=["N","E","S","W"];c<d.length;c++){var p=d[c],u=$(document.createElement("div"));u.addClass("macro-showrose-dir").attr("data-dir",p);var f,v=_createForOfIteratorHelper(r.tilesObj[a][p]);try{for(v.s();!(f=v.n()).done;){var g,h,y=f.value,m=r.tilenames?r.tilenames[y]:y;$(document.createElement("button")).addClass("macro-showrose-link").prop("disabled",null!==(g=n[y])&&void 0!==g?g:Macro.get("newmap").config.disable).attr("data-dir",p).attr("data-tile",y).css({visibility:(null!==(h=o[y])&&void 0!==h?h:Macro.get("newmap").config.hide)?"visible":"hidden"}).html(m).appendTo(u)}}catch(e){v.e(e)}finally{v.f()}u.appendTo(i)}return i}}),Macro.add("regionrose",{tags:["center","north","northeast","east","southeast","south","southwest","west","northwest","onmove","onenter","onleave","onabort","onattempt","disable","hide","abort"],allRoses:{},createPlaceLinks:function(e,t,r,a){var o;null!==(o=a)&&void 0!==o||(a=!1);var n=this.allRoses[e.name],i=State.getVar(n.position),s="object"===_typeof(e.altNames)?e.altNames:"string"==typeof e.altNames?State.getVar(e.altNames):void 0;if(void 0!==s&&"object"!==_typeof(s))throw new Error("invalid regionmmap regionnames variable");var l="object"===_typeof(n.hide)?n.hide:"string"==typeof n.hide?State.getVar(n.hide):void 0;if(void 0!==l&&"object"!==_typeof(l))throw new Error("invalid regionrose hide variable");var c="object"===_typeof(n.disable)?n.disable:"string"==typeof n.disable?State.getVar(n.disable):void 0;if(void 0!==c&&"object"!==_typeof(c))throw new Error("invalid regionrose disable variable");if("center"!==t){var d=r.children(".macro-regionrose-output");d.html("");for(var p=function(o){var n,p=e.regions[i][t][o],u=void 0===s?p:null!==(n=s[p])&&void 0!==n?n:p,f=void 0!==l&&(void 0!==l[p]&&("boolean"==typeof l[p]?l[p]:"string"==typeof l[p]?State.getVar(l[p]):void 0));if(void 0===f)throw new Error("invalid regionrose hide variable");var v=void 0!==c&&(void 0!==c[p]&&("boolean"==typeof c[p]?c[p]:"string"==typeof c[p]?State.getVar(c[p]):void 0));if(void 0===v)throw new Error("invalid regionrose disable variable");$(document.createElement("a")).wiki(u).addClass("macro-link macro-link-internal macro-regionrose-link").attr("data-posCode",p).attr("data-posName",u).attr("data-regionrose-dir",t).ariaClick({namespace:".macros"},(function(){return Macro.get("regionrose").updateRose(e,p)})).ariaDisabled(v||a).toggle(!f).appendTo(d),r.attr("data-posCode",p).attr("data-posName",u)},u=0;u<e.regions[i][t].length;u++)p(u)}else{var f,v=void 0===s?i:null!==(f=s[i])&&void 0!==f?f:i;r.attr("data-posCode",i).attr("data-posName",v).children(".macro-regionrose-output").html(v)}},updateRose:function(e,t,r){var a=this.allRoses[e.name],o=8===e.wind?["center","north","northeast","east","southeast","south","southwest","west","northwest"]:["center","north","east","south","west"],n=void 0===r||(void 0===r.runPayloads||r.runPayloads),i=void 0!==r&&(void 0!==r.disableLinks&&r.disableLinks),s=void 0!==r&&(void 0!==r.forceUpdate&&r.forceUpdate),l=("object"===_typeof(e.altNames)?e.altNames:"string"==typeof e.altNames&&State.getVar(e.altNames),State.getVar(a.position));void 0!==a.leaveCode&&l!==t&&State.setVar(a.leaveCode,l);var c=t;void 0!==a.enterCode&&State.setVar(a.enterCode,c);var d=a.payload,p=d.onattempt,u=d.onmove,f=d.onenter,v=d.onleave,g=d.onabort;void 0!==p[0]&&$.wiki(p[0].contents);var h="object"===_typeof(a.abort)?a.abort:"string"==typeof a.abort?State.getVar(a.abort):void 0;if(void 0!==h&&"object"!==_typeof(h))throw new Error("invalid regionrose abort variable");var y=void 0!==h&&(void 0!==h[c]&&("boolean"==typeof h[c]?h[c]:"string"==typeof h[c]?State.getVar(h[c]):void 0));if(void 0===y)throw new Error("invalid regionrose abort variable");if(y){if(n)for(var m=0;m<g.length;m++)(Array.isArray(g[m].args[0])&&g[m].args[0].includes(c)||g[m].args.includes(c)||void 0===g[m].args[0])&&$.wiki(g[m].contents)}else{if(n)for(var b=0;b<v.length;b++)(Array.isArray(v[b].args[0])&&v[b].args[0].includes(l)||v[b].args.includes(l)||void 0===v[b].args[0])&&$.wiki(v[b].contents);if(State.setVar(a.position,t),n&&void 0!==u[0]&&$.wiki(u[0].contents),a.autoupdate||s){$(".macro-regionrose-dir").attr("data-posCode","").attr("data-posName","");for(var w=0;w<o.length;w++){var j=o[w],_=$(".macro-regionrose-dir[data-rosedir=".concat(j,"]"));this.createPlaceLinks(e,j,_,i)}}if(n)for(var O=0;O<f.length;O++)(Array.isArray(f[O].args[0])&&f[O].args[0].includes(c)||f[O].args.includes(c)||void 0===f[O].args[0])&&$.wiki(f[O].contents)}},handler:function(){var e,t=this;if(0===this.args.length)return this.error("no region map name specified");var r=Macro.get("regionmap").allMaps[this.args[0]];if(void 0===r)return this.error("region map was not found");if(this.argObj=Macro.get("regionmap").argsToObj(this.args,1),void 0===this.argObj.position)return this.error("no position story variable was input");for(var a=0,o=["position","enterCode","leaveCode"];a<o.length;a++){var n=o[a];if(void 0!==this.argObj[n]&&"$"!==this.argObj[n].toString().first())return this.error("property value, ".concat(n,", input was not a story variable"))}this.self.allRoses[r.name]={name:r.name,position:void 0,enterCode:void 0,leaveCode:void 0,autoupdate:void 0,abort:void 0,hide:void 0,disable:void 0};var i=this.self.allRoses[r.name];Object.assign(i,this.argObj),null!==(e=i.autoupdate)&&void 0!==e||(i.autoupdate=!0);var s=State.getVar(i.position);if(void 0===r.regions[s])return this.error("position was not found in region map");for(var l=function(){var e,r=d[c],a=t.payload.filter((function(e){return e.name===r}));return null!==(e=i[r])&&void 0!==e||(i[r]=void 0===a[0]?void 0:1===a[0].args.length?a[0].args[0]:Macro.get("regionmap").argsToObj(a[0].args,0,r)),"object"===_typeof(i[r])&&0===Object.keys(i[r]).length?{v:t.error("".concat(r," tag input cannot be empty"))}:void 0!==i[r]&&"string"!=typeof i[r]&&"object"!==_typeof(i[r])||"string"==typeof i[r]&&"$"!==i[r].first()?{v:t.error("".concat(r," tag invalid input: must be a story variable, a space separated string list, or an object"))}:void 0},c=0,d=["hide","disable","abort"];c<d.length;c++){var p=l();if("object"===_typeof(p))return p.v}i.payload={};for(var u=function(){var e=v[f];i.payload[e]=t.payload.filter((function(t){return t.name===e}))},f=0,v=["onmove","onenter","onleave","onabort","onattempt"];f<v.length;f++)u();var g=$(document.createElement("div"));g.addClass("macro-regionrose").attr("data-regionmap",r.name);for(var h=8===r.wind?["center","north","northeast","east","southeast","south","southwest","west","northwest"]:["center","north","east","south","west"],y=function(e){var a=h[e],o=$(document.createElement("div"));o.addClass("macro-regionrose-dir").attr("data-rosedir",a);var n=t.payload.filter((function(e){return e.name===a}))[0];if(void 0!==n)if(n.contents.includes("_contents")){var i=n.contents.split("_contents");o.wiki(String(i[0])+"<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>")+String(i[1]))}else o.wiki("<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>")),o.wiki(n.contents);else o.wiki("<div class='macro-regionrose-output' data-rosedir=".concat(a,"></div>"));t.self.createPlaceLinks(r,a,o),o.appendTo(g)},m=0;m<h.length;m++)y(m);""!==this.payload[0].contents&&g.wiki(this.payload[0].contents),g.appendTo(this.output)}}),Macro.add("roseupdate",{handler:function(){var e,t,r=this.args.includes(":forcecode");this.args.delete(":forcecode");var a=this.args.includes(":disableall");this.args.delete(":disableall");var o=!this.args.includes(":suppress");this.args.delete(":suppress");var n={runPayloads:r,disableLinks:a,forceUpdate:o},i=null!==(t=(e=this.args)[0])&&void 0!==t?t:e[0]=$(".macro-regionrose").attr("data-regionmap");if(void 0===i)return this.error("no rose found on page");var s=Macro.get("regionmap").allMaps[i],l=Macro.get("regionrose").allRoses[i];if(void 0===s)return this.error("map definition was not found");if(void 0===l)return this.error("rose definition was not found");var c=State.getVar(l.position);Macro.get("regionrose").updateRose(s,c,n)}}),Macro.add(["rosedisable","roseenable"],{handler:function(){0===this.args.length?$(".macro-regionrose-output a").ariaDisabled("rosedisable"===this.name):$(".macro-regionrose-output a[data-posCode=".concat(this.args[0],"]")).ariaDisabled("rosedisable"===this.name)}}),Macro.add(["roseshow","rosehide"],{handler:function(){0===this.args.length?$(".macro-regionrose-output a").toggle("roseshow"===this.name):$(".macro-regionrose-output a[data-posCode=".concat(this.args[0],"]")).toggle("roseshow"===this.name)}}),Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{ArgObj:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}},_add_array=new WeakSet,_add_object=new WeakSet,_add_string=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_add_string),_classPrivateMethodInitSpec(this,_add_object),_classPrivateMethodInitSpec(this,_add_array),this.set=[];for(var t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];for(var o=0,n=r;o<n.length;o++){var i=n[o];this.add(i)}this.this_is_a_typeSet=!0}return _createClass(e,[{key:"print",get:function(){var e,t=[],r=_createForOfIteratorHelper(this.set);try{for(r.s();!(e=r.n()).done;){var a=e.value,o=a.any?'any "'.concat(a.any,'"'):'exactly "'.concat(a.exact,'"');t.push(o)}}catch(e){r.e(e)}finally{r.f()}return t.join(" or ")}},{key:"size",get:function(){return this.set.length}},{key:"add",value:function(e){if(!this.has(e))if(Array.isArray(e))_classPrivateMethodGet(this,_add_array,_add_array2).call(this,e);else if("string"==typeof e)_classPrivateMethodGet(this,_add_string,_add_string2).call(this,e);else{if("object"!==_typeof(e))throw new Error('invalid TypeSet input, input must be "string" or "object" or "array"');_classPrivateMethodGet(this,_add_object,_add_object2).call(this,e)}}},{key:"has",value:function(e){var t,r=!1,a=_createForOfIteratorHelper(this.set);try{for(a.s();!(t=a.n()).done;){var o=t.value,n=Object.keys(o)[0],i=Object.values(o)[0];if(i===e||"exact"===n&&i===e.exact||"any"===n&&i===e.any){r=!0;break}}}catch(e){a.e(e)}finally{a.f()}return r}},{key:"accepts",value:function(t){var r,a=!1,o=_createForOfIteratorHelper(this.set);try{for(o.s();!(r=o.n()).done;){var n=r.value,i=Object.keys(n)[0],s=Object.values(n)[0];if("any"===s||"exact"===i&&t===s||"exact"===i&&t.exact===s||"any"===i&&e.id(t)===s||"any"===i&&e.id(t.any)===s){a=!0;break}}}catch(e){o.e(e)}finally{o.f()}return a}},{key:"values",value:function(){return this.set}}],[{key:"validate",value:function(t){if(!e.valid().includes(t))throw new Error('invalid TypeSet input, "'.concat(t,'" is not a valid type'))}},{key:"valid",value:function(){return["any","string","number","object","boolean","undefined","array","null","story variable","temp variable"]}},{key:"id",value:function(e){var t;return t="string"===(t=Object.prototype.toString.call(e).slice(8,-1).toLowerCase())&&"$"===Array.from(e)[0]?"story variable":"string"===t&&"_"===Array.from(e)[0]?"temp variable":t}},{key:"isTypeSet",value:function(e){return!!e.this_is_a_typeSet}}]),e}();function _add_array2(e){if(0===e.length)throw new Error("invalid TypeSet input, array cannot be empty");var t,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;this.add(a)}}catch(e){r.e(e)}finally{r.f()}}function _add_object2(e){if(1!==Object.keys(e).length)throw new Error('invalid TypeSet input, object must have one key only"');var t=Object.keys(e).filter((function(e){return"any"!==e&&"exact"!==e}));if(t.length>0)throw new Error('invalid TypeSet input, object contains invalid key "'.concat(t[0],'"'));e.any&&TypeSet.validate(e.any),this.set.push(e)}function _add_string2(e){TypeSet.validate(e),this.set.push({any:e})}function ArgObj(e,t,r){if(!e)throw new Error("ArgObj input missing, arguments");var a=clone(e);if(!t)throw new Error("ArgObj input missing, template");var o=clone(t),n=o.id;if(!n)throw new Error("ArgObj template id missing");delete o.id;var i=Object.keys(o);if(!i.length)throw new Error("ArgObj template cannot be empty");for(var s={},l={id:n,args:a,template:o,keys:i,argObj:s,splice:0,options:r};l.args.length>0;){debug.log("ArgObj","entered loop"),l.splice=0;var c=l.args[0];try{!l.splice&&c.isLink&&ArgObj_markup.call(this,l),!l.splice&&i.includes(c)&&ArgObj_kvp.call(this,l),l.splice||"object"!==TypeSet.id(c)||ArgObj_obj.call(this,l);var d=_objectSpread({strict:!1},l.options).strict;if(l.splice||d||ArgObj_lazy.call(this,l),!l.splice)return this.error("".concat(n,' - unexpected input "').concat(c,'" did not match any valid types'));l.args.splice(0,l.splice)}catch(e){console.error('ArgObj failed at "'.concat(c,'"')),console.error(e)}}var p,u=i.filter((function(e){return o[e].required})),f=Object.keys(s),v=_createForOfIteratorHelper(u);try{for(v.s();!(p=v.n()).done;){var g=p.value;if(!f.includes(g))return this.error("".concat(n,' - missing required key "').concat(g,'"'))}}catch(e){v.e(e)}finally{v.f()}return s}function ArgObj_markup(e){debug.log("ArgObj","entered markup"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=(e.template,e.keys),o=e.argObj,n=(e.options,r[0]);return a.includes("passage")?(o.linktext=n.text,o.passage=n.link,e.splice=1,e):this.error("".concat(t," - macro does not accept [[markup]]"))}function ArgObj_kvp(e){debug.log("ArgObj","entered kvp"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=e.template,o=(e.keys,e.argObj),n=(e.options,r[0]),i=r[1],s=new TypeSet(a[n].type);return s.accepts(i)?(o[n]=i,e.splice=2,e):this.error("".concat(t,' - "').concat(i,'" is an invalid type for "').concat(n,'", expected ').concat(s.print))}function ArgObj_lazy(e){debug.log("ArgObj","entered lazy matcher"),debug.log("ArgObj",e);e.id;var t=e.args,r=e.template,a=e.keys,o=e.argObj,n=(e.options,t[0]),i=a.filter((function(e){return!Object.keys(o).includes(e)}));if(!i.length)return e;var s,l=_createForOfIteratorHelper(i);try{for(l.s();!(s=l.n()).done;){var c=s.value;if(new TypeSet(r[c].type).accepts(n)){o[c]=n,e.splice=1;break}}}catch(e){l.e(e)}finally{l.f()}return e}function ArgObj_obj(e){debug.log("ArgObj","entered object parser"),debug.log("ArgObj",e);var t=e.id,r=e.args,a=e.template,o=e.keys,n=e.argObj,i=(e.options,r[0]);for(var s in i)if(o.includes(s)){var l=new TypeSet(a[s].type);if(!l.accepts(i[s]))return this.error("".concat(t,' - "').concat(arg_next,'" is an invalid type for "').concat(i[s],'", expected ').concat(l.print));n[s]=i[s],e.splice=1}return e}