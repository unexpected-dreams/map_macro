"use strict";var _setup,_config$setupname,_setup$_config$setupn,_State$variables,_config$Statename,_State$variables$_con,_State$variables$conf,_State$variables$conf2,_State$variables$conf3,_State$variables$conf4;function _readOnlyError(e){throw new TypeError('"'+e+'" is read-only')}function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){_defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,c=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){c=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(c)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,a){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return a}var _add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];for(var i=0,n=a;i<n.length;i++){var o=n[i];this.add(o)}}catch(e){console.error("failed to create TypeSet object")}}return _createClass(e,[{key:"print",get:function(){if(this.label)return this.label;var t,a=[],r=_createForOfIteratorHelper(this.any);try{for(r.s();!(t=r.n()).done;){var i=t.value;"undefined"===i||"null"===i?a.push("".concat(i)):a.push("any '".concat(i,"'"))}}catch(e){r.e(e)}finally{r.f()}var n,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(n=o.n()).done;){var c=n.value;a.push("exactly the ".concat(e.id(c)," '").concat(c,"'"))}}catch(e){o.e(e)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(t){try{if("array"===e.id(t))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t);else if("object"===e.id(t))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,t);else if("string"==typeof t)_classPrivateMethodGet(this,_push,_push2).call(this,t,"any");else{var a='TypeSet - invalid input "'.concat(t,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(t," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(t){var a=!1;if("object"!==e.id(t)||1!==Object.keys(t).length||"any"!==Object.keys(t)[0]&&"exact"!==Object.keys(t)[0]&&"other"!==Object.keys(t)[0])for(var r=0,i=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));r<i.length;r++){if(t===i[r]){a=!0;break}}else for(var n=0,o=["any","exact","other"];n<o.length;n++){var c,l=o[n],s=Object.values(t)[0],d=_createForOfIteratorHelper(this[l]);try{for(d.s();!(c=d.n()).done;){if(s===c.value){a=!0;break}}}catch(e){d.e(e)}finally{d.f()}if(a=!0)break}return a}},{key:"accepts",value:function(t){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var r,i=_createForOfIteratorHelper(this.any);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(e.id(t)===n){a=!0;break}}}catch(e){i.e(e)}finally{i.f()}}if(!a){var o,c=_createForOfIteratorHelper(this.exact);try{for(c.s();!(o=c.n()).done;){if(t===o.value){a=!0;break}}}catch(e){c.e(e)}finally{c.f()}}return a}}],[{key:"validate",value:function(t){if(!e.valid.includes(t)){var a='TypeSet - "'.concat(t,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(e){return"object"===_typeof(e)&&!!e["this is a TypeSet"]}}]),e}();function _add_arr2(e,t){if(0===e.length){console.error("TypeSet - array input cannot be empty")}var a,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var i=a.value;t?_classPrivateMethodGet(this,_push,_push2).call(this,i,t):this.add(i)}}catch(e){r.e(e)}finally{r.f()}}function _add_obj2(e){for(var t in e)if("any"!==t&&"exact"!==t&&"other"!==t||"array"!==TypeSet.id(e[t]))if("any"===t||"exact"===t||"other"===t)_classPrivateMethodGet(this,_push,_push2).call(this,e[t],t);else if("label"===t){if("string"!==TypeSet.id(e[t])){var a='TypeSet - input for label "'.concat(e[t],"\" ('").concat(TypeSet.id(e[t]),"') should be a string instead");console.error(a)}this.label=e[t]}else{var r="TypeSet - unexpected object key ".concat(t);console.error(r)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e[t],t)}function _push2(e,t){try{if(this[t].includes(e))return;if("any"===t)TypeSet.validate(e),this.any.push(e);else if("exact"===t)this.exact.push(e);else if("any"===e)this.other.push(e);else{var a="TypeSet - unexpected input for ".concat(t,'-type "').concat(e,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(t,"-type to TypeSet at arg ").concat(e)),console.error(a)}}Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{argObj:!1,proxy:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}};function check_required(e){var t=e.id,a=Object.keys(e).filter((function(e){return"id"!==e}));try{var r,i=_createForOfIteratorHelper(a);try{for(i.s();!(r=i.n()).done;){var n=r.value;if("undefined"===TypeSet.id(e[n])){var o='check_required - missing required input "'.concat(n,'" for ').concat(t);return this.error(o)}}}catch(e){i.e(e)}finally{i.f()}}catch(o){console.error("check_required - failed to validate required arguments for ".concat(t)),console.error(o)}}function check_common(e){if(!e){var t="check_common - missing required template argument";return this.error("check_common - missing required template argument")}var a=e.id;if(!a){return this.error("check_common - missing required id")}try{var r,i=_createForOfIteratorHelper(Object.keys(e).filter((function(e){return"id"!==e})));try{for(i.s();!(r=i.n()).done;){var n=r.value;if("array"===TypeSet.id(e[n].val)){var o,c=_createForOfIteratorHelper(e[n].val);try{for(c.s();!(o=c.n()).done;){var l=o.value;validatation_errors.call(this,{key:n,val:l,template:e})}}catch(e){c.e(e)}finally{c.f()}}else validatation_errors.call(this,{key:n,val:e[n].val,template:e})}}catch(e){i.e(e)}finally{i.f()}}catch(t){console.error("".concat(this.name,' - failed to validate macro arguments for "').concat(a,'"')),console.error(t)}}function validatation_errors(e){var t=e.key,a=e.val,r=e.template,i=r.id;try{if(r[t].extant){if("mapid"===t&&!_getmap(a)){var n="".concat(i,' - no map with id "').concat(a,'" found');return this.error(n)}if("tileid"===t&&!_gettile(r.mapid.val,a)){var o="".concat(i,' - no tile with id "').concat(a,'" in map ').concat(r.mapid.val," found");return this.error(o)}if("entityid"===t&&!_getentity(r.mapid.val,a)){var c="".concat(i,' - no "').concat(a,'" was found residing on map "').concat(r.mapid.val,'"');return this.error(c)}}if(r[t].integer&&!Number.isInteger(a)){var l="".concat(i,' - input "').concat(t,'" must be an integer');return this.error(l)}if(r[t].positive&&a<=0){var s="".concat(i,' - input "').concat(t,'" must be greater than zero');return this.error(s)}if(r[t].oneword&&a.includes(" ")){var d="".concat(i,' - input "').concat(t,'" must be one word, no spaces');return this.error(d)}if(r[t].cssunit){for(var h=!1,p=0,u=["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvw","lvh","dvw","dvh","%"];p<u.length;p++){if(a===u[p]){h=!0;break}}if(!h){var m="".concat(i,' - input "').concat(a,'" for "').concat(t,'" is not a valid css unit');return this.error(m)}}}catch(n){console.error('failed to validate macro arguments on key "'.concat(t,'" with value "').concat(a,'" for "').concat(i,'"')),console.error(n)}}function check_xy(e){if(!e){var t="check_xy - missing required template argument";return this.error(t)}var a=e.id,r=e.mapid,i=e.entityid,n=e.x,o=e.y;if(!a){t="check_xy - missing required id";return this.error(t)}try{var c=_getmap(r),l=(c.arr,c.rows),s=c.columns;if(n.val>s){var d="".concat(a," - ").concat(n.label,' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(d)}if(o.val>l){var h="".concat(a," - ").concat(o.label,' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(h)}if(n.val<1){var p="".concat(a," - ").concat(n.label,' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(p)}if(o.val<1){var u="".concat(a," - ").concat(o.label,' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(u)}}catch(t){console.error('check_xy - failed to validate coordinates { "'.concat(n.label,'" : "').concat(n.val,'", "').concat(o.label,'" : "').concat(o.val,'" } on "').concat(r,'" for "').concat(a,'"')),console.error(t)}}function create_payObj(e,t){var a=this;if(!e){var r='create_payObj - missing input "pays_in" for "'.concat(this.name,'"');return this.error(r)}clone(e);if(!t){var i='create_payObj - misssing input "tempalte_in" for "'.concat(this.name,'"');return this.error(i)}var n=clone(t),o=n.id;if(!o){var c='create_payObj - missing template id for "'.concat(this.name,'"');return this.error(c)}var l=Object.keys(n).filter((function(e){return"id"!==e}));if(!l.length){var s='create_payObj - template is empty for "'.concat(this.name,'"');return this.error(s)}var d={};try{var h,p=_createForOfIteratorHelper(l);try{var u=function(){var e=h.value,t=a.payload.filter((function(t){return t.name===n[e].tagname}));if(!def.skipcheck.unused){var r,i,c;if(n[e].unique&&t.length>1){var l="".concat(o," - multiple of the same child tag received");return{v:a.error(l)}}if(n[e].noargs&&(null===(r=t[0])||void 0===r||null===(i=r.args)||void 0===i?void 0:i.length)>0){var s="".concat(o," - child tag doesn't take arguments");return{v:a.error(s)}}if(t[0]&&(null===(c=t[0])||void 0===c||!c.contents.trim())){var p="".concat(o," - payload required to use this child tag");return{v:a.error(p)}}}d[e]=t[0]?t[0].contents.trim():null};for(p.s();!(h=p.n()).done;){var m=u();if("object"===_typeof(m))return m.v}}catch(e){p.e(e)}finally{p.f()}return d}catch(r){console.error("".concat(o," - failed to parse payloads")),console.error(r)}}function create_argObj(e,t,a){if(!e){var r='create_argObj - missing input "args_in" for "'.concat(this.name,'"');return this.error(r)}var i=clone(e);if(!t){var n='create_argObj - missing input "template_in" for "'.concat(this.name,'"');return this.error(n)}var o=clone(t),c=o.id;if(!c){var l='create_argObj - missing template id for "'.concat(this.name,'"');return this.error(l)}var s=Object.keys(o).filter((function(e){return"id"!==e}));if(!s.length){var d='create_argObj - template is empty for "'.concat(c,'"');return this.error(d)}var h=s.filter((function(e){return o[e].infinite}));if(h.length>1){var p='create_argObj - "'.concat(c,'" template has more than one infinite key');return this.error(p)}if(h[0]&&h[0]!==s[s.length-1]){var u='create_argObj - "'.concat(c,'" template infinite key must be last');return this.error(u)}try{var m,f={},y=_createForOfIteratorHelper(s);try{for(y.s();!(m=y.n()).done;){var v=m.value;if(f[v]=v,o[v].alias)if("array"===TypeSet.id(o[v].alias)){var g,b=_createForOfIteratorHelper(o[v].alias);try{for(b.s();!(g=b.n()).done;){f[g.value]=v}}catch(e){b.e(e)}finally{b.f()}}else f[o[v].alias]=v}}catch(e){y.e(e)}finally{y.f()}for(var w={},_={id:c,args:i,template:o,keys:s,argObj:w,alias:f,options:a,splice:0};_.args.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",w),_.splice=0;var S=_.args[0];try{h[0]&&w[h[0]]&&argObj_infinite.call(this,_),!_.splice&&S.isLink&&argObj_markup.call(this,_),!_.splice&&s.includes(f[S])&&argObj_kvp.call(this,_),_.splice||"object"!==TypeSet.id(S)||argObj_obj.call(this,_);var k=_objectSpread({strict:!1},_.options).strict;if(_.splice||k||argObj_lazy.call(this,_),!_.splice){var x="".concat(c,' - unexpected input "').concat(S,'", is not a key name and did not match any valid types');return console.error(w),this.error(x)}_.args.splice(0,_.splice)}catch(r){console.error('create_argObj - failed to create argObj at "'.concat(S,'" for "').concat(c,'"')),console.error(r)}}return w}catch(r){console.error("".concat(c," - failed to parse macro arguments")),console.error(r)}}function argObj_infinite(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=e.keys,n=e.argObj,o=(e.alias,e.options,a[0]),c=i.filter((function(e){return r[e].infinite}))[0],l=new TypeSet(r[c].type);if(!l.accepts(o)){var s="".concat(t,' - "').concat(o,'" is an invalid type for "').concat(c,"\" ('").concat(TypeSet.id(o),"'), expected ").concat(l.print);return this.error(s)}return"array"!==TypeSet.id(n[c])&&(n[c]=[n[c]]),n[c].includes(o)?(e.splice=1,e):(n[c]="array"===TypeSet.id(o)?n[c].concat(o):n[c].concat([o]),e.splice=1,e)}function argObj_markup(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args,r=(e.template,e.keys),i=e.argObj,n=(e.alias,e.options,a[0]);if(!r.includes("passage")){var o="".concat(t," - macro does not accept [[markup]]");return this.error(o)}return i.linktext=n.text,i.passage=n.link,e.splice=1,e}function argObj_kvp(e){debug.log("argObj","entered kvp"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=(e.keys,e.argObj),n=e.alias,o=(e.options,a[0]),c=a[1];if("undefined"===TypeSet.id(c)){var l="".concat(t,' - no input was found for argument "').concat(o,'"');return this.error(l)}var s=new TypeSet(r[n[o]].type);if(!s.accepts(c)){var d="".concat(t,' - "').concat(c,"\" is an invalid type ('").concat(TypeSet.id(c),"') for \"").concat(o,'", expected ').concat(s.print);return this.error(d)}return i[n[o]]=c,e.splice=2,e}function argObj_obj(e){debug.log("argObj","entered object parser"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=e.keys,n=e.argObj,o=e.alias,c=(e.options,a[0]);for(var l in c)if(i.includes(o[l])){var s=new TypeSet(r[o[l]].type);if(!s.accepts(c[l])){var d="".concat(t,' - "').concat(c[l],'" is an invalid type for "').concat(l,"\" ('").concat(TypeSet.id(c[l]),"'), expected ").concat(s.print);return this.error(d)}n[o[l]]=c[l],e.splice=1}return e}function argObj_lazy(e){debug.log("argObj","entered lazy matcher"),debug.log("argObj",e);e.id;var t=e.args,a=e.template,r=e.keys,i=e.argObj,n=(e.alias,e.options,t[0]),o=r.filter((function(e){return!Object.keys(i).includes(e)}));if(!o.length)return e;var c,l=_createForOfIteratorHelper(o);try{for(l.s();!(c=l.n()).done;){var s=c.value;if(new TypeSet(a[s].type).accepts(n)){i[s]=n,e.splice=1;break}}}catch(e){l.e(e)}finally{l.f()}return e}var config={map:{},tile:{},wall:{},floor:{},nav:{},player:{},building:{},object:{},npc:{},skipcheck:{},sizingmode:"auto"};config.map.width=20,config.map.height=15,config.map.unit="rem",config.nav.diagonal=!1,config.nav.width=15,config.nav.height=12,config.nav.unit="rem",config.nav.sizingoff=!1,config.wall.tileid=".",config.floor.tileid="x",config.player.wall=!0,config.building.wall=!0,config.object.wall=!1,config.npc.wall=!1,config.tile.width=2,config.tile.height=2,config.skipcheck.xybounds=!1,config.skipcheck.unused=!1,config.wall.tiletype="wall",config.floor.tiletype="floor",config.noclip=!1,config.collisionerror=!1,config.allowclobbering=!1,config.skipcheck.common=!1,config.disableglobal=!1,config.setupname="@navmap",config.globalname="Navmap",config.Statename="@navmap",null!==(_setup$_config$setupn=(_setup=setup)[_config$setupname=config.setupname])&&void 0!==_setup$_config$setupn||(_setup[_config$setupname]={}),null!==(_State$variables$_con=(_State$variables=State.variables)[_config$Statename=config.Statename])&&void 0!==_State$variables$_con||(_State$variables[_config$Statename]={}),null!==(_State$variables$conf2=(_State$variables$conf=State.variables[config.Statename]).local)&&void 0!==_State$variables$conf2||(_State$variables$conf.local={}),null!==(_State$variables$conf4=(_State$variables$conf3=State.variables[config.Statename]).global)&&void 0!==_State$variables$conf4||(_State$variables$conf3.global={});var def=new Proxy(config,get_controller(setup[config.setupname]));function get_controller(e){return{get:function(t,a){return debug.log("proxy","entered proxy"),void 0===e||void 0===e[a]?(debug.log("entered undefined"),t[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(e[a])||e[a].isproxy||(debug.log("proxy","created proxy"),e[a]=new Proxy(config[a],get_controller(e[a])),e[a].isproxy=!0),e[a])}}}var navmaps={};setup.navmaps=navmaps;var Navmap=function(){function e(t,a,r){var i;if(_classCallCheck(this,e),!def.allowclobbering&&navmaps[t])throw new Error('Navmap with map id "'.concat(t,'" already exists'));navmaps[String(t)]=this,this.mapsn=window.crypto.randomUUID(),this.mapid=String(t),this.arr=a,this.columns=r,this.rows=this.arr.length/this.columns,this.actors=new Array(this.arr.length),this.tiles={};var n,o=_createForOfIteratorHelper(new Set(this.arr));try{for(o.s();!(n=o.n()).done;){var c=n.value;this.tiles[String(c)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(c),tilename:c,tiletype:def.floor.tiletype,tilehtml:c}}}catch(e){o.e(e)}finally{o.f()}this.tiles[String(def.wall.tileid)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(def.wall.tileid),tilename:def.wall.tileid,tiletype:def.wall.tiletype,tilehtml:def.wall.tileid},this.tiles[String(def.floor.tileid)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(def.floor.tileid),tilename:def.floor.tileid,tiletype:def.floor.tiletype,tilehtml:def.floor.tileid},null!==(i=this.entities)&&void 0!==i||(this.entities={})}return _createClass(e,[{key:"entities",get:function(){return State.variables[config.Statename].local[this.mapid]},set:function(e){State.variables[config.Statename].local[this.mapid]=e}}],[{key:"newmap",value:function(e){e.id="newmap",e.source="JS",Macro.get("newmap").handlerJS(e)}},{key:"newtile",value:function(e){e.id="newtile",e.source="JS",Macro.get("newtile").handlerJS(e)}},{key:"newentity",value:function(e){e.id="newentity",e.source="JS",Macro.get("newentity").handlerJS(e)}},{key:"delentity",value:function(e){e.id="delentity",e.source="JS",Macro.get("delentity").handlerJS(e)}},{key:"moventity",value:function(e){e.id="moventity",e.source="JS",Macro.get("moventity").handlerJS(e)}},{key:"setentity",value:function(e){e.id="setentity",e.source="JS",Macro.get("setentity").handlerJS(e)}},{key:"mapcalculate",value:function(e){e.id="mapcalculate",e.source="JS",Macro.get("mapcalculate").handlerJS(e)}},{key:"getmap",value:function(){_getmap.apply(void 0,arguments)}},{key:"gettile",value:function(){_gettile.apply(void 0,arguments)}},{key:"getentity",value:function(){_getentity.apply(void 0,arguments)}}]),e}();function convert_i2xy(e,t){var a=e%t+1;return{x:a,y:(e-a+1)/t+1}}function convert_xy2i(e,t){var a=e.x,r=e.y;return a<1||r<1?-1:(r-1)*t+a-1}function _getmap(){for(var e,t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];var i=null!==(e=a[0].mapid)&&void 0!==e?e:a[0];return navmaps[i]}function _gettile(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].tileid)&&void 0!==t?t:r[1],c=_getmap(n);return c.tiles[o]}function _getentity(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=_getmap(n);return c.entities[o]}function getoverlap(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=_getmap(n),l=c.columns,s=c.actors,d=_getentity(n,o),h=d.x,p=d.y,u=convert_xy2i({x:h,y:p},l);return s[u].overlap.filter((function(e){return e!==o}))}function getadjacent(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=_getmap(n),l=c.columns,s=c.actors,d=_getentity(n,o),h=d.x,p=d.y,u=convert_xy2i({x:h,y:p},l);return s[u].adjacent.filter((function(e){return e!==o}))}function create_tile(e){var t=e.mapid,a=e.tile,r=e.i,i=e.x,n=e.y,o=a.tilesn,c=a.tileid,l=a.tilename,s=a.tiletype,d=a.tilehtml;try{var h=$(document.createElement("div"));return h.addClass("macro-showmap-tile").addClass(s).attr("title",l).attr("data-tilesn",o).attr("data-tileid",c).attr("data-tilename",l).attr("data-tiletype",s).css({"grid-column":"".concat(i," / span 1"),"grid-row":"".concat(n," / span 1")}).wiki(d||c),h}catch(e){console.error("".concat(this.name,' - failed to create tile element at "').concat(r,'" on "').concat(t,'" for ').concat(this.name)),console.error(e)}}function create_entity(e){var t=e.mapid,a=e.entity,r=e.x,i=e.y,n=a.entitysn,o=a.entityid,c=a.entityname,l=a.entityhtml;try{var s=$(document.createElement("div"));return s.addClass("macro-showmap-entity").attr("title",c).attr("data-sn",n).attr("data-entityid",o).wiki(l||o).css({"grid-column":"".concat(r," / span 1"),"grid-row":"".concat(i," / span 1")}),s}catch(e){console.error("".concat(this.name,' - failed to create entity element for "').concat(o,'" on "').concat(t,'"')),console.error(e)}}function create_dir(e){var t=e.mapid,a=e.entityid,r=e.dir,i=_getmap(t),n=i.arr,o=i.rows,c=i.columns,l=i.actors,s=r.dirid,d=r.dirname,h=r.deltax,p=r.deltay,u=_getentity(t,a);try{var m=$(document.createElement("div"));m.addClass("macro-shownav-direction macro-shownav-".concat(s)).attr("data-dirid",s).attr("data-mapname",d).attr("data-mapid",t);var f=u.x+h,y=u.y+p,v=convert_xy2i({x:f,y:y},c);if(v>=0&&y>=1&&y<=o&&f>=1&&f<=c){var g=_gettile(t,n[v]),b=g.tileid,w=g.tilename,_=l[v].wall.length>0;m.attr("data-disabled",_).attr("data-tileid",b).wiki(_?"":w||b)}else m.attr("data-disabled",!0).attr("data-tileid",null);return m}catch(e){console.error("".concat(this.name,' - failed to create nav direction "').concat(d,'" for map "').concat(t,'"')),console.error(e)}}config.disableglobal||Object.defineProperty(window,config.globalname,{value:Navmap});var update_map=function(e){var t,a,r,i=e.$map,n=e.map,o=e.mapheight,c=e.mapwidth,l=e.tileheight,s=e.tilewidth,d=e.unit,h=e.sizingmode,p=e.tracked,u=e.viewrows,m=e.viewcolumns,f=n.mapid,y=n.columns,v=n.rows,g=n.arr,b=n.entities;"height"===h?(a=(t=o/u)*s/l,r="height"):"width"===h?(t=(a=c/m)*l/s,r="width"):"auto"===h?c/o>m*s/(u*l)?(a=(t=o/u)*s/l,r="auto-height"):(t=(a=c/m)*l/s,r="auto-width"):"tile"===h&&(a=s,t=l,r="tile"),r&&i.attr("data-sizing",r).attr("data-tilewidth",a).attr("data-tileheight",t).attr("data-unit",d).attr("data-viewrows",u).attr("data-viewcolumns",m).css({"--tilewidth":String(a)+d,"--tileheight":String(t)+d}),console.log(h);var w=p?Math.clamp(1,y-m+1,p.x-Math.floor(m/2)):1,_=p?Math.clamp(1,v-u+1,p.y-Math.floor(u/2)):1;try{for(var S=convert_xy2i({x:w,y:_},y),k=[],x=0;x<u;x++)for(var j=0;j<m;j++){var O=S+j+y*x;k.push(O);var $=g[O];create_tile.call(this,{mapid:f,tile:_gettile(f,$),i:O,x:j+1,y:x+1}).appendTo(i)}for(var T in b){var M=b[T],J=convert_xy2i({x:M.x,y:M.y},y);if(k.includes(J))create_entity.call(this,{mapid:f,entity:M,x:M.x-w+1,y:M.y-_+1}).appendTo(i)}return i}catch(e){console.error("".concat(this.name,' - failed to print map for "').concat(f,'"')),console.error(e)}},print_map=function(e){var t=e.$map,a=e.mapid,r=e.x,i=e.y,n=e.width,o=e.height,c=_getmap(a),l=c.columns,s=c.arr,d=c.entities;try{for(var h=convert_xy2i({x:r,y:i},l),p=[],u=0;u<o;u++)for(var m=0;m<n;m++){var f=h+m+l*u;p.push(f);var y=s[f];create_tile.call(this,{mapid:a,tile:_gettile(a,y),i:f,x:m+1,y:u+1}).appendTo(t)}for(var v in d){var g=d[v],b=convert_xy2i({x:g.x,y:g.y},l);if(p.includes(b))create_entity.call(this,{mapid:a,entity:g,x:g.x-r+1,y:g.y-i+1}).appendTo(t)}return t}catch(e){console.error("".concat(this.name,' - failed to print map for "').concat(a,'"')),console.error(e)}},cssunit={exact:["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvh","dvw","dvh","%"],label:"any valid 'CSS unit'"},dirs_4={C:{dirid:"C",dirname:"center",deltax:0,deltay:0},N:{dirid:"N",dirname:"north",deltax:0,deltay:-1},E:{dirid:"E",dirname:"east",deltax:1,deltay:0},S:{dirid:"S",dirname:"south",deltax:0,deltay:1},W:{dirid:"W",dirname:"west",deltax:-1,deltay:0}},dirs_8=_objectSpread(_objectSpread({},dirs_4),{},{NW:{dirid:"NW",dirname:"northwest",deltax:-1,deltay:-1},NE:{dirid:"NE",dirname:"northeast",deltax:1,deltay:-1},SE:{dirid:"SE",dirname:"southeast",deltax:1,deltay:1},SW:{dirid:"SW",dirname:"southwest",deltax:-1,deltay:1}});Macro.add("newmap",{tags:[null],maps:{},handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},mapname:{type:"string",alias:"name"},columns:{type:"number"},diagonal:{type:"boolean"}});e.source="macro",e.inputtype="array",e.inputmap=this.payload[0].contents.trim().split(/\s+/g),this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"newmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=_objectSpread({diagonal:def.nav.diagonal},e),n=i.source,o=i.mapid,c=i.mapname,l=i.diagonal,s=i.inputtype,d=i.inputmap;if(check_required.call(this,{id:this.name,mapid:o,inputtype:s}),!d){var h="".concat(this.name,"macro"===n?" - missing required macro payload":' - missing required input "inputmap"');return this.error(h)}try{if("array"===s)e.arr=d;else{if("2D array"!==s){var p="".concat(this.name," - invalid inputtype, currently only supports macro payload or 'array' or '2D array'");return this.error(p)}e.columns=d[0].length,e.arr=d.flat()}}catch(h){console.error("".concat(this.name,' - failed to parse input for inputtype "').concat(s,'" and inputmap:+')),console.error(d),console.error(h)}var u=e.arr,m=e.columns;if(!m){h=("".concat(this.name,' - missing required input "columns"'),_readOnlyError("inputtype"));return this.error(h)}def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:o,oneword:!0},columns:{val:m,integer:!0,positive:!0}});try{if(u.length%m){var f="".concat(this.name," - inputmap is not rectangular");return this.error(f)}var y=new Navmap(o,u,m);y.mapname=c,y.diagonal=l}catch(h){console.error("".concat(this.name,' - failed to create Navmap object for map "').concat(o,'"')),console.error(h)}Macro.get("mapcalculate").handlerJS.call(this,{mapid:o,diagonal:l})}}),Macro.add("newtile",{tags:null,handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},tileid:{type:"string",alias:"tile"},tilename:{type:"string",alias:"name"},tiletype:{type:"string",alias:"type"}});e.tilehtml=this.payload[0].contents.trim(),this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"newtile"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.tileid,o=e.tilename,c=e.tiletype,l=e.tilehtml;check_required.call(this,{id:this.name,mapid:i,tileid:n}),def.skipcheck.common||(check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},tileid:{val:n,oneword:!0,extant:!0}}),o&&check_common.call(this,{id:"name",name:{val:o,oneword:!0}}),c&&check_common.call(this,{id:"type",type:{val:c,oneword:!0}}));try{var s=_gettile(i,n);o&&(s.tilename=o),c&&(s.tiletype=c),l&&(s.tilehtml=l)}catch(e){console.error("".concat(this.name,' - failed to create new tile definition for "').concat(n,'" on map "').concat(i,'"')),console.error(e)}}}),Macro.add("showmap",{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},sizingmode:{type:[{exact:"auto"},{exact:"height"},{exact:"width"},{exact:"tile"},{exact:"off"}],alias:"mode"},mapwidth:{type:"number"},mapheight:{type:"number"},tilewidth:{type:"number"},tileheight:{type:"number"},unit:{type:cssunit},viewrows:{type:"number"},viewcolumns:{type:"number"},viewtrack:{type:"string"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"showmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=_objectSpread({sizingmode:def.sizingmode},e),n=i.mapid,o=i.sizingmode,c=i.viewrows,l=i.viewcolumns,s=i.viewtrack;if(check_required.call(this,{mapid:n}),!def.skipcheck.unused){if("height"===o&&e.mapwidth){var d="".concat(this.name,' - map width can\'t be specified when map sizing mode is set to "height"');return this.error(d)}if("width"===o&&e.mapheight){var h="".concat(this.name,' - map height can\'t be specified when map sizing mode is set to "with"');return this.error(h)}if("tile"===o&&(e.mapwidth||e.mapheight)){var p="".concat(this.name,' - map height and width can\'t be specified when map sizing mode is set to "tile"');return this.error(p)}if("off"===o&&(e.mapwidth||e.mapheight||e.unit)){var u="".concat(this.name,' - map height, width, and units can\'t be specified when sizing mode is set to "off"');return this.error(u)}}var m=_objectSpread({mapheight:def.map.height,mapwidth:def.map.width,tileheight:def.tile.height,tilewidth:def.tile.width,unit:def.map.unit},e),f=m.mapheight,y=m.mapwidth,v=m.tileheight,g=m.tilewidth,b=m.unit;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},mapwidth:{val:y,positive:!0},mapheight:{val:f,positive:!0},tilewidth:{val:g,positive:!0},tileheight:{val:v,positive:!0}});var w=_getmap(n),_=w.columns,S=w.rows,k=w.diagonal,x=w.mapsn;if(l||c||s){if(!l&&!c){d="zoom - both viewcolumns and viewrows are required to use showmap zoom";return this.error(d)}if(!def.skipcheck.common){if(check_common.call(this,{id:"zoom",viewcolumns:{val:l,positive:!0,integer:!0},viewrows:{val:c,positive:!0,integer:!0}}),l>_){return this.error("zoom - zoom.x can't be greater than # of columns")}if(c>S){return this.error("zoom - zoom.y can't be greater than # of columns")}if("undefined"!==TypeSet.id(s)&&!_getentity(n,s)){var j='zoom - no entity with id "'.concat(s,'" found, "viewtrack" input must be an entity on map "').concat(n,'"');return this.error(j)}}}try{var O;Macro.get("mapcalculate").handlerJS.call(this,{mapid:n,diagonal:k});var T=_getentity(n,s),M=$(document.createElement("div"));M.addClass("macro-".concat(this.name,"-map")).attr("data-sn",x).attr("data-mapid",n).attr("data-columns",_).attr("data-rows",S).attr("data-tracked",null!==(O=null==T?void 0:T.entityid)&&void 0!==O?O:null),update_map.call(this,{$map:M,map:w,mapheight:f,mapwidth:y,tileheight:v,tilewidth:g,unit:b,sizingmode:o,tracked:T,viewrows:null!=c?c:S,viewcolumns:null!=l?l:_}),M.appendTo(this.output),setTimeout((function(){M.on(":mapupdate",(function(e){$(this).children().remove(),update_map.call(this,{$map:M,map:w,mapheight:f,mapwidth:y,tileheight:v,tilewidth:g,unit:b,sizingmode:o,tracked:T,viewrows:$(this).attr("data-viewrows"),viewcolumns:$(this).attr("data-viewcolumns")})}))}),40)}catch(d){console.error("".concat(this.name,' - failed to create showmap element for map "').concat(n,'"')),console.error(d)}}}),Macro.add("shownav",{tags:["nav-north","nav-east","nav-south","nav-west","nav-northwest","nav-northeast","nav-southeast","nav-southwest"],handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},width:{type:"number"},height:{type:"number"},unit:{type:cssunit}}),t=create_payObj.call(this,this.payload,{id:this.name,north:{tagname:"nav-north",unique:!0,noargs:!0},east:{tagname:"nav-east",unique:!0,noargs:!0},south:{tagname:"nav-south",unique:!0,noargs:!0},west:{tagname:"nav-west",unique:!0,noargs:!0},northwest:{tagname:"nav-northwest",unique:!0,noargs:!0},northeast:{tagname:"nav-northeast",unique:!0,noargs:!0},southeast:{tagname:"nav-southeast",unique:!0,noargs:!0},southwest:{tagname:"nav-southwest",unique:!0,noargs:!0}});this.self.handlerJS.call(this,_objectSpread(_objectSpread({},e),t))},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"shownav"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=_objectSpread({width:def.nav.width,height:def.nav.height,unit:def.nav.unit},e),n=i.mapid,o=i.entityid,c=i.width,l=i.height,s=i.unit;i.north,i.east,i.south,i.west,i.northwest,i.northeast,i.southeast,i.southwest;check_required.call(this,{mapid:n});var d=_getmap(n).diagonal;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},width:{val:c,positive:!0},height:{val:l,positive:!0}});var h=$(document.createElement("div")),p=d?dirs_8:dirs_4;try{var u=window.crypto.randomUUID();for(var m in h.addClass("macro-".concat(this.name,"-nav")).attr("data-mapid",n).attr("data-sn",u).css({"--height":String(l)+s,"--width":String(c)+s}),p){create_dir.call(this,{mapid:n,entityid:o,dir:p[m]}).appendTo(h)}h.appendTo(this.output)}catch(e){console.error("".concat(this.name," -  failed to create nav rose for ").concat(n)),console.error(e)}try{setTimeout((function(){h.on("click",(function(e){var t=$(e.target).attr("data-dirid");if(t&&"C"!==t&&!("true"===$(e.target).attr("data-disabled"))){$(this).trigger(":navupdate",[t]);var a=_getmap($(this).attr("data-mapid")).mapsn;$('[data-sn="'.concat(a,'"]')).trigger(":mapupdate")}})),h.on(":navupdate",(function(e,t){var a=$(this).attr("data-mapid");for(var r in t&&Macro.get("moventity").handlerJS.call(this,{mapid:a,entityid:o,deltax:p[t].deltax,deltay:p[t].deltay}),h.html(""),p){create_dir.call(this,{mapid:a,entityid:o,dir:p[r]}).appendTo(h)}}))}),40)}catch(e){console.error("".concat(this.name," -  failed to add click functionality to navrose for ").concat(n)),console.error(e)}}}),Macro.add(["newentity"],{tags:null,handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},wall:{type:"boolean"},x:{type:"number"},y:{type:"number"}}),t=create_payObj.call(this,this.payload,{id:this.name,entityhtml:{tagname:this.name}});t.entitytrigger,e.source="macro",this.self.handlerJS.call(this,_objectSpread(_objectSpread({},e),t))},handlerJS:function(e){var t,a,r,i;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"newentity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var n=e.mapid,o=e.x,c=e.y,l=(e.source,e.wall),s=e.entityhtml,d=e.entityhandler;check_required.call(this,{id:this.name,mapid:n,x:o,y:c});var h=window.crypto.randomUUID(),p=null!==(i=e.entityid)&&void 0!==i?i:h;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},entityid:{val:p,oneword:!0},x:{val:o,integer:!0},y:{val:c,integer:!0}});var u=_getmap(n);try{var m;if(!def.allowclobbering&&_getentity(n,p)){var f="".concat(this.name,' - entity with id "').concat(p,'" already exists in map "').concat(n,'"');return this.error(f)}def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:n,entityid:p,x:{val:o,label:"entity x position"},y:{val:c,label:"entity y position"}});var y={mapid:n,entitysn:h,entityid:String(p),entityhtml:s,entityhandler:d,x:o,y:c,wall:l};null!==(m=u.entities)&&void 0!==m||(u.entities={}),u.entities[p]=y}catch(f){console.error("".concat(this.name,' = failed to add entity "').concat(p,'" to "').concat(n,'"')),console.error(f)}}}),Macro.add(["delentity"],{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"delentity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid;check_required.call(this,{id:this.name,mapid:i,entityid:n}),def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0}});var o=_getmap(i).entities;try{var c=clone(o[n].entitysn);delete o[n];var l=$('[data-sn="'.concat(c,'"]')).first();l&&(l.remove(),Macro.get("mapcalculate").handlerJS.call(this,{mapid:i,diagonal:diagonal})),$('.macro-shownav-nav[data-mapid="'.concat(i,'"]')).trigger(":navupdate")}catch(e){console.error("".concat(this.name,' - failed to delete entity "').concat(n,'" from "').concat(i,'"')),console.error(e)}}}),Macro.add(["moventity"],{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},deltax:{type:"number",alias:"x"},deltay:{type:"number",alias:"y"},ignorewalls:{type:"boolean"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid,o=e.deltax,c=e.deltay,l=e.ignorewalls;check_required.call(this,{id:this.name,mapid:i,entityid:n,deltax:o,deltay:c}),def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0},deltax:{val:o,integer:!0},deltay:{val:c,integer:!0}});var s=_getmap(i),d=s.columns,h=s.actors,p=s.diagonal,u=s.sn,m=_getentity(i,n),f=m.x,y=m.y;try{def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:n,x:{val:f+o,label:"new x position after deltax"},y:{val:y+c,label:"new y position after deltay"}});var v=convert_xy2i({x:f+o,y:y+c},d);if(!l&&!def.noclip&&h[v].wall.length>0){if(def.collisionerror){var g="".concat(this.name,' - collision detected for entity "').concat(n,'" on "').concat(i,'"');return this.error(g)}return}m.x+=o,m.y+=c,Macro.get("mapcalculate").handlerJS.call(this,{mapid:i,diagonal:p}),$('[data-sn="'.concat(u,'"]')).trigger(":mapupdate"),$('.macro-shownav-nav[data-mapid="'.concat(i,'"]')).trigger(":navupdate")}catch(g){console.error("".concat(this.name,' - failed to move entity "').concat(n,'" on "').concat(i,'"')),console.error(g)}}}),Macro.add("setentity",{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},x:{type:"number"},y:{type:"number"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid,o=e.x,c=e.y;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0},x:{val:o,integer:!0},y:{val:c,integer:!0}});var l=_getmap(i),s=l.mapsn,d=(l.actors,l.columns,l.diagonal);try{var h=_getentity(i,n);def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:n,x:{val:o,label:"new x position"},y:{val:c,label:"new y position"}}),h.x=o,h.y=c,Macro.get("mapcalculate").handlerJS.call(this,{mapid:i,diagonal:d}),$('[data-sn="'.concat(s,'"]')).trigger(":mapupdate"),$('.macro-shownav-nav[data-mapid="'.concat(i,'"]')).trigger(":navupdate")}catch(e){console.error("".concat(this.name,' - failed to set positition for entity "').concat(n,'" on map "').concat(i,'"')),console.error(e)}}}),Macro.add("mapcalculate",{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},diagonal:{type:"boolean"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;"string"==typeof e&&(e={mapid:e}),null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"mapcalculate"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e,n=i.mapid,o=i.diagonal;check_required.call(this,{id:this.name,mapid:n});var c=_getmap(n),l=c.columns,s=c.arr,d=c.actors,h=c.entities;try{for(var p=0;p<s.length;p++){var u=_gettile(n,s[p]);d[p]={},d[p].tileid=u.tileid,d[p].wall=[],d[p].overlap=[],d[p].adjacent=[],u.tiletype===def.wall.tiletype&&d[p].wall.push({tile:u.tileid})}for(var m in h){var f=h[m],y=f.wall,v=f.x,g=f.y,b=f.entityid,w=convert_xy2i({x:v,y:g},l);y&&d[w].wall.push({entity:b}),d[w].overlap.push({entity:b});var _=o?dirs_8:dirs_4;for(var S in _){var k=convert_xy2i({x:v+_[S].deltax,y:g+_[S].deltay},l);k>=0&&k<s.length-1&&d[k].adjacent.push({entity:b})}}}catch(e){console.error("".concat(this.name,' - failed to calculate actors indices for map "').concat(n,'"')),console.error(e)}}});