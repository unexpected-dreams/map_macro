"use strict";var _setup,_config$setupname,_setup$_config$setupn,_State$variables,_config$Statename,_State$variables$_con,_State$variables$conf,_State$variables$conf2,_State$variables$conf3,_State$variables$conf4,_State$variables$conf5,_State$variables$conf6,_navtiles;function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){_defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,l=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){l=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(l)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,a){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return a}var debug={on:{proxy:!1,argObj:!1,macro:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}},_add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];for(var i=0,n=a;i<n.length;i++){var o=n[i];this.add(o)}}catch(e){console.error("failed to create TypeSet object")}}return _createClass(e,[{key:"print",get:function(){if(this.label)return this.label;var t,a=[],r=_createForOfIteratorHelper(this.any);try{for(r.s();!(t=r.n()).done;){var i=t.value;"undefined"===i||"null"===i?a.push("".concat(i)):a.push("any '".concat(i,"'"))}}catch(e){r.e(e)}finally{r.f()}var n,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(n=o.n()).done;){var l=n.value;a.push("exactly the ".concat(e.id(l)," '").concat(l,"'"))}}catch(e){o.e(e)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(t){try{if("array"===e.id(t))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t);else if("object"===e.id(t))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,t);else if("string"==typeof t)_classPrivateMethodGet(this,_push,_push2).call(this,t,"any");else{var a='TypeSet - invalid input "'.concat(t,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(t," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(t){var a=!1;if("object"!==e.id(t)||1!==Object.keys(t).length||"any"!==Object.keys(t)[0]&&"exact"!==Object.keys(t)[0]&&"other"!==Object.keys(t)[0])for(var r=0,i=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));r<i.length;r++){if(t===i[r]){a=!0;break}}else for(var n=0,o=["any","exact","other"];n<o.length;n++){var l,c=o[n],s=Object.values(t)[0],d=_createForOfIteratorHelper(this[c]);try{for(d.s();!(l=d.n()).done;){if(s===l.value){a=!0;break}}}catch(e){d.e(e)}finally{d.f()}if(a=!0)break}return a}},{key:"accepts",value:function(t){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var r,i=_createForOfIteratorHelper(this.any);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(e.id(t)===n){a=!0;break}}}catch(e){i.e(e)}finally{i.f()}}if(!a){var o,l=_createForOfIteratorHelper(this.exact);try{for(l.s();!(o=l.n()).done;){if(t===o.value){a=!0;break}}}catch(e){l.e(e)}finally{l.f()}}return a}}],[{key:"validate",value:function(t){if(!e.valid.includes(t)){var a='TypeSet - "'.concat(t,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(e){return"object"===_typeof(e)&&!!e["this is a TypeSet"]}}]),e}();function _add_arr2(e,t){if(0===e.length){console.error("TypeSet - array input cannot be empty")}var a,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var i=a.value;t?_classPrivateMethodGet(this,_push,_push2).call(this,i,t):this.add(i)}}catch(e){r.e(e)}finally{r.f()}}function _add_obj2(e){for(var t in e)if("any"!==t&&"exact"!==t&&"other"!==t||"array"!==TypeSet.id(e[t]))if("any"===t||"exact"===t||"other"===t)_classPrivateMethodGet(this,_push,_push2).call(this,e[t],t);else if("label"===t){if("string"!==TypeSet.id(e[t])){var a='TypeSet - input for label "'.concat(e[t],"\" ('").concat(TypeSet.id(e[t]),"') should be a string instead");console.error(a)}this.label=e[t]}else{var r="TypeSet - unexpected object key ".concat(t);console.error(r)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e[t],t)}function _push2(e,t){try{if(this[t].includes(e))return;if("any"===t)TypeSet.validate(e),this.any.push(e);else if("exact"===t)this.exact.push(e);else if("any"===e)this.other.push(e);else{var a="TypeSet - unexpected input for ".concat(t,'-type "').concat(e,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(t,"-type to TypeSet at arg ").concat(e)),console.error(a)}}function create_argObj(e){if(void 0===e){var t="".concat(this.name," - failed, missing input (create_argObj)");return this.error(t)}var a=e.id,r=e.template,i=e.options,n=clone(e.args_in);if(void 0===a){t="".concat(this.name," - failed, missing required id (create_argObj)");return this.error(t)}if(void 0===r){var o="".concat(a," - failed, missing required template (create_argObj)");return this.error(o)}if(void 0===n){var l="".concat(a," - failed, missing required args_in (create_argObj)");return this.error(l)}var c=Object.keys(r);if(!c.length){var s="".concat(a," - failed, template can't be empty (create_argObj)");return this.error(s)}var d={};try{for(var p=0,u=c;p<u.length;p++){var v=u[p];if(d[v]=v,void 0!==r[v].alias)if("array"===TypeSet.id(r[v].alias)){var h,f=_createForOfIteratorHelper(r[v].alias);try{for(f.s();!(h=f.n()).done;){d[h.value]=v}}catch(e){f.e(e)}finally{f.f()}}else d[r[v].alias]=v}}catch(t){console.error("".concat(a," - failed to create aliases while parsing macro arguments (create_argObj)")),console.error(t)}var y={},m={id:a,args_in:n,template:r,keys:c,output:y,alias:d,options:i,splice:0};try{for(;m.args_in.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",m),m.splice=0;var g=m.args_in[0];try{0===m.splice&&c.includes(d[g])&&argObj_kvp.call(this,m),0===m.splice&&g.isLink&&argObj_markup.call(this,m),0===m.splice&&"object"===TypeSet.id(g)&&argObj_obj.call(this,m);var _=_objectSpread({strict:!1},i).strict;if(0!==m.splice||_||argObj_lazy.call(this,m),!(m.splice>0)){var b="".concat(a,' - unexpected input "').concat(g,'", is not a key name and did not match any valid types');return console.error(y),this.error(b)}m.args_in.splice(0,m.splice)}catch(t){console.error("".concat(a,' - failed to create argObj at "').concat(g,'" for "').concat(a,'" (create_argObj)')),console.error(t)}}return y}catch(t){console.error("".concat(a," - failed to create argObj from macro arguments (create_argObj)")),console.error(t)}}function argObj_markup(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args_in,r=e.keys,i=e.output,n=a[0];try{if(!r.includes("passage")){var o="".concat(t," - macro does not accept [[markup]]");return this.error(o)}return i.linktext=n.text,i.passage=n.link,e.splice=1,e}catch(o){console.error("".concat(t," - failed to parse macro arguments inside [[markup]] parser (argObj_markup)")),console.error(o)}}function argObj_kvp(e){debug.log("argObj","entered kvp"),debug.log("argObj",e);var t=e.id,a=e.args_in,r=e.template,i=e.output,n=e.alias,o=a[0],l=a[1];try{if("undefined"===TypeSet.id(l)){var c="".concat(t,' - no input was found for argument "').concat(o,'"');return this.error(c)}var s=new TypeSet(r[n[o]].type);if(!s.accepts(l)){var d="".concat(t,' - "').concat(l,"\" is an invalid type ('").concat(TypeSet.id(l),"') for \"").concat(o,'", expected ').concat(s.print);return this.error(d)}return i[n[o]]=l,e.splice=2,e}catch(c){console.error("".concat(t," - failed to parse macro arguments inside KVP parser (argObj_kvp)")),console.error(c)}}function argObj_obj(e){debug.log("argObj","entered object parser"),debug.log("argObj",e);var t=e.id,a=e.args_in,r=e.template,i=e.keys,n=e.output,o=e.alias,l=a[0];try{for(var c in l)if(i.includes(o[c])){var s=new TypeSet(r[o[c]].type);if(!s.accepts(l[c])){var d="".concat(t,' - "').concat(l[c],'" is an invalid type for "').concat(c,"\" ('").concat(TypeSet.id(l[c]),"'), expected ").concat(s.print);return this.error(d)}n[o[c]]=l[c],e.splice=1}return e}catch(d){console.error("".concat(t," - failed to parse macro arguments inside object parser (argObj_obj)")),console.error(d)}}function argObj_lazy(e){debug.log("argObj","entered lazy matcher"),debug.log("argObj",e);var t=e.id,a=e.args_in,r=e.template,i=e.keys,n=e.output,o=a[0];try{var l=i.filter((function(e){return!Object.keys(n).includes(e)}));if(!l.length)return e;var c,s=_createForOfIteratorHelper(l);try{for(s.s();!(c=s.n()).done;){var d=c.value;if(new TypeSet(r[d].type).accepts(o)){n[d]=o,e.splice=1;break}}}catch(e){s.e(e)}finally{s.f()}return e}catch(e){console.error("".concat(t," - failed to parse macro arguments inside lazy parser (argObj_lazy)")),console.error(e)}}var config={nav:{},wall:{},floor:{},skipcheck:{}};config.nav.diagonal=!1,config.wall.tiletype="wall",config.wall.tileid=".",config.floor.tiletype="floor",config.floor.tileid="x",config.skipcheck.clobbering=!1,config.skipcheck.common=!1,config.skipcheck.unused=!1,config.disableglobal=!1,config.setupname="@navmap",config.globalname="Navmap",config.Statename="@navmap",null!==(_setup$_config$setupn=(_setup=setup)[_config$setupname=config.setupname])&&void 0!==_setup$_config$setupn||(_setup[_config$setupname]={}),null!==(_State$variables$_con=(_State$variables=State.variables)[_config$Statename=config.Statename])&&void 0!==_State$variables$_con||(_State$variables[_config$Statename]={}),null!==(_State$variables$conf2=(_State$variables$conf=State.variables[config.Statename]).navmaps)&&void 0!==_State$variables$conf2||(_State$variables$conf.navmaps={}),null!==(_State$variables$conf4=(_State$variables$conf3=State.variables[config.Statename]).naventities)&&void 0!==_State$variables$conf4||(_State$variables$conf3.naventities={}),null!==(_State$variables$conf6=(_State$variables$conf5=State.variables[config.Statename]).navtiles)&&void 0!==_State$variables$conf6||(_State$variables$conf5.navtiles={});var def=new Proxy(config,get_controller(setup[config.setupname]));function get_controller(e){return{get:function(t,a){return debug.log("proxy","entered proxy"),void 0===e||void 0===e[a]?(debug.log("entered undefined"),t[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(e[a])||e[a].isproxy||(debug.log("proxy","created proxy"),e[a]=new Proxy(config[a],get_controller(e[a])),e[a].isproxy=!0),e[a])}}}var navmaps={},naventities={},navtiles=(_defineProperty(_navtiles={},String(def.wall.tileid),{tileid:String(def.wall.tileid),tilename:def.wall.tileid,tiletype:def.wall.tiletype,tilehtml:{default:def.wall.tileid}}),_defineProperty(_navtiles,String(def.floor.tileid),{tileid:String(def.floor.tileid),tilename:def.floor.tileid,tiletype:def.floor.tiletype,tilehtml:{default:def.floor.tileid}}),_navtiles),navdisplays={};function get_navmap(e){return navmaps[e]}function get_navtile(e){return navtiles[e]}function get_naventity(e){return naventities[e]}function get_navdisplay(e){return navdisplays[e]}setup.navmaps=navmaps,setup.navtiles=navtiles,setup.naventities=naventities,setup.navdisplays=navdisplays;var Navmap=_createClass((function e(t,a,r,i){var n,o,l,c,s,d,p,u,v;if(_classCallCheck(this,e),this.error=function(e){throw new Error(e)},!def.skipcheck.clobbering&&navmaps[t])return this.error('Navmap - clobbering, map with id "'.concat(t,'" already exists'));navmaps[String(t)]=this,this.mapid=String(t);try{if("array"===a){if(this.arr=r,this.cols=i,void 0===i)return this.error('Navmap - missing required input "cols" or "columns" for map "'.concat(this.mapid,'"'));if("array"===a&&this.arr%this.cols)return console.error(r),this.error("Navmap - inputmap is not rectangular")}else{if("2D array"!==a)return this.error('Navmap - invalid inputtype for map "'.concat(this.mapid,"\", only macro payload or 'array' or '2D array' is supported"));this.cols=r[0].length;var h,f=_createForOfIteratorHelper(r);try{for(f.s();!(h=f.n()).done;){var y=h.value;if(!Array.isarray(y))return console.error(y),this.error('Navmap - invalid inputmap, non-array detected for map "'.concat(this.mapid,'"'));if(0===(null==y?void 0:y.length)||(null==y?void 0:y.length)!==this.cols)return console.error(y),this.error('Navmap - invalid inputmap, non-rectangular input detected for map "'.concat(this.mapid,'"'))}}catch(e){f.e(e)}finally{f.f()}this.arr=r.flat()}}catch(e){return console.error('Navmap - failed to parse input for inputtype "'.concat(a,'" and inputmap (Navmap)')),console.error(r),this.error(e)}this.mapname=this.mapid,this.rows=this.arr.length/this.cols,this.diagonal=def.nav.diagonal,this.actors=new Array(this.arr.length),this.displays={},null!==(l=(n=State.variables[config.Statename].navmaps)[o=this.mapid])&&void 0!==l||(n[o]={}),null!==(s=(c=State.variables[config.Statename].navmaps[this.mapid]).arr)&&void 0!==s||(c.arr=this.arr),null!==(p=(d=State.variables[config.Statename].navmaps[this.mapid]).cols)&&void 0!==p||(d.cols=this.cols),null!==(v=(u=State.variables[config.Statename].navmaps[this.mapid]).rows)&&void 0!==v||(u.rows=this.rows);var m,g=_createForOfIteratorHelper(new Set(this.arr));try{for(g.s();!(m=g.n()).done;){var _,b,w=m.value;null!==(b=navtiles[_=String(w)])&&void 0!==b||(navtiles[_]={tileid:String(w),tilename:w,tiletype:def.floor.tiletype,tilehtml:w})}}catch(e){g.e(e)}finally{g.f()}}));function check_required(e,t){if(void 0===e)return this.error("".concat(this.name," - failed, missing argObj_in (check_errors)"));try{for(var a in e){var r,i=e[a];if(console.log(a),console.log(void 0===i),void 0===i)return this.error("".concat(this.name,' - missing required argument "').concat(null!==(r=null==t?void 0:t.label)&&void 0!==r?r:a,'"'))}}catch(e){console.error("".concat(this.name," - failed to check for required args")),console.error(e)}}function check_oneword(e,t){if(void 0===e)return this.error("".concat(this.name," - failed, missing argObj_in (check_errors)"));try{for(var a in e){var r;if(e[a].includes(" "))return this.error("".concat(this.name,' - argument "').concat(null!==(r=null==t?void 0:t.label)&&void 0!==r?r:a,'" must be one word, no spaces'))}}catch(e){console.error("".concat(this.name," - failed to check args for oneword requirement")),console.error(e)}}function check_extant(e,t){if(void 0===e)return this.error("".concat(this.name," - failed, missing argObj_in (check_errors)"));try{for(var a in e){var r=e[a];if("mapid"===a&&void 0===get_navmap(r))return this.error("".concat(this.name,' - no map with id "').concat(r,'" found'));if("tileid"===a&&void 0===get_navtile(r))return this.error("".concat(this.name,' - no tile with id "').concat(r,'" found'));if("entityid"===a&&void 0===get_naventity(r))return this.error("".concat(this.name,' - no entity with id "').concat(r,'" found'))}}catch(e){console.error("".concat(this.name," - failed to check args for extant requirement")),console.error(e)}}function check_integer(e,t){if(void 0===e)return this.error("".concat(this.name," - failed, missing argObj_in (check_errors)"));try{for(var a in e){var r,i=e[a];if(!Number.isInteger(i))return this.error("".concat(this.name,' - argument "').concat(null!==(r=null==t?void 0:t.label)&&void 0!==r?r:a,'" must be an integer'))}}catch(e){console.error("".concat(this.name," - failed to check args for integer requirement")),console.error(e)}}function check_positive(e,t){if(void 0===e)return this.error("".concat(this.name," - failed, missing argObj_in (check_errors)"));try{for(var a in e){var r;if(e[a]<=0)return this.error("".concat(this.name,' - argument "').concat(null!==(r=null==t?void 0:t.label)&&void 0!==r?r:a,'" must be greater than zero'))}}catch(e){console.error("".concat(this.name," - failed to check args for positive requirement")),console.error(e)}}config.disableglobal||Object.defineProperty(window,config.globalname,{value:Navmap});var navboxes={};function get_navbox(e){return navboxes[e]}function update_navbox(e){var t=e.displayid,a=e.delta,r=get_navdisplay(t),i=get_navmap(r.mapid),n=i.rows,o=i.cols;try{void 0===get_navbox(t)&&(navboxes[t]={x0:r.x0,y0:r.y0,cols_view:r.cols_view,rows_view:r.rows_view})}catch(e){console.error("".concat(this.name,' - failed to generate default view box during non-extant view box call for display "').concat(t,'"')),console.error(e)}var l=get_navbox(t),c=l.x0,s=l.y0,d=l.cols_view,p=l.rows_view;try{var u,v,h,f,y=Math.clamp(1,o,d+(null!==(u=null==a?void 0:a.cols)&&void 0!==u?u:0)),m=Math.clamp(1,n,p+(null!==(v=null==a?void 0:a.rows)&&void 0!==v?v:0)),g=Math.clamp(1,o-y+1,c+Math.floor((d-y)/2)+(null!==(h=null==a?void 0:a.x)&&void 0!==h?h:0)),_=Math.clamp(1,n-m+1,s+Math.floor((p-m)/2)+(null!==(f=null==a?void 0:a.y)&&void 0!==f?f:0));navboxes[t]={x0:g,y0:_,cols_view:y,rows_view:m}}catch(e){console.error("".concat(this.name,' - failed to update new view box values for display "').concat(t,'"')),console.error(e)}}function print_navtile(e){var t=e.displayid,a=e.tileid,r=e.row,i=e.col,n=get_navtile(a),o=n.tilename,l=n.tiletype,c=n.tilehtml;try{var s=$(document.createElement("div")),d=void 0===c?a:void 0!==c[t]?c[t]:void 0!==c.default?c.default:a;return s.addClass("Navmap-tile").addClass(l).attr("title",o).attr("data-tileid",a).attr("data-tilename",o).attr("data-tiletype",l).css({"grid-column":"".concat(i," / span 1"),"grid-row":"".concat(r," / span 1")}).wiki(d),s}catch(e){console.error("".concat(this.name,' - failed to print navtile element on navdisplay "').concat(t,'"')),console.error(e)}}function convert_i2xy(e,t){var a=get_navmap(t),r=a.arr,i=a.cols;if(e<0||e>r.length)return{};var n=e%i+1;return{x:n,y:(e-n+1)/i+1}}function convert_xy2i(e,t){var a=get_navmap(t),r=a.rows,i=a.cols,n=e.x,o=e.y;return n<1||n>r||o<1||o>i?-1:(o-1)*i+n-1}function new_navmap(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_navmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=_objectSpread({diagonal:def.nav.diagonal},e),n=i.source,o=i.mapid,l=i.mapname,c=i.diagonal,s=i.inputtype,d=i.inputmap;if(check_required.call(this,{mapid:o}),!d)return this.error("".concat(this.name,"macro"===n?" - missing required macro payload":' - missing required input "inputmap"'));var p=e.cols;def.skipcheck.common||(check_oneword.call(this,{mapid:o}),p&&(check_integer.call(this,{cols:p},{label:"columns"}),check_positive.call(this,{cols:p},{label:"columns"})));try{var u=new Navmap(o,s,d,p);u.mapname=l,u.diagonal=c}catch(e){return console.error("".concat(this.name,' - failed to create Navmap object for map "').concat(o,'" (new_navmap)')),this.error(e)}}function new_navtile(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_navtile"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.tileid,n=e.tilename,o=e.tiletype,l=e.tilehtml;check_required.call(this,{tileid:i}),check_required.call(this,{tiletype:o});try{var c=get_navtile(i);for(var s in n&&(c.tilename=n),o&&(c.tiletype=o),l){if(!def.skipcheck.unused&&void 0===l[s])return this.error("".concat(this.name,' - empty html element / macro payload for tileid "').concat(i,'" on displayid "').concat(s,'"'));c.tilehtml[s]=l[s]}}catch(e){return console.error("".concat(this.name,' - failed to create new tile definition for "').concat(i,'" (new_navtile)')),this.error(e)}}function new_navdisplay(e){var t,a,r,i;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_navdisplay"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var n=e.mapid,o=e.rows_view,l=e.cols_view,c=e.x0,s=e.y0,d=e.entityid_view,p=null!==(i=e.displayid)&&void 0!==i?i:n;if(check_required.call(this,{mapid:n}),!def.skipcheck.clobbering&&get_navdisplay(n,p))return this.error("".concat(this.name,' - display with id "').concat(p,'" already exists for map "').concat(n,'"'));def.skipcheck.common||(check_extant.call(this,{mapid:n}),check_oneword.call(this,{mapid:n}),check_oneword.call(this,{displayid:p}),(o||l)&&(check_integer.call(this,{cols_view:l},{label:"view columns"}),check_integer.call(this,{rows_view:o},{label:"view rows"}),check_positive.call(this,{cols_view:l},{label:"view columns"}),check_positive.call(this,{rows_view:o},{label:"view rows"})),d&&(check_extant.call(this,{entityid:entityid},{label:"id of entity to track"}),check_oneword.call(this,{entityid:entityid},{label:"id of entity to track"})));var u=get_navmap(n),v=u.cols,h=u.rows;try{var f,y,m=get_naventity(d),g=Math.clamp(1,v,null!==(f=null!=l?l:o)&&void 0!==f?f:v),_=Math.clamp(1,h,null!==(y=null!=o?o:l)&&void 0!==y?y:h),b=void 0!==c?Math.clamp(1,v-l+1,c):void 0!==m?Math.clamp(1,v-l+1,m.x-Math.floor(l/2)):1,w=void 0!==s?Math.clamp(1,h-o+1,s):void 0!==m?Math.clamp(1,h-o+1,null!=s?s:m.y-Math.floor(o/2)):1;navdisplays[p]={displayid:p,mapid:n,entityid_view:d,cols_view:g,rows_view:_,x0:b,y0:w}}catch(e){console.error("".concat(this.name," - failed to create or retrieve display box data (new_navdisplay)")),console.error(e)}}function print_navdisplay(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"print_navdisplay"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.displayid;check_required.call(this,{displayid:i}),void 0!==get_navmap(i)&&void 0===get_navdisplay(i)&&new_navdisplay.call(this,{mapid:i});var n=get_navdisplay(i),o=$(document.createElement("div"));try{var l=n.mapid,c=n.entityid_view,s=n.x0,d=n.y0,p=n.cols_view,u=n.rows_view;o.addClass("Navmap-display").attr("data-mapid",l).attr("data-displayid",i).attr("data-root-x0",s).attr("data-root-y0",d).attr("data-root-cols_view",p).attr("data-root-rows_view",u).attr("data-entity",c)}catch(e){console.error("".concat(this.name," - failed to intialize $display jQuery object")),console.error(e)}update_navdisplay.call(this,{displayid:i,$display:o}),o.appendTo(this.output);try{setTimeout((function(){o.on(":update_navdisplay",(function(e,t){$(this).children().remove(),update_navdisplay.call(this,{displayid:i,$display:o,delta:t})}))}),40)}catch(e){console.error("".concat(this.name," - failed to assign $display listeners")),console.error(e)}}function update_navdisplay(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"update_navdisplay"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.displayid,n=e.$display,o=e.delta;check_required.call(this,{displayid:i});var l=get_navdisplay(i),c=l.mapid,s=(l.entityid_view,get_navmap(c)),d=s.arr,p=(s.entities,s.rows,s.cols);update_navbox.call(this,{displayid:i,delta:o});var u=get_navbox(i),v=u.x0,h=u.y0,f=u.cols_view,y=u.rows_view;n.css({"grid-template-columns":"repeat(".concat(f,", 1fr)"),"grid-template-rows":"repeat(".concat(y,", 1fr)")});var m=[];try{for(var g=convert_xy2i({x:v,y:h},c),_=1;_<=y;_++)for(var b=1;b<=f;b++){var w=g+(b-1)+p*(_-1),k=d[w],S=print_navtile.call(this,{displayid:i,tileid:k,col:b,row:_});S.appendTo(n);var j=convert_i2xy(w,c),O=j.x,x=j.y;S.attr("data-x",O).attr("data-y",x),m.push(w)}}catch(e){console.error("".concat(this.name,' - failed to print tiles for map display "').concat(i,'" (refresh_navdisplay)')),console.error(e)}}Macro.add(["newnavmap","new_navmap"],{tags:null,handler:function(){debug.log("macro","begin - ".concat(this.name," handler"));var e=create_argObj.call(this,{id:this.name,args_in:this.args,template:{mapid:{type:"string",alias:"map"},mapname:{type:"string",alias:"name"},cols:{type:"number",alias:"columns"},diagonal:{type:"boolean"}}});e.inputtype="array",e.inputmap=this.payload[0].contents.trim().split(/[\s\n]+/g),e.source="macro",debug.log("macro","end - ".concat(this.name," handler")),new_navmap.call(this,e)}}),Macro.add(["newnavtile","new_navtile"],{tags:["displayhtml","display_html"],handler:function(){debug.log("macro","begin - ".concat(this.name," handler"));var e=create_argObj.call(this,{id:this.name,args_in:this.args,template:{tileid:{type:"string",alias:"tile"},tilename:{type:"string",alias:"name"},tiletype:{type:"string",alias:"type"}}});if(e.tilehtml={},e.tilehtml.default=this.payload[0].contents.trim(),this.payload.length>1)for(var t=1;t<this.payload.length;t++){var a,r,i=create_argObj.call(this,{id:this.name,args_in:this.payload[t].args,template:{displayid:{type:"string",alias:"display"}}}).displayid;if(!def.skipcheck.clobbering&&void 0!==e.tilehtml[i])return this.error("".concat(this.name,' - clobbering, child tag with display id "').concat(i,'" already used in this macro call'));e.tilehtml[i]=null===(a=this.payload[t])||void 0===a||null===(r=a.contents)||void 0===r?void 0:r.trim()}e.source="macro",debug.log("macro","end - ".concat(this.name," handler")),new_navtile.call(this,e)}}),Macro.add(["new_navdisplay","newnavdisplay"],{handler:function(){debug.log("macro","begin - ".concat(this.name," handler"));var e=create_argObj.call(this,{id:this.name,args_in:this.args,template:{mapid:{type:"string",alias:"map"},displayid:{type:"string",alias:"display"},cols_view:{type:"number",alias:["viewcolumns","cols","columns"]},rows_view:{type:"number",alias:["viewrows","rows"]},x0:{type:"number"},y0:{type:"number"},entityid_view:{type:"string",alias:["viewentity","entityid"]}}});e.source="macro",debug.log("macro","end - ".concat(this.name," handler")),new_navdisplay.call(this,e)}}),Macro.add(["print_navdisplay","printnavdisplay"],{handler:function(){debug.log("macro","start - ".concat(this.name," handler"));var e=create_argObj.call(this,{id:this.name,args_in:this.args,template:{displayid:{type:"string",alias:"display"}}});e.source="macro",debug.log("macro","end - ".concat(this.name," handler")),print_navdisplay.call(this,e)}});