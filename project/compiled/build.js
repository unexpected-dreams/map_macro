"use strict";var _setup,_config$setupname,_setup$_config$setupn;function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){_defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,l=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){l=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(l)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,a){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return a}var _add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];for(var i=0,n=a;i<n.length;i++){var o=n[i];this.add(o)}}catch(e){console.error("failed to create TypeSet object")}}return _createClass(e,[{key:"print",get:function(){if(this.label)return this.label;var t,a=[],r=_createForOfIteratorHelper(this.any);try{for(r.s();!(t=r.n()).done;){var i=t.value;"undefined"===i||"null"===i?a.push("".concat(i)):a.push("any '".concat(i,"'"))}}catch(e){r.e(e)}finally{r.f()}var n,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(n=o.n()).done;){var l=n.value;a.push("exactly the ".concat(e.id(l)," '").concat(l,"'"))}}catch(e){o.e(e)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(t){try{if("array"===e.id(t))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t);else if("object"===e.id(t))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,t);else if("string"==typeof t)_classPrivateMethodGet(this,_push,_push2).call(this,t,"any");else{var a='TypeSet - invalid input "'.concat(t,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(t," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(t){var a=!1;if("object"!==e.id(t)||1!==Object.keys(t).length||"any"!==Object.keys(t)[0]&&"exact"!==Object.keys(t)[0]&&"other"!==Object.keys(t)[0])for(var r=0,i=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));r<i.length;r++){if(t===i[r]){a=!0;break}}else for(var n=0,o=["any","exact","other"];n<o.length;n++){var l,c=o[n],d=Object.values(t)[0],s=_createForOfIteratorHelper(this[c]);try{for(s.s();!(l=s.n()).done;){if(d===l.value){a=!0;break}}}catch(e){s.e(e)}finally{s.f()}if(a=!0)break}return a}},{key:"accepts",value:function(t){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var r,i=_createForOfIteratorHelper(this.any);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(e.id(t)===n){a=!0;break}}}catch(e){i.e(e)}finally{i.f()}}if(!a){var o,l=_createForOfIteratorHelper(this.exact);try{for(l.s();!(o=l.n()).done;){if(t===o.value){a=!0;break}}}catch(e){l.e(e)}finally{l.f()}}return a}}],[{key:"validate",value:function(t){if(!e.valid.includes(t)){var a='TypeSet - "'.concat(t,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(e){return"object"===_typeof(e)&&!!e["this is a TypeSet"]}}]),e}();function _add_arr2(e,t){if(0===e.length){console.error("TypeSet - array input cannot be empty")}var a,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var i=a.value;t?_classPrivateMethodGet(this,_push,_push2).call(this,i,t):this.add(i)}}catch(e){r.e(e)}finally{r.f()}}function _add_obj2(e){for(var t in e)if("any"!==t&&"exact"!==t&&"other"!==t||"array"!==TypeSet.id(e[t]))if("any"===t||"exact"===t||"other"===t)_classPrivateMethodGet(this,_push,_push2).call(this,e[t],t);else if("label"===t){if("string"!==TypeSet.id(e[t])){var a='TypeSet - input for label "'.concat(e[t],"\" ('").concat(TypeSet.id(e[t]),"') should be a string instead");console.error(a)}this.label=e[t]}else{var r="TypeSet - unexpected object key ".concat(t);console.error(r)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e[t],t)}function _push2(e,t){try{if(this[t].includes(e))return;if("any"===t)TypeSet.validate(e),this.any.push(e);else if("exact"===t)this.exact.push(e);else if("any"===e)this.other.push(e);else{var a="TypeSet - unexpected input for ".concat(t,'-type "').concat(e,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(t,"-type to TypeSet at arg ").concat(e)),console.error(a)}}Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{argObj:!1,proxy:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}};function validate_tags(e){var t=this;if(!e){var a="validate_tags missing required template";return this.error("validate_tags missing required template")}var r=e.id;if(!r){return this.error("validate_tags missing required id")}try{var i,n=_createForOfIteratorHelper(Object.keys(e).filter((function(e){return"id"!==e})));try{var o=function(){var a=i.value;if(!t.self.tags.includes(a)){var n="".concat(r,' tag validation failed, missing tag "').concat(a,'" in macro definition');return{v:t.error(n)}}if(e[a].unique&&t.payload.filter((function(e){return e.name===a})).length>1){var o="".concat(a," - macro only accepts one ").concat(a," tag");return{v:t.error(o)}}if(e[a].required&&0===t.payload.filter((function(e){return e.name===a})).length){var l="".concat(t.name," - ").concat(a," tag is required for macro");return{v:t.error(l)}}};for(n.s();!(i=n.n()).done;){var l=o();if("object"===_typeof(l))return l.v}}catch(e){n.e(e)}finally{n.f()}}catch(a){console.error('failed to validate macro child tags for "'.concat(r,'"')),console.error(a)}}function validate_required(e){var t,a=e.idl,r=Object.keys(e).filter((function(e){return"id"!==e})),i=_createForOfIteratorHelper(r);try{for(i.s();!(t=i.n()).done;){var n=t.value;if("undefined"===TypeSet.id(e[n])){var o="".concat(a,' - missing required input "').concat(n,'"');return this.error(o)}}}catch(e){i.e(e)}finally{i.f()}}function validate_args(e){if(!e){var t="validate_args missing required template argument";return this.error("validate_args missing required template argument")}var a=e.id;if(!a){return this.error("validate_args missing required id")}try{var r,i=_createForOfIteratorHelper(Object.keys(e).filter((function(e){return"id"!==e})));try{for(i.s();!(r=i.n()).done;){var n=r.value;if("array"===TypeSet.id(e[n].val)){var o,l=_createForOfIteratorHelper(e[n].val);try{for(l.s();!(o=l.n()).done;){var c=o.value;validatation_errors.call(this,{key:n,val:c,template:e})}}catch(e){l.e(e)}finally{l.f()}}else validatation_errors.call(this,{key:n,val:e[n].val,template:e})}}catch(e){i.e(e)}finally{i.f()}}catch(t){console.error('failed to validate macro arguments for "'.concat(a,'"')),console.error(t)}}function validatation_errors(e){var t=e.key,a=e.val,r=e.template,i=r.id;try{if(r[t].extant){if("mapid"===t&&!get_map(a)){var n="".concat(i,' - no map with id "').concat(a,'" found');return this.error(n)}if("tileid"===t&&!get_tile(r.mapid.val,a)){var o="".concat(i,' - no tile with id "').concat(a,'" in map ').concat(r.mapid.val," found");return this.error(o)}if("residentid"===t&&!get_resident(r.mapid.val,r.residenttype.val,a)){var l="player"===a?"".concat(i,' - no player found residing on map "').concat(r.mapid.val,'", use <<addplayer>> to add one'):"".concat(i,' - no "').concat(a,'" was found residing on map "').concat(r.mapid.val,'"');return this.error(l)}}if(r[t].integer&&!Number.isInteger(a)){var c="".concat(i,' - input "').concat(t,'" must be an integer');return this.error(c)}if(r[t].positive&&a<=0){var d="".concat(i,' - input "').concat(t,'" must be greater than zero');return this.error(d)}if(r[t].oneword&&a.includes(" ")){var s="".concat(i,' - input "').concat(t,'" must be one word, no spaces');return this.error(s)}if(r[t].cssunit){for(var p=!1,u=0,h=["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvw","lvh","dvw","dvh","%"];u<h.length;u++){if(a===h[u]){p=!0;break}}if(!p){var f="".concat(i,' - input "').concat(a,'" for "').concat(t,'" is not a valid css unit');return this.error(f)}}}catch(n){console.error('failed to validate macro arguments on key "'.concat(t,'" with value "').concat(a,'" for "').concat(i,'"')),console.error(n)}}function validate_xy(e){if(!e){var t="validate_xy missing required template argument";return this.error(t)}var a=e.id,r=e.mapid,i=e.residentid,n=e.x,o=e.y;if(!a){t="validate_xy missing required id";return this.error(t)}try{var l=get_map(r),c=l.arr,d=l.columns;if(n.upper>d){var s="".concat(a," - ").concat(n.label,' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(s)}if(o.val>c.length/d){var p="".concat(a," - ").concat(o.label,' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(p)}if(n.lower<1){var u="".concat(a," - ").concat(n.label,' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(u)}if(o.lower<1){var h="".concat(a," - ").concat(o.label,' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(h)}}catch(t){console.error('failed to validate coordinates { "'.concat(n.label,'" : "').concat(n.val,'", "').concat(o.label,'" : "').concat(o.val,'" } on "').concat(r,'" for "').concat(a,'"')),console.error(t)}}function create_argObj(e,t,a){if(!e)throw new Error("create_argObj input missing, arguments");var r=clone(e);if(!t)throw new Error("create_argObj input missing, template");var i=clone(t),n=i.id;if(!n)throw new Error("create_argObj template id missing");var o=Object.keys(i).filter((function(e){return"id"!==e}));if(!o.length)throw new Error("create_argObj template cannot be empty");var l=o.filter((function(e){return i[e].infinite}));if(l.length>1)throw new Error("create_argObj template cannot have more than one infinite key");if(l[0]&&l[0]!==o[o.length-1])throw new Error("create_argObj template infinite key must be last");try{var c,d={},s=_createForOfIteratorHelper(o);try{for(s.s();!(c=s.n()).done;){var p=c.value;if(d[p]=p,i[p].alias)if("array"===TypeSet.id(i[p].alias)){var u,h=_createForOfIteratorHelper(i[p].alias);try{for(h.s();!(u=h.n()).done;){d[u.value]=p}}catch(e){h.e(e)}finally{h.f()}}else d[i[p].alias]=p}}catch(e){s.e(e)}finally{s.f()}for(var f={},m={id:n,args:r,template:i,keys:o,argObj:f,alias:d,options:a,splice:0};m.args.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",f),m.splice=0;var y=m.args[0];try{l[0]&&f[l[0]]&&argObj_infinite.call(this,m),!m.splice&&y.isLink&&argObj_markup.call(this,m),!m.splice&&o.includes(d[y])&&argObj_kvp.call(this,m),m.splice||"object"!==TypeSet.id(y)||argObj_obj.call(this,m);var v=_objectSpread({strict:!1},m.options).strict;if(m.splice||v||argObj_lazy.call(this,m),!m.splice){var g="".concat(n,' - unexpected input "').concat(y,'", is not a key name and did not match any valid types');return console.error(f),this.error(g)}m.args.splice(0,m.splice)}catch(g){console.error('failed to create argObj at "'.concat(y,'"')),console.error(g)}}return f}catch(g){console.error('failed to parse macro arguments for "'.concat(n,'"')),console.error(g)}}function argObj_infinite(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=e.keys,n=e.argObj,o=(e.alias,e.options,a[0]),l=i.filter((function(e){return r[e].infinite}))[0],c=new TypeSet(r[l].type);if(!c.accepts(o)){var d="".concat(t,' - "').concat(o,'" is an invalid type for "').concat(l,"\" ('").concat(TypeSet.id(o),"'), expected ").concat(c.print);return this.error(d)}return"array"!==TypeSet.id(n[l])&&(n[l]=[n[l]]),n[l].includes(o)?(e.splice=1,e):(n[l]="array"===TypeSet.id(o)?n[l].concat(o):n[l].concat([o]),e.splice=1,e)}function argObj_markup(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args,r=(e.template,e.keys),i=e.argObj,n=(e.alias,e.options,a[0]);if(!r.includes("passage")){var o="".concat(t," - macro does not accept [[markup]]");return this.error(o)}return i.linktext=n.text,i.passage=n.link,e.splice=1,e}function argObj_kvp(e){debug.log("argObj","entered kvp"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=(e.keys,e.argObj),n=e.alias,o=(e.options,a[0]),l=a[1];if("undefined"===TypeSet.id(l)){var c="".concat(t,' - no input was found for argument "').concat(o,'"');return this.error(c)}var d=new TypeSet(r[n[o]].type);if(!d.accepts(l)){var s="".concat(t,' - "').concat(l,"\" is an invalid type ('").concat(TypeSet.id(l),"') for \"").concat(o,'", expected ').concat(d.print);return this.error(s)}return i[n[o]]=l,e.splice=2,e}function argObj_obj(e){debug.log("argObj","entered object parser"),debug.log("argObj",e);var t=e.id,a=e.args,r=e.template,i=e.keys,n=e.argObj,o=e.alias,l=(e.options,a[0]);for(var c in l)if(i.includes(o[c])){var d=new TypeSet(r[o[c]].type);if(!d.accepts(l[c])){var s="".concat(t,' - "').concat(l[c],'" is an invalid type for "').concat(c,"\" ('").concat(TypeSet.id(l[c]),"'), expected ").concat(d.print);return this.error(s)}n[o[c]]=l[c],e.splice=1}return e}function argObj_lazy(e){debug.log("argObj","entered lazy matcher"),debug.log("argObj",e);e.id;var t=e.args,a=e.template,r=e.keys,i=e.argObj,n=(e.alias,e.options,t[0]),o=r.filter((function(e){return!Object.keys(i).includes(e)}));if(!o.length)return e;var l,c=_createForOfIteratorHelper(o);try{for(c.s();!(l=c.n()).done;){var d=l.value;if(new TypeSet(a[d].type).accepts(n)){i[d]=n,e.splice=1;break}}}catch(e){c.e(e)}finally{c.f()}return e}var config={map:{},tile:{},wall:{},floor:{},nav:{},player:{},building:{},object:{},npc:{},skipcheck:{},noupdate:{},sizingmode:"auto"};config.map.width=20,config.map.height=15,config.map.unit="rem",config.nav.diagonal=!1,config.nav.width=15,config.nav.height=12,config.nav.unit="rem",config.nav.sizingoff=!1,config.wall.id=".",config.wall.name="wall",config.wall.element=null,config.floor.id="x",config.floor.name="floor",config.floor.element=null,config.player.iswall=!0,config.building.iswall=!0,config.object.iswall=!1,config.npc.iswall=!1,config.tile.width=2,config.tile.height=2,config.skipcheck.xybounds=!1,config.skipcheck.unused=!1,config.player.spanx=1,config.player.spany=1,config.building.spanx=1,config.building.spany=1,config.object.spanx=1,config.object.spany=1,config.npc.spanx=1,config.npc.spany=1,config.wall.type="wall",config.floor.type="floor",config.noclip=!1,config.collisionerror=!1,config.noupdate.traversible=!1,config.noupdate.positions=!1,config.allowclobbering=!1,config.skipcheck.sensible=!1,config.skipcheck.typing=!1,config.disableglobal=!1,config.globalname="navmap",config.setupname="@navmap",null!==(_setup$_config$setupn=(_setup=setup)[_config$setupname=config.setupname])&&void 0!==_setup$_config$setupn||(_setup[_config$setupname]={});var def=new Proxy(config,get_controller(setup[config.setupname]));function get_controller(e){return{get:function(t,a){return debug.log("proxy","entered proxy"),void 0===e||void 0===e[a]?(debug.log("entered undefined"),t[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(e[a])||e[a].isproxy||(debug.log("proxy","created proxy"),e[a]=new Proxy(config[a],get_controller(e[a])),e[a].isproxy=!0),e[a])}}}def.disableglobal||Object.defineProperty(window,def.globalname,{value:{getmap:function(){return get_map.apply(void 0,arguments)},gettile:function(){return get_tile.apply(void 0,arguments)},getresident:function(){return get_resident.apply(void 0,arguments)},newmap:function(e){return Macro.get("newmap").handlerJS(e)},maptile:function(e){return Macro.get("maptile").handlerJS(e)},newresident:function(e){return Macro.get("newresident").handlerJS(e)},deleteresident:function(e){return Macro.get("deleteresident").handlerJS(e)},moveresident:function(e){return Macro.get("moveresident").handlerJS(e)},mapcalculate:function(e){var t="object"===_typeof(e)?e:{mapid:e};Macro.get("mapcalculate").handlerJS(t)},createmap:function(e){return Macro.get("showmap").handlerJS(e)},createresident:function(e){return create_resident(e)},createtile:function(e){return create_tile(e)}}});var cssunit={exact:["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvh","dvw","dvh","%"],label:"any valid CSS unit"};function convert_i2xy(e,t){var a=e%t+1;return{x:a,y:(e-a+1)/t+1}}function convert_xy2i(e,t){var a=e.x;return(e.y-1)*t+a-1}function get_map(e){var t,a=null!==(t=null==e?void 0:e.mapid)&&void 0!==t?t:e;return Macro.get("newmap").maps["map_"+String(a)]}function get_tile(){var e,t,a,r,i=null!==(e=null===(t=arguments.length<=0?void 0:arguments[0])||void 0===t?void 0:t.mapid)&&void 0!==e?e:arguments.length<=0?void 0:arguments[0],n=null!==(a=null===(r=arguments.length<=0?void 0:arguments[0])||void 0===r?void 0:r.tileid)&&void 0!==a?a:arguments.length<=1?void 0:arguments[1],o=get_map(i);return o.tiles["tile_"+String(n)]}function get_resident(){var e,t,a,r,i,n,o=null!==(e=null===(t=arguments.length<=0?void 0:arguments[0])||void 0===t?void 0:t.mapid)&&void 0!==e?e:arguments.length<=0?void 0:arguments[0],l=null!==(a=null===(r=arguments.length<=0?void 0:arguments[0])||void 0===r?void 0:r.residenttype)&&void 0!==a?a:arguments.length<=1?void 0:arguments[1],c=null!==(i=null===(n=arguments.length<=0?void 0:arguments[0])||void 0===n?void 0:n.residentid)&&void 0!==i?i:arguments.length<=2?void 0:arguments[2],d=get_map(o);return d.residents[String(l)+"_"+String(c)]}function create_tile(e){var t=e.id,a=e.mapid,r=e.tile,i=e.i,n=r.tilesn,o=r.tileid,l=r.tilename,c=r.tiletype,d=r.tileelement,s=get_map(a).columns;try{var p=convert_i2xy(i,s),u=p.x,h=p.y,f=$(document.createElement("div"));return f.addClass("macro-showmap-tile").addClass(c).attr("title","tilename").attr("data-sn",n).attr("data-id",o).attr("data-name",l).attr("data-type",c).css({"grid-column":u,"grid-row":h}).wiki(d||o),f}catch(e){console.error('failed to create tile element at "'.concat(i,'" on "').concat(a,'" for ').concat(t)),console.error(e)}}function create_resident(e){var t=e.id,a=e.mapid,r=e.resident,i=r.residentsn,n=r.residentid,o=r.residenttype,l=r.residentname,c=(r.x,r.y,r.width,r.height,r.residentelement);try{var d=$(document.createElement("div"));return d.addClass("macro-showmap-resident macro-showmap-".concat(o)).addClass(o).attr("data-sn",i).attr("data-id",n).attr("data-type",o).attr("data-name",l).wiki(c||l),d}catch(e){console.error("failed to create ".concat(o,' element "').concat(n,'" on "').concat(a,'" for "').concat(t,'"')),console.error(e)}}function place_resident(e){var t=e.mapid,a=e.residenttype,r=e.residentid,i=window.getComputedStyle(document.querySelector(".macro-showmap-tile")).width,n=window.getComputedStyle(document.querySelector(".macro-showmap-tile")).height,o=get_map(t).residents;if(r){var l=get_resident(t,a,r),c=l.residentsn,d=l.x,s=l.y,p=l.spanx,u=l.spany;$('[data-sn="'.concat(c,'"]')).css({top:"calc(".concat(n," * ").concat(s-1,")"),left:"calc(".concat(i,"  * ").concat(d-1,")"),height:"calc(".concat(n," * ").concat(u,")"),width:"calc(".concat(i,"  * ").concat(p,")")})}else for(var h in o){var f=o[h],m=f.residentsn,y=f.x,v=f.y,g=f.spanx,b=f.spany;$('[data-sn="'.concat(m,'"]')).css({top:"calc(".concat(n," * ").concat(v-1,")"),left:"calc(".concat(i,"  * ").concat(y-1,")"),height:"calc(".concat(n," * ").concat(b,")"),width:"calc(".concat(i,"  * ").concat(g,")")})}}function create_direction(e){var t=e.mapid,a=e.direction,r=get_map(t),i=r.arr,n=r.columns,o=r.traversible,l=a.id,c=a.name,d=a.deltax,s=a.deltay,p=get_resident(t,"player","player");try{var u=convert_xy2i({x:p.x+d,y:p.y+s},n),h=get_tile(t,i[u]),f=h.tileid,m=h.tilename,y=(h.tileelement,!o[u]),v=$(document.createElement("div"));return v.addClass("macro-shownav-direction macro-shownav-".concat(l)).attr("data-id",l).attr("data-direction",c).attr("data-disabled",y).attr("data-mapid",t).attr("data-tileid",f),y||v.wiki(m||f),v}catch(e){console.error('failed to create nav direction "'.concat(c,'" for "').concat(t,'"')),console.error(e)}}Macro.add("newmap",{tags:[null],maps:{},handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"id"},mapname:{type:"string",alias:"name"},columns:{type:"number"},diagonal:{type:"boolean"},mergetiles:{type:"boolean"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r,i;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"newmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var n=_objectSpread({diagonal:def.nav.diagonal,mergetiles:def.mergetiles,inputtype:"macro / unspecified"},e),o=n.mapid,l=n.diagonal,c=n.mergetiles,d=n.inputtype,s=n.inputmap;validate_required.call(this,{id:this.name,mapid:o});var p=null!==(i=e.mapname)&&void 0!==i?i:e.mapid;try{"array"===d?e.arr=s:"2D array"===d?(e.columns=s[0].length,e.arr=s.flat()):e.arr=this.payload[0].contents.trim().split(/\s+/g)}catch(m){console.error('failed to parse inputmap for inputtype "'.concat(d,'"')),console.error(s),console.error(m)}var u=e.arr,h=e.columns;validate_required.call(this,{id:this.name,columns:h,inputmap:u}),def.skipcheck.sensible||validate_args.call(this,{id:this.name,mapid:{val:o,oneword:!0},columns:{val:h,integer:!0,positive:!0}});var f=window.crypto.randomUUID();try{if(!def.allowclobbering&&get_map(o)){var m="".concat(this.name,' - map "').concat(o,'" already exists');return this.error(m)}if(u.length%h){var y="".concat(this.name," - input map is not rectangular");return this.error(y)}var v,g={},b=_createForOfIteratorHelper(new Set(u));try{for(b.s();!(v=b.n()).done;){var w=v.value;g["tile_"+String(w)]={mapid:o,tilesn:window.crypto.randomUUID(),tileid:String(w),tilename:w,tiletype:def.floor.type,tileelement:w}}}catch(e){b.e(e)}finally{b.f()}g["tile_"+String(def.wall.id)]={mapid:o,tilesn:window.crypto.randomUUID(),tileid:String(def.wall.id),tilename:def.wall.name,tiletype:def.wall.type,tileelement:def.wall.element},g["tile_"+String(def.floor.id)]={mapid:o,tilesn:window.crypto.randomUUID(),tileid:String(def.floor.id),tilename:def.floor.name,tiletype:def.floor.type,tileelement:def.floor.element},Macro.get("newmap").maps["map_"+String(o)]={mapsn:f,mapid:String(o),mapname:p,arr:u,columns:h,rows:u.length/h,diagonal:l,mergetiles:c,tiles:g,residents:{},traversible:new Array(u.length).fill(!1)},Macro.get("mapcalculate").handlerJS.call(this,e)}catch(m){console.error('failed to create newmap navmap object for "'.concat(o,'"')),console.error(m)}}}),Macro.add("maptile",{tags:["tilename","tiletype","tileelement"],handler:function(){var e=this;def.skipcheck.unused||validate_tags.call(this,{id:this.name,tilename:{unique:!0},tiletype:{unique:!0},tileelement:{unique:!0}});var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},tileid:{type:["string","array"],infinite:!0,alias:["tile","tiles"]}});try{for(var a=function(){var a=i[r],n=e.payload.filter((function(e){return e.name===a}))[0];if(n){if(!def.skipcheck.unused){if(1!==n.args.length){var o="".concat(a," - child tag takes one string argument");return{v:e.error(o)}}if(n.contents.trim()){var l="".concat(a," - child tag doesn't take input in its payload");return{v:e.error(l)}}}if(!def.skipcheck.typing&&"string"!==TypeSet.id(n.args[0])){var c="".concat(a," - invalid type for ").concat(a," ('").concat(TypeSet.id(n.args[0]),"'), expected any 'string'");return{v:e.error(c)}}t[a]=n.args[0]}},r=0,i=["tilename","tiletype"];r<i.length;r++){var n=a();if("object"===_typeof(n))return n.v}var o=this.payload.filter((function(e){return"tileelement"===e.name}))[0];if(o&&!def.skipcheck.unused){if(o.args.length>0){var l="tileelement - child tag doesn't take arguments";return this.error("tileelement - child tag doesn't take arguments")}var c=o.contents.trim();if(!c){return this.error("tileelement - child tag payload is required")}t.tileelement=c}}catch(l){console.error("failed to process ".concat(this.name," payloads for ").concat(t.mapid)),console.error(l)}this.self.handlerJS.call(this,t)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"maptile"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.tilename,o=e.tiletype,l=e.tileelement;validate_required.call(this,{id:this.name,mapid:i,tileid:e.tileid});var c="array"===TypeSet.id(e.tileid)?e.tileid:[e.tileid];def.skipcheck.sensible||(validate_args.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},tileid:{val:c,oneword:!0,extant:!0}}),n&&validate_args.call(this,{id:"tilename",tilename:{val:n,oneword:!0}}),o&&validate_args.call(this,{id:"tiletype",tiletype:{val:o,oneword:!0}}));try{var d,s=_createForOfIteratorHelper(c);try{for(s.s();!(d=s.n()).done;){var p=get_tile(i,d.value);n&&(p.tilename=n),o&&(p.tiletype=o),l&&(p.tileelement=l)}}catch(e){s.e(e)}finally{s.f()}}catch(e){console.error('failed to process "'.concat(c,'" maptile definition for "').concat(i,'"')),console.error(e)}}}),Macro.add("showmap",{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},sizingmode:{type:[{exact:"auto"},{exact:"height"},{exact:"width"},{exact:"tile"},{exact:"off"}],alias:"mode"},mapwidth:{type:"number"},mapheight:{type:"number"},tilewidth:{type:"number"},tileheight:{type:"number"},unit:{type:cssunit}});this.self.handlerJS.call(this,e).appendTo(this.output)},handlerJS:function(e){var t,a,r=this;null!==(t=this.name)&&void 0!==t||(this.name="showmap"),null!==(a=this.error)&&void 0!==a||(this.error=function(e){throw new Error(e)});var i=_objectSpread({sizingmode:def.sizingmode},e),n=i.mapid,o=i.sizingmode;if(validate_required.call(this,{mapid:n}),!def.skipcheck.unused){if("height"===o&&e.mapwidth){var l="".concat(this.name,' - map width can\'t be specified when map sizing mode is set to "height"');return this.error(l)}if("width"===o&&e.mapheight){var c="".concat(this.name,' - map height can\'t be specified when map sizing mode is set to "with"');return this.error(c)}if("tile"===o&&(e.mapwidth||e.mapheight)){var d="".concat(this.name,' - map height and width can\'t be specified when map sizing mode is set to "tile"');return this.error(d)}if("off"===o&&(e.mapwidth||e.mapheight||e.unit)){var s="".concat(this.name,' - map height, width, and units can\'t be specified when sizing mode is set to "off"');return this.error(s)}}var p=_objectSpread({mapheight:def.map.height,mapwidth:def.map.width,tileheight:def.tile.height,tilewidth:def.tile.width,unit:def.map.unit},e),u=p.mapheight,h=p.mapwidth,f=p.tileheight,m=p.tilewidth,y=p.unit;def.skipcheck.sensible||validate_args.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},mapwidth:{val:h,positive:!0},mapheight:{val:u,positive:!0},tilewidth:{val:m,positive:!0},tileheight:{val:f,positive:!0}});var v=get_map(n),g=v.mapsn,b=v.mapname,w=v.columns,_=v.rows,x=v.arr,S=v.residents;try{Macro.get("mapcalculate").handlerJS.call(this,e);var j,k,O,T=$(document.createElement("div"));T.addClass("macro-".concat(this.name,"-map")).attr("data-sn",g).attr("data-id",n).attr("data-name",b).attr("data-columns",w),"height"===o?(k=(j=u/_)*m/f,O="height"):"width"===o?(j=(k=h/w)*f/m,O="width"):"auto"===o?h/u>w*m/(_*f)?(k=(j=u/_)*m/f,O="auto-height"):(j=(k=h/w)*f/m,O="auto-width"):"tile"===o&&(k=m,j=f,O="tile"),O&&T.attr("data-sizing",O).attr("data-tilewidth",k).attr("data-tileheight",j).attr("data-unit",y).css({"--tilewidth":String(k)+y,"--tileheight":String(j)+y});for(var q=0;q<x.length;q++){var I=x[q];create_tile.call(this,{id:this.name,mapid:n,tile:get_tile(n,I),i:q}).appendTo(T)}for(var M in S){create_resident.call(this,{id:this.name,mapid:n,resident:S[M]}).appendTo(T)}return T.ready((function(){return place_resident.call(r,{mapid:n})})),T}catch(l){console.error('failed to create showmap element for "'.concat(n,'"')),console.error(l)}}}),Macro.add("shownav",{tags:["navnorth","naveast","navsouth","navwest","navnorthwest","navnorthwest","navsoutheast","navsouthwest"],handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:["id","map"]},width:{type:"number"},height:{type:"number"},unit:{type:cssunit},arrowkeys:{type:"boolean"},diagonal:{type:"boolean"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r,i,n,o=null!==(t=null!==(a=this.name)&&void 0!==a?a:e.id)&&void 0!==t?t:"shownav";null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var l=_objectSpread({width:def.nav.width,height:def.nav.height,unit:def.nav.unit},e),c=l.mapid,d=l.width,s=l.height,p=l.unit,u=(l.arrowkeys,get_map(c)),h=(u.arr,null!==(i=null!==(n=e.diagonal)&&void 0!==n?n:u.diagonal)&&void 0!==i?i:def.nav.diagonal);def.skipcheck.sensible||validate_args.call(this,{id:o,mapid:{val:c,oneword:!0,extant:!0},width:{val:d,positive:!0},height:{val:s,positive:!0}});try{var f=window.crypto.randomUUID(),m=$(document.createElement("div"));m.addClass("macro-".concat(o,"-nav")).attr("data-mapid",c).attr("data-sn",f).css({"--height":String(s)+p,"--width":String(d)+p});var y={C:{id:"C",name:"center",deltax:0,deltay:0},N:{id:"N",name:"north",deltax:0,deltay:-1},E:{id:"E",name:"east",deltax:1,deltay:0},S:{id:"S",name:"south",deltax:0,deltay:1},W:{id:"W",name:"west",deltax:-1,deltay:0}};for(var v in h&&Object.assign(y,{NW:{id:"NW",name:"northwest",deltax:-1,deltay:-1},NE:{id:"NE",name:"northeast",deltax:1,deltay:-1},SE:{id:"SE",name:"southeast",deltax:1,deltay:1},SW:{id:"SW",name:"southwest",deltax:-1,deltay:1}}),y){create_direction.call(this,{mapid:c,direction:y[v]}).appendTo(m)}m.appendTo(this.output),setTimeout((function(){return m.on("click",(function(e){var t=$(e.target).attr("data-id");if(t&&"C"!==t&&!("true"===$(e.target).attr("data-disabled")))for(var a in Macro.get("moveresident").handlerJS.call(this,{mapid:c,residentid:"player",residenttype:"player",deltax:y[t].deltax,deltay:y[t].deltay}),m.html(""),y){create_direction.call(this,{mapid:c,direction:y[a]}).appendTo(m)}}))}),40)}catch(e){console.error("failed to create nav rose for ".concat(c)),console.error(e)}}}),Macro.add(["newresident","newplayer","newnpc","newbuilding","newobject"],{tags:null,handler:function(){var e,t,a="newplayer"===this.name?create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},residentname:{type:"string",alias:["name","playername","player"]},x:{type:"number",required:!0},y:{type:"number",required:!0},wall:{type:"boolean"}}):create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},residentid:{type:"string",alias:["id","npcid","npc","buildingid","building","objectid","object"]},residentname:{type:"string",alias:["name","npcname","buildingname","objecname"]},x:{type:"number",required:!0},y:{type:"number",required:!0},spanx:{type:"number",alias:"width"},spany:{type:"number",alias:"height"},wall:{type:"boolean"}});a.residenttype=this.name.replace("new",""),a.residentelement=null===(e=this.payload[0])||void 0===e||null===(t=e.contents)||void 0===t?void 0:t.trim(),a.source="macro",this.self.handlerJS.call(this,a)},handlerJS:function(e){var t,a,r,i,n,o,l,c=(null!==(t=null!==(a=this.name)&&void 0!==a?a:e.id)&&void 0!==t?t:e.residenttype)?"new"+e.residenttype:"newresident";(null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)}),"newplayer"===c)&&(e.residentid="player",e.residenttype="player",e.spanx=def.player.spanx,e.spany=def.player.spany,null!==(l=e.residentname)&&void 0!==l||(e.residentname="Player"));var d=e.mapid,s=e.residentelement,p=e.x,u=e.y,h=e.source,f=null!==(i=e.residentname)&&void 0!==i?i:_,m=null!==(n=e.residenttype)&&void 0!==n?n:c.replace("new",""),y=_objectSpread({spanx:def[m].spanx,spany:def[m].spany,wall:def[m].wall},e),v=y.spanx,g=y.spany,b=y.wall,w=window.crypto.randomUUID(),_=null!==(o=e.residentid)&&void 0!==o?o:w;def.skipcheck.sensible||validate_args.call(this,{id:c,mapid:{val:d,oneword:!0,extant:!0},residentid:{val:_,oneword:!0},x:{val:p,integer:!0},y:{val:u,integer:!0},spanx:{val:v,integer:!0,positive:!0},spany:{val:g,integer:!0,positive:!0}});var x=get_map(d),S=x.mapsn,j=x.residents;try{if(!s){var k="".concat(c,"macro"===h?" - macro payload required":' - "residentelement" object key required');return this.error(k)}if(!def.allowclobbering&&get_resident(d,m,_)){var O="player"===m?"".concat(c,' - player already exists in map "').concat(d,'"'):"".concat(c," - ").concat(m,' with id "').concat(_,'" already exists in map "').concat(d,'"');return this.error(O)}def.skipcheck.xybounds||validate_xy.call(this,{id:c,mapid:d,residentid:_,x:{label:"combined x position & tile width (span)",upper:p+(v-1),lower:p},y:{label:"combined y position & tile height (span)",upper:u+(g-1),lower:u}});var T={mapid:d,residentsn:w,residentid:String(_),residentname:f,residenttype:m,residentelement:s,x:p,y:u,spanx:v,spany:g,wall:b};j[m+"_"+String(_)]=T;var q=$('[data-sn="'.concat(S,'"]')).first();if(q.length>0)create_resident.call(this,{id:c,mapid:d,resident:T}).appendTo(q),place_resident.call(this,{mapid:d,residenttype:m,residentid:_}),Macro.get("mapcalculate").handlerJS.call(this,e)}catch(k){console.error("failed to add ".concat(m,' "').concat(_,'" to "').concat(d,'"')),console.error(k)}}}),Macro.add(["deleteresident","deleteplayer","deletenpc","deletebuilding","deleteobject"],{handler:function(){var e="deleteplayer"===this.name?create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"}}):create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},residentid:{type:["string","array"],required:!0,infinite:!0,alias:["id","npcid","npc","buildingid","building","objectid","object"]}});e.residenttype=this.name.replace("delete",""),this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r,i,n=(null!==(t=null!==(a=this.name)&&void 0!==a?a:e.id)&&void 0!==t?t:e.residenttype)?"delete"+e.residenttype:"deleteresident";null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)}),"deleteplayer"===n&&(e.residentid=["player"],e.residenttype="player");var o=e.mapid,l="array"===TypeSet.id(e.residentid)?e.residentid:[e.residentid],c=null!==(i=e.residenttype)&&void 0!==i?i:n.replace("delete","");if(!c||"resident"===c){var d="".concat(n," - required residenttype value missing");return this.error(d)}def.skipcheck.sensible||validate_args.call(this,{id:n,mapid:{val:o,oneword:!0,extant:!0},residenttype:{val:c},residentid:{val:l,oneword:!0,extant:!0}});var s=get_map(o).residents;try{var p,u=_createForOfIteratorHelper(l);try{for(u.s();!(p=u.n()).done;){var h=p.value,f=get_resident(o,c,h),m=clone(f.residentsn);delete s[String(c)+"_"+String(h)];var y=$('[data-sn="'.concat(m,'"]')).first();y&&(y.remove(),Macro.get("mapcalculate").handlerJS.call(this,e))}}catch(e){u.e(e)}finally{u.f()}}catch(d){console.error("failed to delete ".concat(c,' "').concat(l,'" from "').concat(o,'"')),console.error(d)}}}),Macro.add(["moveresident","moveplayer","movenpc","movebuilding","moveobject"],{handler:function(){var e="moveplayer"===this.name?create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},deltax:{type:"number",required:!0,alias:"x"},deltay:{type:"number",required:!0,alias:"y"},ignorewalls:{type:"boolean"}}):create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},residentid:{type:"string",required:!0,alias:["id","npcid","npc","buildingid","building","objectid","object"]},deltax:{type:"number",required:!0,alias:"x"},deltay:{type:"number",required:!0,alias:"y"},ignorewalls:{type:"boolean"}});e.residenttype=this.name.replace("move",""),this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r,i,n=(null!==(t=null!==(a=this.name)&&void 0!==a?a:e.id)&&void 0!==t?t:e.residenttype)?"move"+e.residenttype:"moveresident";null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)}),"moveplayer"===n&&(e.residentid="player");var o=e.mapid,l=e.residentid,c=e.deltax,d=e.deltay,s=e.ignorewalls,p=null!==(i=e.residenttype)&&void 0!==i?i:n.replace("move","");def.skipcheck.sensible||validate_args.call(this,{id:n,mapid:{val:o,oneword:!0,extant:!0},residenttype:{val:p},residentid:{val:l,oneword:!0,extant:!0},deltax:{val:c,integer:!0},deltay:{val:d,integer:!0}});var u=get_map(o),h=u.columns,f=u.traversible,m=get_resident(o,p,l),y=m.x,v=m.y,g=m.spanx,b=m.spany;try{if(def.skipcheck.xybounds||validate_xy.call(this,{id:n,mapid:o,x:{label:"combined x position, width, & delta x",upper:y+(g-1)+c,lower:y+c},y:{label:"combined y position, height, & delta y",upper:v+(b-1)+d,lower:v+d}}),!s&&!def.noclip)for(var w=0;w<g;w++)for(var _=0;_<b;_++){if(!f[convert_xy2i({x:y+w+c,y:v+_+d},h)]){if(def.collisionerror){var x="".concat(n," - collision detected for ").concat(p,' "').concat(l,'" on "').concat(o,'"');return this.error(x)}return}}m.x+=c,m.y+=d,Macro.get("mapcalculate").handlerJS.call(this,e),config.noupdate.positions||place_resident.call(this,{mapid:o,residenttype:p,residentid:l})}catch(x){console.error("failed to move ".concat(p,' "').concat(l,'" on "').concat(o,'"')),console.error(x)}}}),Macro.add("mapcalculate",{handler:function(){var e=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",required:!0,alias:"map"},coordinates:{type:["object","array"],infinite:!0,alias:"xy"}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;t=null!==(a=this.name)&&void 0!==a?a:e.id;null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n="array"===TypeSet.id(e.coordinates)?e.coordinates:"object"===TypeSet.id(e.coordinates)?[e.coordinates]:null,o=get_map(i),l=o.columns,c=o.arr,d=o.residents,s=o.traversible;try{if(n){var p,u=_createForOfIteratorHelper(n);try{for(u.s();!(p=u.n()).done;){var h=p.value;s[convert_xy2i(h,l)]=h.wall}}catch(e){u.e(e)}finally{u.f()}return}for(var f=def.wall.type,m=0;m<c.length;m++){var y=c[m];s[m]=get_tile(i,y).tiletype!==f}for(var v in d){var g=d[v],b=g.wall,w=g.x,_=g.y,x=g.spanx,S=g.spany;if(b)for(var j=0;j<x;j++)for(var k=0;k<S;k++){s[convert_xy2i({x:w+j,y:_+k},l)]=!1}}}catch(e){console.error('failed to calculate traversible indices for "'.concat(i,'"')),console.error(e)}}});