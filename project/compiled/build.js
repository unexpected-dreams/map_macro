"use strict";var _setup,_config$setupname,_setup$_config$setupn,_State$variables,_config$Statename,_State$variables$_con,_State$variables$conf,_State$variables$conf2,_State$variables$conf3,_State$variables$conf4;function _readOnlyError(t){throw new TypeError('"'+t+'" is read-only')}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach((function(e){_defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _createForOfIteratorHelper(t,e){var a="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!a){if(Array.isArray(t)||(a=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){a&&(t=a);var r=0,n=function(){};return{s:n,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,c=!1;return{s:function(){a=a.call(t)},n:function(){var t=a.next();return o=t.done,t},e:function(t){c=!0,i=t},f:function(){try{o||null==a.return||a.return()}finally{if(c)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,r=new Array(e);a<e;a++)r[a]=t[a];return r}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,a){return e&&_defineProperties(t.prototype,e),a&&_defineProperties(t,a),Object.defineProperty(t,"prototype",{writable:!1}),t}function _classPrivateMethodInitSpec(t,e){_checkPrivateRedeclaration(t,e),e.add(t)}function _checkPrivateRedeclaration(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(t,e,a){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return a}var _add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function t(){_classCallCheck(this,t),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];for(var n=0,i=a;n<i.length;n++){var o=i[n];this.add(o)}}catch(t){console.error("failed to create TypeSet object")}}return _createClass(t,[{key:"print",get:function(){if(this.label)return this.label;var e,a=[],r=_createForOfIteratorHelper(this.any);try{for(r.s();!(e=r.n()).done;){var n=e.value;"undefined"===n||"null"===n?a.push("".concat(n)):a.push("any '".concat(n,"'"))}}catch(t){r.e(t)}finally{r.f()}var i,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(i=o.n()).done;){var c=i.value;a.push("exactly the ".concat(t.id(c)," '").concat(c,"'"))}}catch(t){o.e(t)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(e){try{if("array"===t.id(e))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e);else if("object"===t.id(e))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,e);else if("string"==typeof e)_classPrivateMethodGet(this,_push,_push2).call(this,e,"any");else{var a='TypeSet - invalid input "'.concat(e,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(e," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(e){var a=!1;if("object"!==t.id(e)||1!==Object.keys(e).length||"any"!==Object.keys(e)[0]&&"exact"!==Object.keys(e)[0]&&"other"!==Object.keys(e)[0])for(var r=0,n=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));r<n.length;r++){if(e===n[r]){a=!0;break}}else for(var i=0,o=["any","exact","other"];i<o.length;i++){var c,l=o[i],s=Object.values(e)[0],d=_createForOfIteratorHelper(this[l]);try{for(d.s();!(c=d.n()).done;){if(s===c.value){a=!0;break}}}catch(t){d.e(t)}finally{d.f()}if(a=!0)break}return a}},{key:"accepts",value:function(e){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var r,n=_createForOfIteratorHelper(this.any);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(t.id(e)===i){a=!0;break}}}catch(t){n.e(t)}finally{n.f()}}if(!a){var o,c=_createForOfIteratorHelper(this.exact);try{for(c.s();!(o=c.n()).done;){if(e===o.value){a=!0;break}}}catch(t){c.e(t)}finally{c.f()}}return a}}],[{key:"validate",value:function(e){if(!t.valid.includes(e)){var a='TypeSet - "'.concat(e,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(t){return"object"===_typeof(t)&&!!t["this is a TypeSet"]}}]),t}();function _add_arr2(t,e){if(0===t.length){console.error("TypeSet - array input cannot be empty")}var a,r=_createForOfIteratorHelper(t);try{for(r.s();!(a=r.n()).done;){var n=a.value;e?_classPrivateMethodGet(this,_push,_push2).call(this,n,e):this.add(n)}}catch(t){r.e(t)}finally{r.f()}}function _add_obj2(t){for(var e in t)if("any"!==e&&"exact"!==e&&"other"!==e||"array"!==TypeSet.id(t[e]))if("any"===e||"exact"===e||"other"===e)_classPrivateMethodGet(this,_push,_push2).call(this,t[e],e);else if("label"===e){if("string"!==TypeSet.id(t[e])){var a='TypeSet - input for label "'.concat(t[e],"\" ('").concat(TypeSet.id(t[e]),"') should be a string instead");console.error(a)}this.label=t[e]}else{var r="TypeSet - unexpected object key ".concat(e);console.error(r)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t[e],e)}function _push2(t,e){try{if(this[e].includes(t))return;if("any"===e)TypeSet.validate(t),this.any.push(t);else if("exact"===e)this.exact.push(t);else if("any"===t)this.other.push(t);else{var a="TypeSet - unexpected input for ".concat(e,'-type "').concat(t,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(e,"-type to TypeSet at arg ").concat(t)),console.error(a)}}Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{argObj:!1,proxy:!1},log:function(t,e){(t=Array.isArray(t)?t:[t]).filter((function(t){return debug.on[t]})).length&&console.log(e)}};function check_required(t){var e=t.id,a=Object.keys(t).filter((function(t){return"id"!==t}));try{var r,n=_createForOfIteratorHelper(a);try{for(n.s();!(r=n.n()).done;){var i=r.value;if("undefined"===TypeSet.id(t[i])){var o='check_required - missing required input "'.concat(i,'" for ').concat(e);return this.error(o)}}}catch(t){n.e(t)}finally{n.f()}}catch(o){console.error("check_required - failed to validate required arguments for ".concat(e)),console.error(o)}}function check_common(t){if(!t){var e="check_common - missing required template argument";return this.error("check_common - missing required template argument")}var a=t.id;if(!a){return this.error("check_common - missing required id")}try{var r,n=_createForOfIteratorHelper(Object.keys(t).filter((function(t){return"id"!==t})));try{for(n.s();!(r=n.n()).done;){var i=r.value;if("array"===TypeSet.id(t[i].val)){var o,c=_createForOfIteratorHelper(t[i].val);try{for(c.s();!(o=c.n()).done;){var l=o.value;validatation_errors.call(this,{key:i,val:l,template:t})}}catch(t){c.e(t)}finally{c.f()}}else validatation_errors.call(this,{key:i,val:t[i].val,template:t})}}catch(t){n.e(t)}finally{n.f()}}catch(e){console.error("".concat(this.name,' - failed to validate macro arguments for "').concat(a,'"')),console.error(e)}}function validatation_errors(t){var e=t.key,a=t.val,r=t.template,n=r.id;try{if(r[e].extant){if("mapid"===e&&!_getmap(a)){var i="".concat(n,' - no map with id "').concat(a,'" found');return this.error(i)}if("tileid"===e&&!_gettile(r.mapid.val,a)){var o="".concat(n,' - no tile with id "').concat(a,'" in map ').concat(r.mapid.val," found");return this.error(o)}if("entityid"===e&&!_getentity(r.mapid.val,a)){var c="".concat(n,' - no "').concat(a,'" was found residing on map "').concat(r.mapid.val,'"');return this.error(c)}}if(r[e].integer&&!Number.isInteger(a)){var l="".concat(n,' - input "').concat(e,'" must be an integer');return this.error(l)}if(r[e].positive&&a<=0){var s="".concat(n,' - input "').concat(e,'" must be greater than zero');return this.error(s)}if(r[e].oneword&&a.includes(" ")){var d="".concat(n,' - input "').concat(e,'" must be one word, no spaces');return this.error(d)}}catch(i){console.error('failed to validate macro arguments on key "'.concat(e,'" with value "').concat(a,'" for "').concat(n,'"')),console.error(i)}}function check_xy(t){if(!t){var e="check_xy - missing required template argument";return this.error(e)}var a=t.id,r=t.mapid,n=t.entityid,i=t.x,o=t.y;if(!a){e="check_xy - missing required id";return this.error(e)}try{var c=_getmap(r),l=(c.arr,c.rows),s=c.columns;if(i.val>s){var d="".concat(a," - ").concat(i.label,' for "').concat(n,'" will exceed upper map boundary on "').concat(r,'"');return this.error(d)}if(o.val>l){var p="".concat(a," - ").concat(o.label,' for "').concat(n,'" will exceed upper map boundary on "').concat(r,'"');return this.error(p)}if(i.val<1){var m="".concat(a," - ").concat(i.label,' for "').concat(n,'" will exceed lower map boundary on "').concat(r,'"');return this.error(m)}if(o.val<1){var h="".concat(a," - ").concat(o.label,' for "').concat(n,'" will exceed lower map boundary on "').concat(r,'"');return this.error(h)}}catch(e){console.error('check_xy - failed to validate coordinates { "'.concat(i.label,'" : "').concat(i.val,'", "').concat(o.label,'" : "').concat(o.val,'" } on "').concat(r,'" for "').concat(a,'"')),console.error(e)}}function create_payObj(t,e){var a=this;if(!t){var r='create_payObj - missing input "pays_in" for "'.concat(this.name,'"');return this.error(r)}clone(t);if(!e){var n='create_payObj - misssing input "tempalte_in" for "'.concat(this.name,'"');return this.error(n)}var i=clone(e),o=i.id;if(!o){var c='create_payObj - missing template id for "'.concat(this.name,'"');return this.error(c)}var l=Object.keys(i).filter((function(t){return"id"!==t}));if(!l.length){var s='create_payObj - template is empty for "'.concat(this.name,'"');return this.error(s)}var d={};try{var p,m=_createForOfIteratorHelper(l);try{var h=function(){var t=p.value,e=a.payload.filter((function(e){return e.name===i[t].tagname}));if(!def.skipcheck.unused){var r,n,c;if(i[t].unique&&e.length>1){var l="".concat(o," - multiple of the same child tag received");return{v:a.error(l)}}if(i[t].noargs&&(null===(r=e[0])||void 0===r||null===(n=r.args)||void 0===n?void 0:n.length)>0){var s="".concat(o," - child tag doesn't take arguments");return{v:a.error(s)}}if(e[0]&&(null===(c=e[0])||void 0===c||!c.contents.trim())){var m="".concat(o," - payload required to use this child tag");return{v:a.error(m)}}}d[t]=e[0]?e[0].contents.trim():null};for(m.s();!(p=m.n()).done;){var u=h();if("object"===_typeof(u))return u.v}}catch(t){m.e(t)}finally{m.f()}return d}catch(r){console.error("".concat(o," - failed to parse payloads")),console.error(r)}}function create_argObj(t,e,a){if(!t){var r='create_argObj - missing input "args_in" for "'.concat(this.name,'"');return this.error(r)}var n=clone(t);if(!e){var i='create_argObj - missing input "template_in" for "'.concat(this.name,'"');return this.error(i)}var o=clone(e),c=o.id;if(!c){var l='create_argObj - missing template id for "'.concat(this.name,'"');return this.error(l)}var s=Object.keys(o).filter((function(t){return"id"!==t}));if(!s.length){var d='create_argObj - template is empty for "'.concat(c,'"');return this.error(d)}var p=s.filter((function(t){return o[t].infinite}));if(p.length>1){var m='create_argObj - "'.concat(c,'" template has more than one infinite key');return this.error(m)}if(p[0]&&p[0]!==s[s.length-1]){var h='create_argObj - "'.concat(c,'" template infinite key must be last');return this.error(h)}try{var u,f={},v=_createForOfIteratorHelper(s);try{for(v.s();!(u=v.n()).done;){var y=u.value;if(f[y]=y,o[y].alias)if("array"===TypeSet.id(o[y].alias)){var g,w=_createForOfIteratorHelper(o[y].alias);try{for(w.s();!(g=w.n()).done;){f[g.value]=y}}catch(t){w.e(t)}finally{w.f()}}else f[o[y].alias]=y}}catch(t){v.e(t)}finally{v.f()}for(var b={},_={id:c,args:n,template:o,keys:s,argObj:b,alias:f,options:a,splice:0};_.args.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",b),_.splice=0;var k=_.args[0];try{p[0]&&b[p[0]]&&argObj_infinite.call(this,_),!_.splice&&s.includes(f[k])&&argObj_kvp.call(this,_),!_.splice&&k.isLink&&argObj_markup.call(this,_),_.splice||"object"!==TypeSet.id(k)||argObj_obj.call(this,_);var x=_objectSpread({strict:!1},_.options).strict;if(_.splice||x||argObj_lazy.call(this,_),!_.splice){var S="".concat(c,' - unexpected input "').concat(k,'", is not a key name and did not match any valid types');return console.error(b),this.error(S)}_.args.splice(0,_.splice)}catch(r){console.error('create_argObj - failed to create argObj at "'.concat(k,'" for "').concat(c,'"')),console.error(r)}}return b}catch(r){console.error("".concat(c," - failed to parse macro arguments")),console.error(r)}}function argObj_infinite(t){debug.log("argObj","entered markup"),debug.log("argObj",t);var e=t.id,a=t.args,r=t.template,n=t.keys,i=t.argObj,o=(t.alias,t.options,a[0]),c=n.filter((function(t){return r[t].infinite}))[0],l=new TypeSet(r[c].type);if(!l.accepts(o)){var s="".concat(e,' - "').concat(o,'" is an invalid type for "').concat(c,"\" ('").concat(TypeSet.id(o),"'), expected ").concat(l.print);return this.error(s)}return"array"!==TypeSet.id(i[c])&&(i[c]=[i[c]]),i[c].includes(o)?(t.splice=1,t):(i[c]="array"===TypeSet.id(o)?i[c].concat(o):i[c].concat([o]),t.splice=1,t)}function argObj_markup(t){debug.log("argObj","entered markup"),debug.log("argObj",t);var e=t.id,a=t.args,r=(t.template,t.keys),n=t.argObj,i=(t.alias,t.options,a[0]);if(!r.includes("passage")){var o="".concat(e," - macro does not accept [[markup]]");return this.error(o)}return n.linktext=i.text,n.passage=i.link,t.splice=1,t}function argObj_kvp(t){debug.log("argObj","entered kvp"),debug.log("argObj",t);var e=t.id,a=t.args,r=t.template,n=(t.keys,t.argObj),i=t.alias,o=(t.options,a[0]),c=a[1];if("undefined"===TypeSet.id(c)){var l="".concat(e,' - no input was found for argument "').concat(o,'"');return this.error(l)}var s=new TypeSet(r[i[o]].type);if(!s.accepts(c)){var d="".concat(e,' - "').concat(c,"\" is an invalid type ('").concat(TypeSet.id(c),"') for \"").concat(o,'", expected ').concat(s.print);return this.error(d)}return n[i[o]]=c,t.splice=2,t}function argObj_obj(t){debug.log("argObj","entered object parser"),debug.log("argObj",t);var e=t.id,a=t.args,r=t.template,n=t.keys,i=t.argObj,o=t.alias,c=(t.options,a[0]);for(var l in c)if(n.includes(o[l])){var s=new TypeSet(r[o[l]].type);if(!s.accepts(c[l])){var d="".concat(e,' - "').concat(c[l],'" is an invalid type for "').concat(l,"\" ('").concat(TypeSet.id(c[l]),"'), expected ").concat(s.print);return this.error(d)}i[o[l]]=c[l],t.splice=1}return t}function argObj_lazy(t){debug.log("argObj","entered lazy matcher"),debug.log("argObj",t);t.id;var e=t.args,a=t.template,r=t.keys,n=t.argObj,i=(t.alias,t.options,e[0]),o=r.filter((function(t){return!Object.keys(n).includes(t)}));if(!o.length)return t;var c,l=_createForOfIteratorHelper(o);try{for(l.s();!(c=l.n()).done;){var s=c.value;if(new TypeSet(a[s].type).accepts(i)){n[s]=i,t.splice=1;break}}}catch(t){l.e(t)}finally{l.f()}return t}var config={map:{},tile:{},wall:{},floor:{},nav:{},player:{},building:{},object:{},npc:{},skipcheck:{},sizingmode:"auto"};config.map.width=20,config.map.height=15,config.map.unit="rem",config.nav.diagonal=!1,config.nav.width=15,config.nav.height=12,config.nav.unit="rem",config.nav.sizingoff=!1,config.wall.tileid=".",config.floor.tileid="x",config.map.zoom=2,config.map.panx=1,config.map.pany=1,config.player.wall=!0,config.building.wall=!0,config.object.wall=!1,config.npc.wall=!1,config.tile.width=2,config.tile.height=2,config.skipcheck.xybounds=!1,config.skipcheck.unused=!1,config.wall.tiletype="wall",config.floor.tiletype="floor",config.noclip=!1,config.collisionerror=!1,config.allowclobbering=!1,config.skipcheck.common=!1,config.disableglobal=!1,config.setupname="@navmap",config.globalname="Navmap",config.Statename="@navmap",null!==(_setup$_config$setupn=(_setup=setup)[_config$setupname=config.setupname])&&void 0!==_setup$_config$setupn||(_setup[_config$setupname]={}),null!==(_State$variables$_con=(_State$variables=State.variables)[_config$Statename=config.Statename])&&void 0!==_State$variables$_con||(_State$variables[_config$Statename]={}),null!==(_State$variables$conf2=(_State$variables$conf=State.variables[config.Statename]).local)&&void 0!==_State$variables$conf2||(_State$variables$conf.local={}),null!==(_State$variables$conf4=(_State$variables$conf3=State.variables[config.Statename]).global)&&void 0!==_State$variables$conf4||(_State$variables$conf3.global={});var def=new Proxy(config,get_controller(setup[config.setupname]));function get_controller(t){return{get:function(e,a){return debug.log("proxy","entered proxy"),void 0===t||void 0===t[a]?(debug.log("entered undefined"),e[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(t[a])||t[a].isproxy||(debug.log("proxy","created proxy"),t[a]=new Proxy(config[a],get_controller(t[a])),t[a].isproxy=!0),t[a])}}}var navmaps={};setup.navmaps=navmaps;var Navmap=function(){function t(e,a,r){var n;if(_classCallCheck(this,t),!def.allowclobbering&&navmaps[e])throw new Error('Navmap with map id "'.concat(e,'" already exists'));navmaps[String(e)]=this,this.mapsn=window.crypto.randomUUID(),this.mapid=String(e),this.arr=a,this.columns=r,this.rows=this.arr.length/this.columns,this.actors=new Array(this.arr.length),this.tiles={};var i,o=_createForOfIteratorHelper(new Set(this.arr));try{for(o.s();!(i=o.n()).done;){var c=i.value;this.tiles[String(c)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(c),tilename:c,tiletype:def.floor.tiletype,tilehtml:c}}}catch(t){o.e(t)}finally{o.f()}this.tiles[String(def.wall.tileid)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(def.wall.tileid),tilename:def.wall.tileid,tiletype:def.wall.tiletype,tilehtml:def.wall.tileid},this.tiles[String(def.floor.tileid)]={mapid:this.mapid,tilesn:window.crypto.randomUUID(),tileid:String(def.floor.tileid),tilename:def.floor.tileid,tiletype:def.floor.tiletype,tilehtml:def.floor.tileid},null!==(n=this.entities)&&void 0!==n||(this.entities={})}return _createClass(t,[{key:"entities",get:function(){return State.variables[config.Statename].local[this.mapid]},set:function(t){State.variables[config.Statename].local[this.mapid]=t}}],[{key:"newmap",value:function(t){t.id="newmap",t.source="JS",Macro.get("newmap").handlerJS(t)}},{key:"newtile",value:function(t){t.id="newtile",t.source="JS",Macro.get("newtile").handlerJS(t)}},{key:"newentity",value:function(t){t.id="newentity",t.source="JS",Macro.get("newentity").handlerJS(t)}},{key:"delentity",value:function(t){t.id="delentity",t.source="JS",Macro.get("delentity").handlerJS(t)}},{key:"moventity",value:function(t){t.id="moventity",t.source="JS",Macro.get("moventity").handlerJS(t)}},{key:"setentity",value:function(t){t.id="setentity",t.source="JS",Macro.get("setentity").handlerJS(t)}},{key:"mapcalculate",value:function(t){t.id="mapcalculate",t.source="JS",Macro.get("mapcalculate").handlerJS(t)}},{key:"getmap",value:function(){_getmap.apply(void 0,arguments)}},{key:"gettile",value:function(){_gettile.apply(void 0,arguments)}},{key:"getentity",value:function(){_getentity.apply(void 0,arguments)}},{key:"mapzoom",value:function(){for(var t=arguments.length,e=new Array(t),a=0;a<t;a++)e[a]=arguments[a];_mapzoom.call.apply(_mapzoom,[null!=this?this:{}].concat(e))}},{key:"mappan",value:function(){for(var t=arguments.length,e=new Array(t),a=0;a<t;a++)e[a]=arguments[a];_mappan.call.apply(_mappan,[null!=this?this:{}].concat(e))}}]),t}();function convert_i2xy(t,e){var a=t%e+1;return{x:a,y:(t-a+1)/e+1}}function convert_xy2i(t,e){var a=t.x,r=t.y;return a<1||r<1?-1:(r-1)*e+a-1}function _getmap(){for(var t,e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];var n=null!==(t=a[0].mapid)&&void 0!==t?t:a[0];return navmaps[n]}function _gettile(){for(var t,e,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];var i=null!==(t=r[0].mapid)&&void 0!==t?t:r[0],o=null!==(e=r[0].tileid)&&void 0!==e?e:r[1],c=_getmap(i);return c.tiles[o]}function _getentity(){for(var t,e,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];var i=null!==(t=r[0].mapid)&&void 0!==t?t:r[0],o=null!==(e=r[0].entityid)&&void 0!==e?e:r[1],c=_getmap(i);return c.entities[o]}function getoverlap(){for(var t,e,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];var i=null!==(t=r[0].mapid)&&void 0!==t?t:r[0],o=null!==(e=r[0].entityid)&&void 0!==e?e:r[1],c=_getmap(i),l=c.columns,s=c.actors,d=_getentity(i,o),p=d.x,m=d.y,h=convert_xy2i({x:p,y:m},l);return s[h].overlap.filter((function(t){return t!==o}))}function getadjacent(){for(var t,e,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];var i=null!==(t=r[0].mapid)&&void 0!==t?t:r[0],o=null!==(e=r[0].entityid)&&void 0!==e?e:r[1],c=_getmap(i),l=c.columns,s=c.actors,d=_getentity(i,o),p=d.x,m=d.y,h=convert_xy2i({x:p,y:m},l);return s[h].adjacent.filter((function(t){return t!==o}))}function create_tile(t){var e=t.mapid,a=t.tile,r=t.i,n=t.row,i=t.column,o=a.tilesn,c=a.tileid,l=a.tilename,s=a.tiletype,d=a.tilehtml;try{var p=$(document.createElement("div"));return p.addClass("macro-showmap-tile").addClass(s).attr("title",l).attr("data-tilesn",o).attr("data-tileid",c).attr("data-tilename",l).attr("data-tiletype",s).css({"grid-column":"".concat(i," / span 1"),"grid-row":"".concat(n," / span 1")}).wiki(d||c),p}catch(t){console.error("".concat(this.name,' - failed to create tile element at "').concat(r,'" on "').concat(e,'" for ').concat(this.name)),console.error(t)}}function create_entity(t){var e=t.mapid,a=t.entity,r=t.column,n=t.row,i=a.entitysn,o=a.entityid,c=a.entityname,l=a.entityhtml;try{var s=$(document.createElement("div"));return s.addClass("macro-showmap-entity").attr("title",c).attr("data-sn",i).attr("data-entityid",o).wiki(l||o).css({"grid-column":"".concat(r," / span 1"),"grid-row":"".concat(n," / span 1")}),s}catch(t){console.error("".concat(this.name,' - failed to create entity element for "').concat(o,'" on "').concat(e,'"')),console.error(t)}}function create_dir(t){var e=t.mapid,a=t.entityid,r=t.dir,n=_getmap(e),i=n.arr,o=n.rows,c=n.columns,l=n.actors,s=r.dirid,d=r.dirname,p=r.deltax,m=r.deltay,h=_getentity(e,a);try{var u=$(document.createElement("div"));u.addClass("macro-shownav-direction macro-shownav-".concat(s)).attr("data-dirid",s).attr("data-dirname",d).attr("data-mapid",e);var f=h.x+p,v=h.y+m,y=convert_xy2i({x:f,y:v},c);if(y>=0&&v>=1&&v<=o&&f>=1&&f<=c){var g=_gettile(e,i[y]),w=g.tileid,b=g.tilename,_=l[y].wall.length>0;u.attr("data-disabled",_).attr("data-tileid",w).wiki(_?"":b||w)}else u.attr("data-disabled",!0).attr("data-tileid",null);return u}catch(t){console.error("".concat(this.name,' - failed to create nav direction "').concat(d,'" for map "').concat(e,'"')),console.error(t)}}config.disableglobal||Object.defineProperty(window,config.globalname,{value:Navmap});var updatemap=function(t){var e=t.$map,a=t.map,r=t.mapheight,n=t.mapwidth,i=t.tileheight,o=t.tilewidth,c=t.unit,l=t.sizingmode,s=t.tracked,d=a.mapid,p=a.columns,m=a.rows,h=a.arr,u=a.entities,f=s?t.zoom:0,v=s?Math.clamp(1,m,t.viewrows+f):m,y=s?Math.clamp(1,p,t.viewcolumns+f):p;try{var g,w,b;"height"===l?(w=(g=r/v)*o/i,b="height"):"width"===l?(g=(w=n/y)*i/o,b="width"):"auto"===l?n/r>y*o/(v*i)?(w=(g=r/v)*o/i,b="auto-height"):(g=(w=n/y)*i/o,b="auto-width"):"tile"===l&&(w=o,g=i,b="tile"),b&&e.attr("data-sizing",b).attr("data-tilewidth",w).attr("data-tileheight",g).attr("data-unit",c).css({"--tilewidth":String(w)+c,"--tileheight":String(g)+c})}catch(t){console.error("".concat(this.name,' - failed to size showmap map output for map "').concat(d,'"')),console.error(t)}try{var _=s?t.panx:0,k=s?t.pany:0,x=s?Math.clamp(1,p-y-_+1,s.x-Math.floor(y/2)+_):1,S=s?Math.clamp(1,m-v-k+1,s.y-Math.floor(v/2)+k):1;console.log({x0:x,y0:S});for(var j=convert_xy2i({x:x,y:S},p),O=[],$=1;$<=v;$++)for(var z=1;z<=y;z++){var T=j+(z-1)+p*($-1);O.push(T);var M=h[T];create_tile.call(this,{mapid:d,tile:_gettile(d,M),i:T,row:$,column:z}).appendTo(e)}for(var C in u){var E=u[C],J=convert_xy2i({x:E.x,y:E.y},p);if(O.includes(J))create_entity.call(this,{mapid:d,entity:E,row:E.y-S+1,column:E.x-x+1}).appendTo(e)}return e.attr("data-zoom",f).attr("data-x0",x).attr("data-y0",S).attr("data-panx",_).attr("data-pany",k),e}catch(t){console.error("".concat(this.name,' - failed to print map for "').concat(d,'"')),console.error(t)}},cssunit={exact:["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvh","dvw","dvh","%"],label:"any valid 'CSS unit'"},dirs_4={C:{dirid:"C",dirname:"center",deltax:0,deltay:0},N:{dirid:"N",dirname:"north",deltax:0,deltay:-1},E:{dirid:"E",dirname:"east",deltax:1,deltay:0},S:{dirid:"S",dirname:"south",deltax:0,deltay:1},W:{dirid:"W",dirname:"west",deltax:-1,deltay:0}},dirs_8=_objectSpread(_objectSpread({},dirs_4),{},{NW:{dirid:"NW",dirname:"northwest",deltax:-1,deltay:-1},NE:{dirid:"NE",dirname:"northeast",deltax:1,deltay:-1},SE:{dirid:"SE",dirname:"southeast",deltax:1,deltay:1},SW:{dirid:"SW",dirname:"southwest",deltax:-1,deltay:1}});Macro.add("newmap",{tags:[null],maps:{},handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},mapname:{type:"string",alias:"name"},columns:{type:"number"},diagonal:{type:"boolean"}});t.source="macro",t.inputtype="array",t.inputmap=this.payload[0].contents.trim().split(/\s+/g),this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"newmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=_objectSpread({diagonal:def.nav.diagonal},t),i=n.source,o=n.mapid,c=n.mapname,l=n.diagonal,s=n.inputtype,d=n.inputmap;if(check_required.call(this,{id:this.name,mapid:o,inputtype:s}),!d){var p="".concat(this.name,"macro"===i?" - missing required macro payload":' - missing required input "inputmap"');return this.error(p)}try{if("array"===s)t.arr=d;else{if("2D array"!==s){var m="".concat(this.name," - invalid inputtype, currently only supports macro payload or 'array' or '2D array'");return this.error(m)}t.columns=d[0].length,t.arr=d.flat()}}catch(p){console.error("".concat(this.name,' - failed to parse input for inputtype "').concat(s,'" and inputmap:+')),console.error(d),console.error(p)}var h=t.arr,u=t.columns;if(!u){p=("".concat(this.name,' - missing required input "columns"'),_readOnlyError("inputtype"));return this.error(p)}def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:o,oneword:!0},columns:{val:u,integer:!0,positive:!0}});try{if(h.length%u){var f="".concat(this.name," - inputmap is not rectangular");return this.error(f)}var v=new Navmap(o,h,u);v.mapname=c,v.diagonal=l}catch(p){console.error("".concat(this.name,' - failed to create Navmap object for map "').concat(o,'"')),console.error(p)}Macro.get("mapcalculate").handlerJS.call(this,{mapid:o,diagonal:l})}}),Macro.add("newtile",{tags:null,handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},tileid:{type:"string",alias:"tile"},tilename:{type:"string",alias:"name"},tiletype:{type:"string",alias:"type"}});t.tilehtml=this.payload[0].contents.trim(),this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"newtile"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t.mapid,i=t.tileid,o=t.tilename,c=t.tiletype,l=t.tilehtml;check_required.call(this,{id:this.name,mapid:n,tileid:i}),def.skipcheck.common||(check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},tileid:{val:i,oneword:!0,extant:!0}}),o&&check_common.call(this,{id:"name",name:{val:o,oneword:!0}}),c&&check_common.call(this,{id:"type",type:{val:c,oneword:!0}}));try{var s=_gettile(n,i);o&&(s.tilename=o),c&&(s.tiletype=c),l&&(s.tilehtml=l)}catch(t){console.error("".concat(this.name,' - failed to create new tile definition for "').concat(i,'" on map "').concat(n,'"')),console.error(t)}}}),Macro.add("showmap",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,hidemap:{type:{exact:["--hidemap"]}},mapid:{type:"string",alias:"map"},class:{type:"string"},sizingmode:{type:[{exact:"auto"},{exact:"height"},{exact:"width"},{exact:"tile"},{exact:"off"}],alias:"mode"},mapwidth:{type:"number"},mapheight:{type:"number"},tilewidth:{type:"number"},tileheight:{type:"number"},unit:{type:cssunit},viewrows:{type:"number"},viewcolumns:{type:"number"},viewtrack:{type:"string"}});this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"showmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=_objectSpread({sizingmode:def.sizingmode},t),i=n.mapid,o=n.sizingmode,c=n.viewrows,l=n.viewcolumns,s=n.viewtrack;if(check_required.call(this,{mapid:i}),!def.skipcheck.unused){if("height"===o&&t.mapwidth){var d="".concat(this.name,' - map width can\'t be specified when map sizing mode is set to "height"');return this.error(d)}if("width"===o&&t.mapheight){var p="".concat(this.name,' - map height can\'t be specified when map sizing mode is set to "with"');return this.error(p)}if("tile"===o&&(t.mapwidth||t.mapheight)){var m="".concat(this.name,' - map height and width can\'t be specified when map sizing mode is set to "tile"');return this.error(m)}if("off"===o&&(t.mapwidth||t.mapheight||t.unit)){var h="".concat(this.name,' - map height, width, and units can\'t be specified when sizing mode is set to "off"');return this.error(h)}}var u=_objectSpread({mapheight:def.map.height,mapwidth:def.map.width,tileheight:def.tile.height,tilewidth:def.tile.width,unit:def.map.unit},t),f=u.mapheight,v=u.mapwidth,y=u.tileheight,g=u.tilewidth,w=u.unit;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},mapwidth:{val:v,positive:!0},mapheight:{val:f,positive:!0},tilewidth:{val:g,positive:!0},tileheight:{val:y,positive:!0}});var b=_getmap(i),_=b.mapname,k=b.columns,x=b.rows,S=b.diagonal,j=b.mapsn;if(l||c||s){if(!l&&!c){d="zoom - both viewcolumns and viewrows are required to use showmap zoom";return this.error(d)}if(!def.skipcheck.common){if(check_common.call(this,{id:"zoom",viewcolumns:{val:l,positive:!0,integer:!0},viewrows:{val:c,positive:!0,integer:!0}}),l>k){return this.error("zoom - zoom.x can't be greater than # of columns")}if(c>x){return this.error("zoom - zoom.y can't be greater than # of columns")}if("undefined"!==TypeSet.id(s)&&!_getentity(i,s)){var O='zoom - no entity with id "'.concat(s,'" found on map "').concat(i,'"');return this.error(O)}}}try{var z,T;Macro.get("mapcalculate").handlerJS.call(this,{mapid:i,diagonal:S});var M=_getentity(i,s),C=$(document.createElement("div"));C.addClass("macro-".concat(this.name,"-map")).addClass(null!==(z=t.class)&&void 0!==z?z:"").attr("data-sn",j).attr("data-mapid",i).attr("data-columns",k).attr("data-rows",x).attr("data-viewrows",c).attr("data-viewcolumns",l).attr("data-tracked",null!==(T=null==M?void 0:M.entityid)&&void 0!==T?T:void 0),updatemap.call(this,{$map:C,map:b,mapheight:f,mapwidth:v,tileheight:y,tilewidth:g,unit:w,sizingmode:o,tracked:M,viewrows:null!=c?c:x,viewcolumns:null!=l?l:k,zoom:0,panx:0,pany:0});var E=$(document.createElement("div"));if(E.addClass("macro-showmap-container").append(C),$(document.createElement("div")).addClass("macro-showmap-title").wiki(null!=_?_:"").appendTo(E),M){$(document.createElement("div")).addClass("macro-showmap-topbuttons").append($(document.createElement("button")).addClass("macro-showmap-recenter").wiki("C")).append($(document.createElement("button")).addClass("macro-showmap-zoombutton").attr("data-mode","in").wiki("+")).append($(document.createElement("button")).addClass("macro-showmap-zoombutton").attr("data-mode","out").wiki("-")).appendTo(E);for(var J=0,q=["up","down","left","right"];J<q.length;J++){var I=q[J];$(document.createElement("button")).addClass("macro-showmap-panbutton").attr("data-mode",I).wiki(I.first().toUpperCase()).appendTo(E)}}E.appendTo(this.output),setTimeout((function(){C.on(":mapupdate",(function(t){$(this).children().remove(),updatemap.call(this,{$map:C,map:b,mapheight:f,mapwidth:v,tileheight:y,tilewidth:g,unit:w,sizingmode:o,tracked:M,viewrows:c,viewcolumns:l,zoom:Number($(this).attr("data-zoom")),panx:Number($(this).attr("data-panx")),pany:Number($(this).attr("data-pany"))})})),E.on("click",(function(t){if($(t.target).hasClass("macro-showmap-panbutton")){var e=$(t.target).attr("data-mode");_mappan.call(this,{id:this.name,mapid:i,mode:e})}if($(t.target).hasClass("macro-showmap-zoombutton")){var a=$(t.target).attr("data-mode");_mapzoom.call(this,{id:this.name,mapid:i,mode:a})}$(t.target).hasClass("macro-showmap-recenter")&&maprecenter.call(this,{id:this.name,mapid:i})}))}),40)}catch(d){console.error("".concat(this.name,' - failed to create showmap element for map "').concat(i,'"')),console.error(d)}}}),Macro.add("shownav",{tags:["nav-north","nav-east","nav-south","nav-west","nav-northwest","nav-northeast","nav-southeast","nav-southwest"],handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},width:{type:"number"},height:{type:"number"},unit:{type:cssunit}}),e=create_payObj.call(this,this.payload,{id:this.name,north:{tagname:"nav-north",unique:!0,noargs:!0},east:{tagname:"nav-east",unique:!0,noargs:!0},south:{tagname:"nav-south",unique:!0,noargs:!0},west:{tagname:"nav-west",unique:!0,noargs:!0},northwest:{tagname:"nav-northwest",unique:!0,noargs:!0},northeast:{tagname:"nav-northeast",unique:!0,noargs:!0},southeast:{tagname:"nav-southeast",unique:!0,noargs:!0},southwest:{tagname:"nav-southwest",unique:!0,noargs:!0}});this.self.handlerJS.call(this,_objectSpread(_objectSpread({},t),e))},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"shownav"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=_objectSpread({width:def.nav.width,height:def.nav.height,unit:def.nav.unit},t),i=n.mapid,o=n.entityid,c=n.width,l=n.height,s=n.unit;n.north,n.east,n.south,n.west,n.northwest,n.northeast,n.southeast,n.southwest;check_required.call(this,{mapid:i});var d=_getmap(i).diagonal;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},width:{val:c,positive:!0},height:{val:l,positive:!0}});var p=$(document.createElement("div")),m=d?dirs_8:dirs_4;try{var h=window.crypto.randomUUID();for(var u in p.addClass("macro-".concat(this.name,"-nav")).attr("data-mapid",i).attr("data-sn",h).css({"--height":String(l)+s,"--width":String(c)+s}),m){create_dir.call(this,{mapid:i,entityid:o,dir:m[u]}).appendTo(p)}p.appendTo(this.output)}catch(t){console.error("".concat(this.name," -  failed to create nav rose for ").concat(i)),console.error(t)}try{setTimeout((function(){p.on("click",(function(t){var e=$(t.target).attr("data-dirid");if(e&&"C"!==e&&!("true"===$(t.target).attr("data-disabled"))){$(this).trigger(":navupdate",[e]);var a=_getmap($(this).attr("data-mapid")).mapsn;$('[data-sn="'.concat(a,'"]')).trigger(":mapupdate")}})),p.on(":navupdate",(function(t,e){var a=$(this).attr("data-mapid");for(var r in e&&Macro.get("moventity").handlerJS.call(this,{mapid:a,entityid:o,deltax:m[e].deltax,deltay:m[e].deltay}),p.html(""),m){create_dir.call(this,{mapid:a,entityid:o,dir:m[r]}).appendTo(p)}}))}),40)}catch(t){console.error("".concat(this.name," -  failed to add click functionality to navrose for ").concat(i)),console.error(t)}}}),Macro.add(["newentity"],{tags:null,handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},entityname:{type:"string",alias:"name"},wall:{type:"boolean"},x:{type:"number"},y:{type:"number"}}),e=create_payObj.call(this,this.payload,{id:this.name,entityhtml:{tagname:this.name}});e.entitytrigger,t.source="macro",this.self.handlerJS.call(this,_objectSpread(_objectSpread({},t),e))},handlerJS:function(t){var e,a,r,n;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"newentity"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var i=t.mapid,o=t.x,c=t.y,l=(t.source,t.wall),s=t.entityname,d=t.entityhtml,p=t.entityhandler;check_required.call(this,{id:this.name,mapid:i,x:o,y:c});var m=window.crypto.randomUUID(),h=null!==(n=t.entityid)&&void 0!==n?n:m;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:i,oneword:!0,extant:!0},entityid:{val:h,oneword:!0},x:{val:o,integer:!0},y:{val:c,integer:!0}});var u=_getmap(i);try{var f;if(!def.allowclobbering&&_getentity(i,h)){var v="".concat(this.name,' - entity with id "').concat(h,'" already exists in map "').concat(i,'"');return this.error(v)}def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:h,x:{val:o,label:"entity x position"},y:{val:c,label:"entity y position"}});var y={mapid:i,entitysn:m,entityid:String(h),entityname:s,entityhtml:d,entityhandler:p,x:o,y:c,wall:l};null!==(f=u.entities)&&void 0!==f||(u.entities={}),u.entities[h]=y}catch(v){console.error("".concat(this.name,' = failed to add entity "').concat(h,'" to "').concat(i,'"')),console.error(v)}}}),Macro.add(["delentity"],{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"}});this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"delentity"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t.mapid,i=t.entityid;check_required.call(this,{id:this.name,mapid:n,entityid:i}),def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},entityid:{val:i,oneword:!0,extant:!0}});var o=_getmap(n).entities;try{var c=clone(o[i].entitysn);delete o[i];var l=$('[data-sn="'.concat(c,'"]')).first();l&&(l.remove(),Macro.get("mapcalculate").handlerJS.call(this,{mapid:n,diagonal:diagonal})),$('.macro-shownav-nav[data-mapid="'.concat(n,'"]')).trigger(":navupdate")}catch(t){console.error("".concat(this.name,' - failed to delete entity "').concat(i,'" from "').concat(n,'"')),console.error(t)}}}),Macro.add(["moventity"],{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},deltax:{type:"number",alias:"x"},deltay:{type:"number",alias:"y"},ignorewalls:{type:"boolean"}});this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t.mapid,i=t.entityid,o=t.deltax,c=t.deltay,l=t.ignorewalls;check_required.call(this,{id:this.name,mapid:n,entityid:i,deltax:o,deltay:c}),def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},entityid:{val:i,oneword:!0,extant:!0},deltax:{val:o,integer:!0},deltay:{val:c,integer:!0}});var s=_getmap(n),d=s.columns,p=s.actors,m=s.diagonal,h=s.sn,u=_getentity(n,i),f=u.x,v=u.y;try{def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:n,entityid:i,x:{val:f+o,label:"new x position after deltax"},y:{val:v+c,label:"new y position after deltay"}});var y=convert_xy2i({x:f+o,y:v+c},d);if(!l&&!def.noclip&&p[y].wall.length>0){if(def.collisionerror){var g="".concat(this.name,' - collision detected for entity "').concat(i,'" on "').concat(n,'"');return this.error(g)}return}u.x+=o,u.y+=c,Macro.get("mapcalculate").handlerJS.call(this,{mapid:n,diagonal:m}),$('[data-sn="'.concat(h,'"]')).trigger(":mapupdate"),$('.macro-shownav-nav[data-mapid="'.concat(n,'"]')).trigger(":navupdate")}catch(g){console.error("".concat(this.name,' - failed to move entity "').concat(i,'" on "').concat(n,'"')),console.error(g)}}}),Macro.add("setentity",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},x:{type:"number"},y:{type:"number"}});this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t.mapid,i=t.entityid,o=t.x,c=t.y;def.skipcheck.common||check_common.call(this,{id:this.name,mapid:{val:n,oneword:!0,extant:!0},entityid:{val:i,oneword:!0,extant:!0},x:{val:o,integer:!0},y:{val:c,integer:!0}});var l=_getmap(n),s=l.mapsn,d=(l.actors,l.columns,l.diagonal);try{var p=_getentity(n,i);def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:n,entityid:i,x:{val:o,label:"new x position"},y:{val:c,label:"new y position"}}),p.x=o,p.y=c,Macro.get("mapcalculate").handlerJS.call(this,{mapid:n,diagonal:d}),$('[data-sn="'.concat(s,'"]')).trigger(":mapupdate"),$('.macro-shownav-nav[data-mapid="'.concat(n,'"]')).trigger(":navupdate")}catch(t){console.error("".concat(this.name,' - failed to set positition for entity "').concat(i,'" on map "').concat(n,'"')),console.error(t)}}}),Macro.add("mapcalculate",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},diagonal:{type:"boolean"}});this.self.handlerJS.call(this,t)},handlerJS:function(t){var e,a,r;"string"==typeof t&&(t={mapid:t}),null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"mapcalculate"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t,i=n.mapid,o=n.diagonal;check_required.call(this,{id:this.name,mapid:i});var c=_getmap(i),l=c.columns,s=c.arr,d=c.actors,p=c.entities;try{for(var m=0;m<s.length;m++){var h=_gettile(i,s[m]);d[m]={},d[m].tileid=h.tileid,d[m].wall=[],d[m].overlap=[],d[m].adjacent=[],h.tiletype===def.wall.tiletype&&d[m].wall.push({tile:h.tileid})}for(var u in p){var f=p[u],v=f.wall,y=f.x,g=f.y,w=f.entityid,b=convert_xy2i({x:y,y:g},l);v&&d[b].wall.push({entity:w}),d[b].overlap.push({entity:w});var _=Object.assign({},o?dirs_8:dirs_4);for(var k in delete _.C,_){var x=convert_xy2i({x:y+_[k].deltax,y:g+_[k].deltay},l);x>=0&&x<s.length-1&&d[x].adjacent.push({entity:w})}}}catch(t){console.error("".concat(this.name,' - failed to calculate actors indices for map "').concat(i,'"')),console.error(t)}}}),Macro.add("mapzoom",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mode:{type:{label:"exactly the string 'in' or exactly the string 'out' or one of keywords '--zoomin' or '--zomout'",exact:["in","out","--zoomin","--zoomout"]}},mapid:{type:"string",alias:"map"},class:{type:"string"},zoom:{type:"number"}});_mapzoom.call(this,t)}});var _mapzoom=function(t){var e,a,r,n;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"zoom"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var i=_objectSpread({zoom:def.map.zoom},t),o=i.mapid,c=i.zoom,l=null==t||null===(n=t.mode)||void 0===n?void 0:n.replace("--zoom","");if(check_required.call(this,{id:this.name,mapid:o,mode:l}),def.skipcheck.common||(check_common.call(this,{id:this.name,mapid:{val:o,extant:!0,oneword:!0},zoom:{val:c,integer:!0,positive:!0}}),t.class&&check_common.call(this,{id:this.name,class:{val:t.class,oneword:!0}})),void 0!==l&&"in"!==l&&"out"!==l)var s="".concat(this.name," - invalid \"mode\" input, must be exactly the string 'in' or 'out'");var d="in"===l?-1:1,p=_getmap(o),m=p.columns,h=p.rows;try{var u=t.class?$('.macro-showmap-map[data-mapid="'.concat(o,'"]')).filter(".".concat(t.class)):$('.macro-showmap-map[data-mapid="'.concat(o,'"]'));if(u.attr("data-tracked")){var f=Number(u.attr("data-viewrows")),v=Number(u.attr("data-viewcolumns")),y=Number(u.attr("data-zoom"))+c*d,g=f+y,w=v+y;g>=1&&w>=1&&g<=h&&w<=m&&(console.log({viewcolumns_new:w,viewrows_new:g}),u.attr("data-zoom",y).trigger(":mapupdate"))}}catch(s){console.error("".concat(this.name," - failed to zoom ").concat(l,' for map "').concat(o,'"')),console.error(s)}};Macro.add("mappan",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mode:{type:{label:"exactly one of strings 'left' or 'right' or 'up' or 'down' or one of corresponding keywords '--panleft' or '--panright' or '--panup' or '--pandown'",exact:["left","right","up","down","--left","--right","--up","--down"]}},mapid:{type:"string",alias:"map"},class:{type:"string"},panx:{type:"number"},pany:{type:"number"}});_mappan.call(this,t)}});var _mappan=function(t){var e,a,r,n,i,o,c,l,s,d;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"pan"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var p=t.mapid,m=null==t||null===(n=t.mode)||void 0===n?void 0:n.replace("--pan","");if(check_required.call(this,{id:this.name,mapid:p}),!t.panx&&!t.pany&&!m){var h="".concat(this.name," - missing required value for one of 'panx' or 'pany' or 'mode', or use of one of keywords '--left' or '--right' or '--up' or '--down'");return this.error(h)}if(void 0!==m&&"right"!==m&&"left"!==m&&"up"!==m&&"down"!==m){var u="".concat(this.name," - invalid \"mode\" input, if used it must be exactly the string 'left' or 'right' or 'up' or 'down'");return this.error(u)}if(!def.skipcheck.unused){if(("left"===m||"right"===m)&&t.pany){var f="".concat(this.name," - 'pany' value is not used when panning left or right");return this.error(f)}if(("up"===m||"down"===m)&&t.panx){var v="".concat(this.name," - 'panx' value is not used when panning up or down");return this.error(v)}}var y="up"===m||"down"===m?0:"left"===m?-1*Math.abs(null!==(i=t.panx)&&void 0!==i?i:def.map.panx):"right"===m?1*Math.abs(null!==(o=t.panx)&&void 0!==o?o:def.map.panx):null!==(c=t.panx)&&void 0!==c?c:0,g="left"===m||"right"===m?0:"up"===m?-1*Math.abs(null!==(l=t.pany)&&void 0!==l?l:def.map.pany):"down"===m?1*Math.abs(null!==(s=t.pany)&&void 0!==s?s:def.map.pany):null!==(d=t.pany)&&void 0!==d?d:0;def.skipcheck.common||check_common.call(this,{id:this.name,panx:{val:y,integer:!0},pany:{val:g,integer:!0}});var w=_getmap(p),b=w.columns,_=w.rows;try{var k=t.class?$('.macro-showmap-map[data-mapid="'.concat(p,'"]')).filter(".".concat(t.class)):$('.macro-showmap-map[data-mapid="'.concat(p,'"]'));if(k.attr("data-tracked")){var x=Number(k.attr("data-viewrows")),S=Number(k.attr("data-viewcolumns")),j=Number(k.attr("data-zoom")),O=Number(k.attr("data-panx"))+y,z=Number(k.attr("data-pany"))+g,T=Number(k.attr("data-x0"))+O,M=Number(k.attr("data-y0"))+z;T>=1&&M>=1&&M<=_-x-j+1&&T<=b-S-j+1&&k.attr("data-panx",O).attr("data-pany",z).trigger(":mapupdate")}}catch(h){console.error("".concat(this.name," - failed to pan {panx: ").concat(y,"}, pany: ").concat(g,'} for map "').concat(p,'"')),console.error(h)}};function maprecenter(t){var e,a,r;null!==(e=this.name)&&void 0!==e||(this.name=null!==(a=t.id)&&void 0!==a?a:"pan"),null!==(r=this.error)&&void 0!==r||(this.error=function(t){throw new Error(t)});var n=t.mapid;check_required.call(this,{id:this.name,mapid:n}),def.skipcheck.common||(check_common.call(this,{id:this.name,mapid:{val:n,extant:!0,oneword:!0}}),t.class&&check_common.call(this,{id:this.name,class:{val:t.class,oneword:!0}}));try{(t.class?$('.macro-showmap-map[data-mapid="'.concat(n,'"]')).filter(".".concat(t.class)):$('.macro-showmap-map[data-mapid="'.concat(n,'"]'))).attr("data-panx",0).attr("data-pany",0).attr("data-zoom",0).trigger(":mapupdate")}catch(t){console.error("".concat(this.name,' - failed to recenter map "').concat(n,'"')),console.error(t)}}Macro.add("maprecenter",{handler:function(){var t=create_argObj.call(this,this.args,{id:this.name,mapid:{type:"string",alias:"map"},class:{}});maprecenter.call(this,t)}});