"use strict";var _setup,_config$setupname,_setup$_config$setupn,_State$variables,_config$Statename,_State$variables$_con,_State$variables$conf,_State$variables$conf2,_State$variables$conf3,_State$variables$conf4;function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){_defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,c=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){c=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(c)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,a){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return a}var _add_arr=new WeakSet,_add_obj=new WeakSet,_push=new WeakSet,TypeSet=function(){function e(){_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_push),_classPrivateMethodInitSpec(this,_add_obj),_classPrivateMethodInitSpec(this,_add_arr),this.any=[],this.exact=[],this.other=[],this.label=null,this["this is a TypeSet"]=!0;try{for(var t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];for(var i=0,n=a;i<n.length;i++){var o=n[i];this.add(o)}}catch(e){console.error("failed to create TypeSet object")}}return _createClass(e,[{key:"print",get:function(){if(this.label)return this.label;var t,a=[],r=_createForOfIteratorHelper(this.any);try{for(r.s();!(t=r.n()).done;){var i=t.value;"undefined"===i||"null"===i?a.push("".concat(i)):a.push("any '".concat(i,"'"))}}catch(e){r.e(e)}finally{r.f()}var n,o=_createForOfIteratorHelper(this.exact);try{for(o.s();!(n=o.n()).done;){var c=n.value;a.push("exactly the ".concat(e.id(c)," '").concat(c,"'"))}}catch(e){o.e(e)}finally{o.f()}return a.join(" or ")}},{key:"add",value:function(t){try{if("array"===e.id(t))_classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,t);else if("object"===e.id(t))_classPrivateMethodGet(this,_add_obj,_add_obj2).call(this,t);else if("string"==typeof t)_classPrivateMethodGet(this,_push,_push2).call(this,t,"any");else{var a='TypeSet - invalid input "'.concat(t,"\", must be 'string' or 'object' or 'array'");console.error(a)}}catch(a){console.error("failed to add ".concat(t," to TypeSet; check 'TypeSet.valid' for valid types")),console.error(a)}}},{key:"has",value:function(t){var a=!1;if("object"!==e.id(t)||1!==Object.keys(t).length||"any"!==Object.keys(t)[0]&&"exact"!==Object.keys(t)[0]&&"other"!==Object.keys(t)[0])for(var r=0,i=[].concat(_toConsumableArray(this.any),_toConsumableArray(this.exact));r<i.length;r++){if(t===i[r]){a=!0;break}}else for(var n=0,o=["any","exact","other"];n<o.length;n++){var c,l=o[n],s=Object.values(t)[0],d=_createForOfIteratorHelper(this[l]);try{for(d.s();!(c=d.n()).done;){if(s===c.value){a=!0;break}}}catch(e){d.e(e)}finally{d.f()}if(a=!0)break}return a}},{key:"accepts",value:function(t){var a=!1;if(this.other.includes("any")&&(a=!0),!a){var r,i=_createForOfIteratorHelper(this.any);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(e.id(t)===n){a=!0;break}}}catch(e){i.e(e)}finally{i.f()}}if(!a){var o,c=_createForOfIteratorHelper(this.exact);try{for(c.s();!(o=c.n()).done;){if(t===o.value){a=!0;break}}}catch(e){c.e(e)}finally{c.f()}}return a}}],[{key:"validate",value:function(t){if(!e.valid.includes(t)){var a='TypeSet - "'.concat(t,"\" is not a valid type; use 'TypeSet.valid' to get the array of valid types; use exact to add the exact value");throw new Error(a)}}},{key:"valid",get:function(){return["string","number","object","boolean","undefined","array","null"]}},{key:"id",value:function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}},{key:"isTypeSet",value:function(e){return"object"===_typeof(e)&&!!e["this is a TypeSet"]}}]),e}();function _add_arr2(e,t){if(0===e.length){console.error("TypeSet - array input cannot be empty")}var a,r=_createForOfIteratorHelper(e);try{for(r.s();!(a=r.n()).done;){var i=a.value;t?_classPrivateMethodGet(this,_push,_push2).call(this,i,t):this.add(i)}}catch(e){r.e(e)}finally{r.f()}}function _add_obj2(e){for(var t in e)if("any"!==t&&"exact"!==t&&"other"!==t||"array"!==TypeSet.id(e[t]))if("any"===t||"exact"===t||"other"===t)_classPrivateMethodGet(this,_push,_push2).call(this,e[t],t);else if("label"===t){if("string"!==TypeSet.id(e[t])){var a='TypeSet - input for label "'.concat(e[t],"\" ('").concat(TypeSet.id(e[t]),"') should be a string instead");console.error(a)}this.label=e[t]}else{var r="TypeSet - unexpected object key ".concat(t);console.error(r)}else _classPrivateMethodGet(this,_add_arr,_add_arr2).call(this,e[t],t)}function _push2(e,t){try{if(this[t].includes(e))return;if("any"===t)TypeSet.validate(e),this.any.push(e);else if("exact"===t)this.exact.push(e);else if("any"===e)this.other.push(e);else{var a="TypeSet - unexpected input for ".concat(t,'-type "').concat(e,'"');console.error(a)}}catch(a){console.error("failed to push ".concat(t,"-type to TypeSet at arg ").concat(e)),console.error(a)}}Object.defineProperty(window,"setup",{get:function(){return window.SugarCube.setup}}),Object.defineProperty(window,"sv",{get:function(){return window.SugarCube.State.variables}}),Object.defineProperty(window,"demo",{get:function(){return window.SugarCube.Macro.get("newmap").maps.demo}});var debug={on:{argObj:!1,proxy:!1},log:function(e,t){(e=Array.isArray(e)?e:[e]).filter((function(e){return debug.on[e]})).length&&console.log(t)}},config={map:{},tile:{},wall:{},floor:{},nav:{},player:{},building:{},object:{},npc:{},skipcheck:{},sizingmode:"auto"};config.map.width=20,config.map.height=15,config.map.unit="rem",config.nav.diagonal=!1,config.nav.width=15,config.nav.height=12,config.nav.unit="rem",config.nav.sizingoff=!1,config.wall.tileid=".",config.floor.tileid="x",config.map.zoom=2,config.map.panx=1,config.map.pany=1,config.player.wall=!0,config.building.wall=!0,config.object.wall=!1,config.npc.wall=!1,config.tile.width=2,config.tile.height=2,config.skipcheck.xybounds=!1,config.skipcheck.unused=!1,config.wall.tiletype="wall",config.floor.tiletype="floor",config.noclip=!1,config.collisionerror=!1,config.allowclobbering=!1,config.skipcheck.common=!1,config.disableglobal=!1,config.setupname="@navmap",config.globalname="Navmap",config.Statename="@navmap",null!==(_setup$_config$setupn=(_setup=setup)[_config$setupname=config.setupname])&&void 0!==_setup$_config$setupn||(_setup[_config$setupname]={}),null!==(_State$variables$_con=(_State$variables=State.variables)[_config$Statename=config.Statename])&&void 0!==_State$variables$_con||(_State$variables[_config$Statename]={}),null!==(_State$variables$conf2=(_State$variables$conf=State.variables[config.Statename]).local)&&void 0!==_State$variables$conf2||(_State$variables$conf.local={}),null!==(_State$variables$conf4=(_State$variables$conf3=State.variables[config.Statename]).global)&&void 0!==_State$variables$conf4||(_State$variables$conf3.global={});var def=new Proxy(config,get_controller(setup[config.setupname]));function get_controller(e){return{get:function(t,a){return debug.log("proxy","entered proxy"),void 0===e||void 0===e[a]?(debug.log("entered undefined"),t[a]):(debug.log("proxy","entered defined"),"object"!==_typeof(e[a])||e[a].isproxy||(debug.log("proxy","created proxy"),e[a]=new Proxy(config[a],get_controller(e[a])),e[a].isproxy=!0),e[a])}}}function convert_i2xy(e,t){var a=get_map(t),r=a.arr,i=a.cols;if(e<0||e>r.length)return{};var n=e%i+1;return{x:n,y:(e-n+1)/i+1}}function convert_xy2i(e,t){var a=get_map(t),r=a.rows,i=a.cols,n=e.x,o=e.y;return n<1||n>r||o<1||o>i?-1:(o-1)*i+n-1}function update_box(e){var t,a,r,i,n=e.mapid,o=e.displayid,c=e.delta,l=get_map(n),s=l.rows,d=l.cols,p=get_box(n,o),u=p.x0,h=p.y0,y=p.cols_view,m=p.rows_view,v=Math.clamp(1,d,y+(null!==(t=c.cols)&&void 0!==t?t:0)),f=Math.clamp(1,s,m+(null!==(a=c.rows)&&void 0!==a?a:0)),g=Math.clamp(1,d-v+1,u+Math.floor((y-v)/2)+(null!==(r=c.x)&&void 0!==r?r:0)),_=Math.clamp(1,s-f+1,h+Math.floor((m-f)/2)+(null!==(i=c.y)&&void 0!==i?i:0));l.boxes[o]={x0:g,y0:_,cols_view:v,rows_view:f}}function get_map(){for(var e,t=arguments.length,a=new Array(t),r=0;r<t;r++)a[r]=arguments[r];var i=null!==(e=a[0].mapid)&&void 0!==e?e:a[0];return navmaps[i]}function get_tile(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].tileid)&&void 0!==t?t:r[1],c=get_map(n);return c.tiles[o]}function get_entity(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=get_map(n);return c.entities[o]}function get_display(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].displayid)&&void 0!==t?t:r[1],c=get_map(n);return c.displays[o]}function get_box(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].displayid)&&void 0!==t?t:r[1],c=get_map(n);return c.boxes[o]}function get_overlap(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=get_map(n),l=(c.cols,c.actors),s=get_entity(n,o),d=s.x,p=s.y,u=convert_xy2i({x:d,y:p},n);return l[u].overlap.filter((function(e){return e!==o}))}function get_adjacent(){for(var e,t,a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];var n=null!==(e=r[0].mapid)&&void 0!==e?e:r[0],o=null!==(t=r[0].entityid)&&void 0!==t?t:r[1],c=get_map(n),l=(c.cols,c.actors),s=get_entity(n,o),d=s.x,p=s.y,u=convert_xy2i({x:d,y:p},n);return l[u].adjacent.filter((function(e){return e!==o}))}var navmaps={};setup.navmaps=navmaps;var Navmap=function(){function e(t,a,r){var i,n,o,c,l;if(_classCallCheck(this,e),!def.allowclobbering&&navmaps[t])throw new Error('Navmap with map id "'.concat(t,'" already exists'));navmaps[String(t)]=this,this.mapid=String(t),this.arr=a,this.cols=r,this.rows=this.arr.length/this.cols,this.actors=new Array(this.arr.length),this.displays={},this.displaycount=0,this.tiles={};var s,d=_createForOfIteratorHelper(new Set(this.arr));try{for(d.s();!(s=d.n()).done;){var p=s.value;this.tiles[String(p)]={mapid:this.mapid,tileid:String(p),tilename:p,tiletype:def.floor.tiletype,tilehtml:p}}}catch(e){d.e(e)}finally{d.f()}this.tiles[String(def.wall.tileid)]={mapid:this.mapid,tileid:String(def.wall.tileid),tilename:def.wall.tileid,tiletype:def.wall.tiletype,tilehtml:def.wall.tileid},this.tiles[String(def.floor.tileid)]={mapid:this.mapid,tileid:String(def.floor.tileid),tilename:def.floor.tileid,tiletype:def.floor.tiletype,tilehtml:def.floor.tileid},null!==(o=(i=State.variables[config.Statename])[n=this.mapid])&&void 0!==o||(i[n]={}),null!==(c=this.entities)&&void 0!==c||(this.entities={});var u=session.get(t);this.boxes=null!=u&&u.boxes?u.boxes:null!==(l=this.boxes)&&void 0!==l?l:{}}return _createClass(e,[{key:"entities",get:function(){return State.variables[config.Statename][this.mapid].entities},set:function(e){State.variables[config.Statename][this.mapid].entities=e}},{key:"boxes",get:function(){return State.variables[config.Statename][this.mapid].boxes},set:function(e){State.variables[config.Statename][this.mapid].boxes=e}}]),e}();function print_tile(e){var t=e.mapid,a=e.tile,r=e.row,n=e.col,o=a.tileid,c=a.tilename,l=a.tiletype,s=a.tilehtml;try{var d=$(document.createElement("div"));return d.addClass("Navmap-tile").addClass(l).attr("title",c).attr("data-tileid",o).attr("data-tilename",c).attr("data-tiletype",l).css({"grid-column":"".concat(n," / span 1"),"grid-row":"".concat(r," / span 1")}).wiki(s||o),d}catch(e){console.error("".concat(this.name,' - failed to create tile element at "').concat(i,'" on "').concat(t,'" for ').concat(this.name)),console.error(e)}}function print_entity(e){var t=e.mapid,a=e.entity,r=e.col,i=e.row,n=a.entityid,o=a.entityname,c=a.entityhtml;try{var l=$(document.createElement("div"));return l.addClass("Navmap-entity").attr("title",o).attr("data-entityid",n).wiki(c||n).css({"grid-column":"".concat(r," / span 1"),"grid-row":"".concat(i," / span 1")}),l}catch(e){console.error("".concat(this.name,' - failed to create entity element for "').concat(n,'" on "').concat(t,'"')),console.error(e)}}function print_dir(e){var t=e.mapid,a=e.entityid,r=e.dir,i=get_map(t),n=i.arr,o=i.rows,c=i.cols,l=i.actors,s=r.dirid,d=r.dirname,p=r.delta,u=get_entity(t,a);try{var h=$(document.createElement("div"));h.addClass("Navmap-dir").attr("data-dirid",s).attr("data-dirname",d).attr("data-mapid",t);var y=u.x+p.x,m=u.y+p.y,v=convert_xy2i({x:y,y:m},t);if(v>=0&&m>=1&&m<=o&&y>=1&&y<=c){var f=get_tile(t,n[v]),g=f.tileid,_=f.tilename,b=l[v].wall.length>0;h.attr("data-disabled",b).attr("data-tileid",g).wiki(b?"":_||g)}else h.attr("data-disabled",!0).attr("data-tileid",null);return h}catch(e){console.error("".concat(this.name,' - failed to create nav direction "').concat(d,'" for map "').concat(t,'"')),console.error(e)}}config.disableglobal||Object.defineProperty(window,config.globalname,{value:Navmap});var cssunit={exact:["cm","mm","Q","in","pc","pt","px","em","ex","ch","rem","lh","rlh","vw","vh","vmin","vmax","vb","vi","svw","svh","lvh","dvw","dvh","%"],label:"any valid 'CSS unit'"},dirs_4={C:{dirid:"C",dirname:"center",delta:{x:0,y:0}},N:{dirid:"N",dirname:"north",delta:{x:0,y:-1}},E:{dirid:"E",dirname:"east",delta:{x:1,y:0}},S:{dirid:"S",dirname:"south",delta:{x:0,y:1}},W:{dirid:"W",dirname:"west",delta:{x:-1,y:0}}},dirs_8=_objectSpread(_objectSpread({},dirs_4),{},{NW:{dirid:"NW",dirname:"northwest",delta:{x:-1,y:-1}},NE:{dirid:"NE",dirname:"northeast",delta:{x:1,y:-1}},SE:{dirid:"SE",dirname:"southeast",delta:{x:1,y:1}},SW:{dirid:"SW",dirname:"southwest",delta:{x:-1,y:1}}});function check_required(e){if(void 0===e){var t="".concat(this.name," - failed, missing input (check_required)");return this.error(t)}var a=e.id,r=e.args_tocheck;if(void 0===a){t="".concat(this.name," - failed, missing required id (check_required)");return this.error(t)}if(void 0===r){var i="".concat(a," - failed, missing required args_tocheck (check_required)");return this.error(i)}try{for(var n in r)if(console.log(r),void 0===r[n]){var o,c="".concat(a,' - missing required argument "').concat(null!==(o=r[n].label)&&void 0!==o?o:n,'"');return this.error(c)}}catch(t){console.error("".concat(a," - failed to check for required arguments (check_required)")),console.error(t)}}function check_common(e){if(void 0===e){var t="".concat(this.name," - failed, missing input (check_common)");return this.error(t)}var a=e.id,r=e.args_tocheck;if(void 0===a){t="".concat(this.name," - failed, missing required id (check_common)");return this.error(t)}if(void 0===r){var i="".concat(a," - failed, missing required args_tocheck (check_common)");return this.error(i)}try{for(var n in r){var o=r[n].val;if("array"===TypeSet.id(o)){var c,l=_createForOfIteratorHelper(o);try{for(l.s();!(c=l.n()).done;){var s=c.value;errors_common.call(this,{id:a,args_tocheck:r,key:n,val:s})}}catch(e){l.e(e)}finally{l.f()}}else errors_common.call(this,{id:a,args_tocheck:r,key:n,val:o})}}catch(t){console.error("".concat(a," - failed to check for common errors (check_common)")),console.error(t)}}function errors_common(e){var t=e.id,a=e.args_tocheck,r=e.key,i=e.val;try{if(a[r].oneword&&i.includes(" ")){var n,o="".concat(t,' - argument "').concat(null!==(n=a[r].label)&&void 0!==n?n:r,'" must be one word, no spaces');return this.error(o)}if(a[r].extant){if("mapid"===r&&void 0===get_map(i)){var c="".concat(t,' - no map with id "').concat(i,'" found');return this.error(c)}if(void 0===a.mapid){var l="".concat(t," - failed, missing required mapid (check_common)");return this.error(l)}var s=a.mapid.val;if("tileid"===r&&void 0===get_tile(s,i)){var d="".concat(t,' - no tile with id "').concat(i,'" found in map "').concat(s,'" ');return this.error(d)}if("entityid"===r&&void 0===get_entity(s,i)){var p="".concat(t,' - no entity with id "').concat(i,'" found on map "').concat(s,'"');return this.error(p)}}if(a[r].integer&&!Number.isInteger(i)){var u,h="".concat(t,' - argument "').concat(null!==(u=a[r].label)&&void 0!==u?u:r,'" must be an integer');return this.error(h)}if(a[r].positive&&i<=0){var y,m="".concat(t,' - argument "').concat(null!==(y=a[r].label)&&void 0!==y?y:r,'" must be greater than zero');return this.error(m)}}catch(o){console.error("".concat(t,' - failed to check for common errors, specifically on key "').concat(r,'" and value "').concat(i,'" (errors_common)')),console.error(o)}}function check_xy(e){if(void 0===e){var t="".concat(this.name," - failed, missing input (check_xy)");return this.error(t)}var a=e.id,r=e.mapid,i=e.entityid,n=e.x,o=e.y;if(void 0===a){t="".concat(this.name," - failed, missing required id (check_xy)");return this.error(t)}if(void 0===r){var c="".concat(a," - failed, missing required mapid (check_xy)");return this.error(c)}if(void 0===i){var l="".concat(a," - failed, missing required entityid (check_xy)");return this.error(l)}if(void 0===n){var s="".concat(a," - failed, missing required x (check_xy)");return this.error(s)}if(void 0===o){var d="".concat(a," - failed, missing required y (check_xy)");return this.error(d)}var p=get_map(r),u=p.rows,h=p.cols;try{if(n.val<1){var y;t="".concat(a," - ").concat(null!==(y=n.label)&&void 0!==y?y:"x",' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(t)}if(n.val>h){var m,v="".concat(a," - ").concat(null!==(m=n.label)&&void 0!==m?m:"x",' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(v)}if(o.val<1){var f,g="".concat(a," - ").concat(null!==(f=o.label)&&void 0!==f?f:"y",' for "').concat(i,'" will exceed lower map boundary on "').concat(r,'"');return this.error(g)}if(o.val>u){var _,b="".concat(a," - ").concat(null!==(_=o.label)&&void 0!==_?_:"y",' for "').concat(i,'" will exceed upper map boundary on "').concat(r,'"');return this.error(b)}}catch(t){var w,k;console.error("".concat(a,' - failed to check xy bounds on { "').concat(null!==(w=n.label)&&void 0!==w?w:"x",'" : "').concat(n.val,'", "').concat(null!==(k=o.label)&&void 0!==k?k:"y",'" : "').concat(o.val,'" } for "').concat(r,'" (check_xy)')),console.error(t)}}function create_payObj(e){var t=this;if(void 0===e){var a="".concat(this.name," - failed, missing input (create_payObj)");return this.error(a)}var r=e.id,i=e.pays_toparse,n=e.pays_tofill;if(void 0===r){a="".concat(this.name," - failed, missing required id (create_payObj)");return this.error(a)}if(void 0===i){var o="".concat(r," - failed, missing required pays_toparse (create_payObj)");return this.error(o)}if(void 0===n){var c="".concat(r," - failed, missing required pays_tofill (create_payObj)");return this.error(c)}var l=Object.keys(n);if(!l.length){var s="".concat(r," - failed, pays_tofill can't be empty (create_payObj)");return this.error(s)}var d={};try{for(var p=function(){var e=h[u],a=i.filter((function(t){return t.name===n[e].tagname}));if(!def.skipcheck.unused){var o,c,l,s;if(n[e].unique&&a.length>1){var p="".concat(r," - multiple of the same child tag received");return{v:t.error(p)}}if(n[e].noargs&&(null===(o=a[0])||void 0===o||null===(c=o.args)||void 0===c?void 0:c.length)>0){var y="".concat(r," - this child tag doesn't take arguments");return{v:t.error(y)}}if(a[0]&&(null===(l=a[0])||void 0===l||null===(s=l.contents)||void 0===s||!s.trim())){var m="".concat(r," - a payload is required to use this child tag");return{v:t.error(m)}}}d[e]=a[0]?a[0].contents.trim():null},u=0,h=l;u<h.length;u++){var y=p();if("object"===_typeof(y))return y.v}return d}catch(a){console.error("".concat(r," - failed to parse payloads (create_payObj)")),console.error(a)}}function create_argObj(e){if(void 0===e){var t="".concat(this.name," - failed, missing input (create_argObj)");return this.error(t)}var a=e.id,r=e.args_tofill,i=e.options,n=clone(e.args_toparse);if(void 0===a){t="".concat(this.name," - failed, missing required id (create_argObj)");return this.error(t)}if(void 0===r){var o="".concat(a," - failed, missing required args_tofill (create_argObj)");return this.error(o)}if(void 0===n){var c="".concat(a," - failed, missing required args_toparse (create_argObj)");return this.error(c)}var l=Object.keys(r);if(!l.length){var s="".concat(a," - failed, args_tofill can't be empty (create_argObj)");return this.error(s)}var d={};try{for(var p=0,u=l;p<u.length;p++){var h=u[p];if(d[h]=h,void 0!==r[h].alias)if("array"===TypeSet.id(r[h].alias)){var y,m=_createForOfIteratorHelper(r[h].alias);try{for(m.s();!(y=m.n()).done;){d[y.value]=h}}catch(e){m.e(e)}finally{m.f()}}else d[r[h].alias]=h}}catch(t){console.error("".concat(a," - failed to create aliases while parsing macro arguments (create_argObj)")),console.error(t)}var v={},f={id:a,args_toparse:n,args_tofill:r,keys:l,output:v,alias:d,options:i,splice:0};try{for(;f.args_toparse.length>0;){debug.log("argObj","entered loop"),debug.log("argObj",f),f.splice=0;var g=f.args_toparse[0];try{0===f.splice&&l.includes(d[g])&&argObj_kvp.call(this,f),0===f.splice&&g.isLink&&argObj_markup.call(this,f),0===f.splice&&"object"===TypeSet.id(g)&&argObj_obj.call(this,f);var _=_objectSpread({strict:!1},i).strict;if(0!==f.splice||_||argObj_lazy.call(this,f),!(f.splice>0)){var b="".concat(a,' - unexpected input "').concat(g,'", is not a key name and did not match any valid types');return console.error(v),this.error(b)}f.args_toparse.splice(0,f.splice)}catch(t){console.error("".concat(a,' - failed to create argObj at "').concat(g,'" for "').concat(a,'" (create_payObj)')),console.error(t)}}return v}catch(t){console.error("".concat(a," - failed to create argObj from macro arguments (create_payObj)")),console.error(t)}}function argObj_markup(e){debug.log("argObj","entered markup"),debug.log("argObj",e);var t=e.id,a=e.args_toparse,r=e.keys,i=e.output,n=a[0];try{if(!r.includes("passage")){var o="".concat(t," - macro does not accept [[markup]]");return this.error(o)}return i.linktext=n.text,i.passage=n.link,e.splice=1,e}catch(o){console.error("".concat(t," - failed to parse macro arguments inside [[markup]] parser (argObj_markup)")),console.error(o)}}function argObj_kvp(e){debug.log("argObj","entered kvp"),debug.log("argObj",e);var t=e.id,a=e.args_toparse,r=e.args_tofill,i=e.output,n=e.alias,o=a[0],c=a[1];try{if("undefined"===TypeSet.id(c)){var l="".concat(t,' - no input was found for argument "').concat(o,'"');return this.error(l)}var s=new TypeSet(r[n[o]].type);if(!s.accepts(c)){var d="".concat(t,' - "').concat(c,"\" is an invalid type ('").concat(TypeSet.id(c),"') for \"").concat(o,'", expected ').concat(s.print);return this.error(d)}return i[n[o]]=c,e.splice=2,e}catch(l){console.error("".concat(t," - failed to parse macro arguments inside KVP parser (argObj_kvp)")),console.error(l)}}function argObj_obj(e){debug.log("argObj","entered object parser"),debug.log("argObj",e);var t=e.id,a=e.args_toparse,r=e.args_tofill,i=e.keys,n=e.output,o=e.alias,c=a[0];try{for(var l in c)if(i.includes(o[l])){var s=new TypeSet(r[o[l]].type);if(!s.accepts(c[l])){var d="".concat(t,' - "').concat(c[l],'" is an invalid type for "').concat(l,"\" ('").concat(TypeSet.id(c[l]),"'), expected ").concat(s.print);return this.error(d)}n[o[l]]=c[l],e.splice=1}return e}catch(d){console.error("".concat(t," - failed to parse macro arguments inside object parser (argObj_obj)")),console.error(d)}}function argObj_lazy(e){debug.log("argObj","entered lazy matcher"),debug.log("argObj",e);var t=e.id,a=e.args_toparse,r=e.args_tofill,i=e.keys,n=e.output,o=a[0];try{var c=i.filter((function(e){return!Object.keys(n).includes(e)}));if(!c.length)return e;var l,s=_createForOfIteratorHelper(c);try{for(s.s();!(l=s.n()).done;){var d=l.value;if(new TypeSet(r[d].type).accepts(o)){n[d]=o,e.splice=1;break}}}catch(e){s.e(e)}finally{s.f()}return e}catch(e){console.error("".concat(t," - failed to parse macro arguments inside lazy parser (argObj_lazy)")),console.error(e)}}function new_navmap(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_navmap"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=_objectSpread({diagonal:def.nav.diagonal},e),n=i.source,o=i.mapid,c=i.mapname,l=i.diagonal,s=i.inputtype,d=i.inputmap;if(check_required.call(this,{id:this.name,args_tocheck:{mapid:o,inputtype:s}}),!d)return this.error("".concat(this.name,"macro"===n?" - missing required macro payload":' - missing required input "inputmap"'));try{if("array"===s){if(e.arr=d,!e.cols){var p="".concat(this.name,' - missing required input "cols" or "columns" for map "').concat(o,'"');return this.error(p)}}else{if("2D array"!==s){var u="".concat(this.name,' - invalid inputtype for map "').concat(o,"\", only macro payload or 'array' or '2D array' is supported");return this.error(u)}var h,y=d[0].length,m=_createForOfIteratorHelper(d);try{for(m.s();!(h=m.n()).done;){var v=h.value;if(!Array.isarray(v)){var f="".concat(this.name,' - invalid inputmap, non-array detected for map "').concat(o,'"');return console.error(v),this.error(f)}if((null==v?void 0:v.length)!==y||0===(null==v?void 0:v.length)){var g="".concat(this.name,' - invalid inputmap, non-rectangular input detected for map "').concat(o,'"');return console.error(v),this.error(g)}}}catch(e){m.e(e)}finally{m.f()}e.cols=y,e.arr=d.flat()}}catch(p){console.error("".concat(this.name,' - failed to parse input for inputtype "').concat(s,'" and inputmap (new_map)')),console.error(d),console.error(p)}var _=e.arr,b=e.cols;def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:o,oneword:!0},cols:{val:b,integer:!0,positive:!0}}});try{if("array"===s&&_.length%b){p="".concat(this.name," - inputmap is not rectangular");return this.error(p)}var w=new Navmap(o,_,b);w.mapname=c,w.diagonal=l}catch(p){console.error("".concat(this.name,' - failed to create Navmap object for map "').concat(o,'" (new_map)')),console.error(p)}calculate_actors.call(this,{mapid:o,diagonal:l})}function new_tile(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_tile"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.tileid,o=e.tilename,c=e.tiletype,l=e.tilehtml;check_required.call(this,{id:this.name,args_tocheck:{mapid:i,tileid:n}}),def.skipcheck.common||(check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},tileid:{val:n,oneword:!0}}}),o&&check_common.call(this,{id:"tilename",args_tocheck:{name:{val:o,oneword:!0}}}),c&&check_common.call(this,{id:"tiletype",args_tocheck:{type:{val:c,oneword:!0}}}));try{var s=get_tile(i,n);if(void 0===s){var d="".concat(this.name,' - no tile with id "').concat(n,'" found in map "').concat(i,'"');return this.error(d)}o&&(s.tilename=o),c&&(s.tiletype=c),l&&(s.tilehtml=l)}catch(d){console.error("".concat(this.name,' - failed to create new tile definition for "').concat(n,'" on map "').concat(i,'" (new_tile)')),console.error(d)}}function new_display(e){var t,a,r,i,n,o;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_display"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var c=e.mapid,l=null!==(i=e.displayid)&&void 0!==i?i:c;if(check_required.call(this,{id:this.name,args_tocheck:{mapid:c}}),!def.skipcheck.allowclobbering&&get_display(c,l)){var s="".concat(this.name,' - display with id "').concat(l,'" already exists for map "').concat(c,'"');return this.error(s)}def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:c,oneword:!0,extant:!0},displayid:{val:l,oneword:!0}}});var d=get_map(c),p=(d.mapname,d.cols),u=d.rows,h=(d.diagonal,e.entityid_view),y=null!==(n=e.rows_view)&&void 0!==n?n:e.cols_view,m=null!==(o=e.cols_view)&&void 0!==o?o:e.rows_view;if(!def.skipcheck.common){if(y||m){if(check_common.call(this,{id:this.name,args_tocheck:{cols_view:{val:m,label:"view columns",positive:!0,integer:!0},rows_view:{val:y,label:"view rows",positive:!0,integer:!0}}}),m>p){s="".concat(this.name," - view columns can't be greater than total # of columns on map \"").concat(c,'"');return this.error(s)}if(y>u){var v="".concat(this.name," - view rows can't be greater than total # of rows on map \"").concat(c,'"');return this.error(v)}}h&&check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:c},entityid:{val:h,label:"id of entity to track",extant:!0,oneword:!0}}})}d.displays[l]={mapid:c,displayid:l,rows_view:y,cols_view:m,entityid_view:h};var f=get_entity(c,h);try{var g,_=null===(g=session.get(c))||void 0===g?void 0:g.boxes;if(void 0!==_&&void 0!==_[l])d.boxes[l]=_[l];else if(void 0===d.boxes[l]){var b=void 0===f?1:Math.clamp(1,p-m+1,f.x-Math.floor(m/2)),w=void 0===f?1:Math.clamp(1,u-y+1,f.y-Math.floor(y/2));d.boxes[l]={x0:b,y0:w,cols_view:m,rows_view:y}}}catch(s){console.error("".concat(this.name," - failed to create or retrieve display box data (new_display)")),console.error(s)}var k=$(document.createElement("div"));try{var x=get_box(c,l),S=get_display(c,l),j=x.x0,O=x.y0,T=x.cols_view,q=x.rows_view,P=S.entityid_view;k.addClass("Navmap-display").attr("data-mapid",c).attr("data-displayid",l).attr("data-root-x0",j).attr("data-root-y0",O).attr("data-root-cols_view",T).attr("data-root-rows_view",q).attr("data-entity",null!=P?P:void 0)}catch(s){console.error("".concat(this.name," - failed to intialize $display jQuery object")),console.error(s)}update_display.call(this,{mapid:c,displayid:l,$display:k}),k.appendTo(this.output);try{setTimeout((function(){k.on(":update_display",(function(e,t){$(this).children().remove(),update_display.call(this,{mapid:c,displayid:l,$display:k,delta:t})}))}),40)}catch(s){console.error("".concat(this.name," - failed to assign $display listeners")),console.error(s)}}function update_display(e){var t,a,r,i;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"update_display"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var n=e.mapid,o=e.$display,c=e.delta,l=null!==(i=e.displayid)&&void 0!==i?i:n;check_required.call(this,{id:this.name,args_tocheck:{mapid:n,displayid:l}});var s=get_map(n),d=get_display(n,l),p=s.arr,u=s.entities,h=(s.rows,s.cols);d.entityid_view;void 0!==c&&update_box({mapid:n,displayid:l,delta:c});var y=get_box(n,l),m=y.x0,v=y.y0,f=y.rows_view,g=y.cols_view;o.css({"grid-template-columns":"repeat(".concat(g,", 1fr)"),"grid-template-rows":"repeat(".concat(f,", 1fr)")});var _=[];try{for(var b=convert_xy2i({x:m,y:v},n),w=1;w<=f;w++)for(var k=1;k<=g;k++){var x=b+(k-1)+h*(w-1),S=p[x],j=print_tile.call(this,{mapid:n,tile:get_tile(n,S),col:k,row:w});j.appendTo(o);var O=convert_i2xy(x,n),$=O.x,T=O.y;j.attr("data-x",$).attr("data-y",T),_.push(x)}}catch(e){console.error("".concat(this.name,' - failed to print tiles for map display "').concat(l,'" (refresh_display)')),console.error(e)}try{for(var q in u){var P=u[q],A=P.x,M=P.y,C=convert_xy2i({x:A,y:M},n);if(_.includes(C))print_entity.call(this,{mapid:n,entity:P,col:A-m+1,row:M-v+1}).appendTo(o)}o.attr("data-x0",m).attr("data-y0",v).attr("data-cols_view",g).attr("data-rows_view",f)}catch(e){console.error("".concat(this.name,' - failed to print entities for map display "').concat(l,'" (refresh_display)')),console.error(e)}}function new_rose(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"shownav"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid;e.rosehtml;check_required.call(this,{id:this.name,args_tocheck:{mapid:i,entityid:n}});var o=get_map(i).diagonal;def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0}}});var c=$(document.createElement("div")),l=o?dirs_8:dirs_4;try{for(var s in c.addClass("Navmap-rose").attr("data-mapid",i).attr("data-entityid",n),l){print_dir.call(this,{mapid:i,entityid:n,dir:l[s]}).appendTo(c)}}catch(e){console.error("".concat(this.name,' - failed to create nav rose for map "').concat(i,'" (new_rose)')),console.error(e)}c.appendTo(this.output);try{setTimeout((function(){c.on("click",(function(e){var t=$(e.target).attr("data-dirid");if(!(void 0===t||("C"===t||"true"===$(e.target).attr("data-disabled")))){$(this).trigger(":update_rose",l[t].delta);var a=$(this).attr("data-mapid");$('.Navmap-display[data-mapid="'.concat(a,'"]')).trigger(":update_display",l[t].delta)}})),c.on(":update_rose",(function(e,t){var a=$(this).attr("data-mapid");for(var r in t&&mov_entity.call(null!=this?this:{},{mapid:a,entityid:n,delta:t}),c.html(""),l){print_dir.call(this,{mapid:a,entityid:n,dir:l[r]}).appendTo(c)}}))}),40)}catch(e){console.error("".concat(this.name," -  failed to add click functionality to navrose for ").concat(i)),console.error(e)}}function new_entity(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"new_entity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.x,o=e.y,c=e.wall,l=e.entityid,s=e.entityname,d=e.entityhtml;check_required.call(this,{id:this.name,args_tocheck:{mapid:i,x:n,y:o}}),def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},entityid:{val:l,oneword:!0},x:{val:n,integer:!0},y:{val:o,integer:!0}}}),def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:l,x:{val:n,label:"entity x position"},y:{val:o,label:"entity y position"}});var p=get_map(i);try{if(!def.allowclobbering&&get_entity(i,l)){var u="".concat(this.name,' - entity with id "').concat(l,'" already exists in map "').concat(i,'"');return this.error(u)}p.entities[String(l)]={mapid:i,entityid:String(l),entityname:s,entityhtml:d,x:n,y:o,wall:c}}catch(u){console.error("".concat(this.name,' - failed to add entity "').concat(l,'" to "').concat(i,'"')),console.error(u)}}function del_entity(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"del_entity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid;check_required.call(this,{id:this.name,args_tocheck:{mapid:i,entityid:n}}),def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0}}});var o=get_map(i),c=o.diagonal,l=o.entities;try{delete l[n];var s=$('.Navmap-entity[data-entityid="'.concat(n,'"]'));s&&(s.remove(),calculate_actors.call(this,{mapid:i,diagonal:c}),$('.Navmap-display[data-mapid="'.concat(i,'"]')).trigger(":update_display"))}catch(e){console.error("".concat(this.name,' - failed to delete entity "').concat(n,'" from "').concat(i,'"')),console.error(e)}}function mov_entity(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid,o=e.delta,c=e.ignorewalls;check_required.call(this,{id:this.name,args_tocheck:{mapid:i,entityid:n}});var l=get_map(i),s=(l.cols,l.actors),d=l.diagonal,p=get_entity(i,n),u=p.x,h=p.y;def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0},deltax:{val:o.x,label:"delta x",integer:!0},deltay:{val:o.y,label:"delta y",integer:!0}}}),def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:n,x:{val:u+o.x,label:"new x position after delta x"},y:{val:h+o.y,label:"new y position after delta y"}});try{var y,m,v=convert_xy2i({x:u+o.x,y:h+o.y},i);if(!c&&!def.noclip&&s[v].wall.length>0){if(def.collisionerror){var f="".concat(this.name,' - collision detected for entity "').concat(n,'" on "').concat(i,'"');return this.error(f)}return}p.x+=null!==(y=o.x)&&void 0!==y?y:0,p.y+=null!==(m=o.y)&&void 0!==m?m:0,calculate_actors.call(this,{mapid:i,diagonal:d}),$('.Navmap-display[data-mapid="'.concat(i,'"]')).trigger(":update_display"),$('.Navmap-rose[data-mapid="'.concat(i,'"]')).trigger(":update_rose")}catch(f){console.error("".concat(this.name,' - failed to move entity "').concat(n,'" on "').concat(i,'"')),console.error(f)}}function calculate_actors(e){var t,a,r;"string"==typeof e&&(e={mapid:e}),null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"mapcalculate"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e,n=i.mapid,o=i.diagonal;check_required.call(this,{id:this.name,args_tocheck:{mapid:n}});var c=get_map(n),l=c.arr,s=c.actors,d=c.entities;try{for(var p=0;p<l.length;p++){var u=get_tile(n,l[p]);s[p]={},s[p].tileid=u.tileid,s[p].wall=[],s[p].overlap=[],s[p].adjacent=[],u.tiletype===def.wall.tiletype&&s[p].wall.push({tile:u.tileid})}}catch(e){console.error("".concat(this.name,' - failed to assign walltypes while calculating actors for map "').concat(n,'" (calculate_actors)')),console.error(e)}try{for(var h in d){var y=d[h],m=y.wall,v=y.x,f=y.y,g=y.entityid,_=convert_xy2i({x:v,y:f},n);m&&s[_].wall.push({entity:g}),s[_].overlap.push({entity:g});var b=Object.assign({},o?dirs_8:dirs_4);for(var w in delete b.C,b){var k=convert_xy2i({x:v+b[w].delta.x,y:f+b[w].delta.y},n);k>=0&&k<l.length-1&&s[k].adjacent.push({entity:g})}}}catch(e){console.error("".concat(this.name,' - failed to check entities while calculating actors map "').concat(n,'" (calculate_actors)')),console.error(e)}}Macro.add(["newnavmap","new_navmap"],{tags:[null],maps:{},handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},mapname:{type:"string",alias:"name"},cols:{type:"number",alias:"columns"},diagonal:{type:"boolean"}}});e.inputtype="array",e.inputmap=this.payload[0].contents.trim().split(/[\s\n]+/g),e.source="macro",new_navmap.call(this,e)}}),Macro.add(["newtile","new_tile"],{tags:null,handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},tileid:{type:"string",alias:"tile"},tilename:{type:"string",alias:"name"},tiletype:{type:"string",alias:"type"}}});e.tilehtml=this.payload[0].contents.trim(),e.source="macro",new_tile.call(this,e)}}),$(window).on("beforeunload",(function(e){for(var t in navmaps){var a=navmaps[t].boxes;session.set(t,{boxes:a})}})),Macro.add(["new_display","newdisplay"],{handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},displayid:{type:"string",alias:"display"},rows_view:{type:"number",alias:"viewrows"},cols_view:{type:"number",alias:"viewcolumns"},entityid_view:{type:"string",alias:["viewentity","entityid"]}}});e.source="macro",new_display.call(this,e)}}),Macro.add(["newrose","new_rose"],{tags:null,handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"}}});e.rosehtml=this.payload[0].contents.trim(),e.source="macro",new_rose.call(this,e)}}),Macro.add(["newentity","new_entity"],{tags:null,handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},entityname:{type:"string",alias:"name"},wall:{type:"boolean"},x:{type:"number"},y:{type:"number"}}});e.entityhtml=this.payload[0].contents.trim(),e.source="macro",new_entity.call(this,e)}}),Macro.add(["delentity"],{handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"}}});del_entity.call(this,e)}}),Macro.add(["moventity","mov_entity"],{handler:function(){var e,t,a,r=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},deltax:{type:"number",alias:"x"},deltay:{type:"number",alias:"y"},ignorewalls:{type:"boolean"},delta:{type:"object"}}});null!==(e=r.delta)&&void 0!==e||(r.delta={x:null!==(t=r.deltax)&&void 0!==t?t:0,y:null!==(a=r.deltay)&&void 0!==a?a:0}),mov_entity.call(this,r)}}),Macro.add("setentity",{handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},entityid:{type:"string",alias:"entity"},x:{type:"number"},y:{type:"number"}}});this.self.handlerJS.call(this,e)},handlerJS:function(e){var t,a,r;null!==(t=this.name)&&void 0!==t||(this.name=null!==(a=e.id)&&void 0!==a?a:"moventity"),null!==(r=this.error)&&void 0!==r||(this.error=function(e){throw new Error(e)});var i=e.mapid,n=e.entityid,o=e.x,c=e.y;def.skipcheck.common||check_common.call(this,{id:this.name,args_tocheck:{mapid:{val:i,oneword:!0,extant:!0},entityid:{val:n,oneword:!0,extant:!0},x:{val:o,integer:!0},y:{val:c,integer:!0}}});var l=get_map(i),s=l.mapsn,d=(l.actors,l.cols,l.diagonal);try{var p=get_entity(i,n);def.skipcheck.xybounds||check_xy.call(this,{id:this.name,mapid:i,entityid:n,x:{val:o,label:"new x position"},y:{val:c,label:"new y position"}}),p.x=o,p.y=c,calculate_actors.call(this,{mapid:i,diagonal:d}),$('[data-sn="'.concat(s,'"]')).trigger(":update_map")}catch(e){console.error("".concat(this.name,' - failed to set positition for entity "').concat(n,'" on map "').concat(i,'"')),console.error(e)}}}),Macro.add("mapcalculate",{handler:function(){var e=create_argObj.call(this,{id:this.name,args_toparse:this.args,args_tofill:{mapid:{type:"string",alias:"map"},diagonal:{type:"boolean"}}});calculate_actors.call(this,e)}});